<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Schedule Management - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="../buyer/style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<style>
    /* Same design tokens as broker dashboard - navy + gold */
    :root {
      --primary-gradient: linear-gradient(135deg, #0b2e52 0%, #1e3a5f 100%);
      --primary-light: #1e3a5f;
      --primary-dark: #071e38;
      --secondary-gradient: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      --accent-gradient: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      --card-hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
      --border-radius: 16px;
      --border-radius-sm: 12px;
      --border-radius-lg: 24px;
      --text-dark: #1a202c;
      --text-light: #718096;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border: #e2e8f0;
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #0ea5e9;
    }

    /* Hero Section - same as broker dashboard */
    .hero-section {
      background: var(--primary-gradient);
      color: white;
      border-radius: var(--border-radius-lg);
      padding: 50px 40px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" fill="white"/></svg>');
      background-size: cover;
      opacity: 0.1;
    }
    .hero-section h1 {
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 15px;
      line-height: 1.2;
      max-width: 800px;
      position: relative;
      z-index: 1;
    }
    .hero-section p {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    .hero-stats {
      display: flex;
      gap: 30px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .hero-stat-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .hero-stat-icon {
      font-size: 1.5rem;
      background: rgba(255,255,255,0.2);
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hero-stat-value { font-size: 1.5rem; font-weight: 700; }
    .hero-stat-label { font-size: 0.9rem; opacity: 0.8; }
    .hero-actions {
      margin-top: 25px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .view-toggle {
      display: flex;
      background: rgba(255,255,255,0.2);
      border-radius: var(--border-radius-sm);
      padding: 4px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .view-btn {
      padding: 10px 18px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.9);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .view-btn:hover { background: rgba(255,255,255,0.15); }
    .view-btn.active {
      background: rgba(255,255,255,0.25);
      color: white;
    }
    .refresh-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.4);
      padding: 14px 24px;
      border-radius: var(--border-radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .refresh-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .refresh-btn.refreshing {
      background: rgba(255,255,255,0.15);
      cursor: not-allowed;
      transform: none;
    }

    /* Section title - same as broker dashboard */
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-title i { color: #d4af37; font-size: 1.3rem; }

    /* Calendar Container - same card style as dashboard */
    .calendar-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      padding: 25px;
      margin-bottom: 30px;
      min-height: 600px;
    }
    #calendar { font-family: 'Inter', sans-serif; }

    /* Custom FullCalendar Styles - dashboard colors */
    .fc .fc-toolbar-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
    }
    .fc .fc-button {
      background: var(--primary-gradient) !important;
      border: none !important;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .fc .fc-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(11, 46, 82, 0.35);
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active {
      background: var(--primary-dark) !important;
      opacity: 0.95;
    }

    .fc .fc-daygrid-day.fc-day-today {
      background-color: rgba(11, 46, 82, 0.05);
    }

    .fc .fc-daygrid-day-number {
      font-weight: 600;
      color: var(--text-dark);
    }

    .fc-event {
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .fc-event:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .event-pending {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border-left: 4px solid var(--warning);
    }

    .event-confirmed {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border-left: 4px solid var(--success);
    }

    .event-declined {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border-left: 4px solid var(--error);
    }

    .event-alternative {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      color: #1e40af;
      border-left: 4px solid var(--info);
    }

    /* Schedules List - same card style as dashboard */
    .schedules-list-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      padding: 25px;
    }
    .schedules-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .schedules-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .schedules-header h3 i { color: #d4af37; font-size: 1.3rem; }
    .filter-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-btn {
      padding: 10px 18px;
      border: 2px solid #e5e7eb;
      background: white;
      color: var(--text-dark);
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .filter-btn:hover {
      border-color: var(--primary-light);
      background: #f9fafb;
    }
    .filter-btn.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    .schedules-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .schedule-item {
      background: #f9fafb;
      border-radius: var(--border-radius-sm);
      padding: 20px;
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .schedule-item:hover {
      background: white;
      transform: translateY(-2px);
      box-shadow: var(--card-shadow);
    }

    .schedule-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .schedule-date-time {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .schedule-date {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .schedule-date i {
      color: #d4af37;
    }

    .schedule-time {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .schedule-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-pending {
      background: var(--accent-gradient);
      color: white;
    }
    .status-confirmed {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .status-declined {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .status-alternative {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
    }

    .schedule-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detail-label {
      font-size: 12px;
      color: var(--text-light);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .schedule-notes {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--border-radius-sm);
      border-left: 4px solid #d4af37;
    }

    .schedule-notes-label {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 5px;
      font-weight: 500;
    }

    .schedule-notes-content {
      font-size: 13px;
      color: var(--text-dark);
      line-height: 1.4;
    }

    .schedule-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-btn.primary {
      background: var(--primary-gradient);
      color: white;
      border: none;
    }
    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(11, 46, 82, 0.35);
    }
    .action-btn.secondary {
      background: white;
      color: var(--text-dark);
      border: 2px solid #e5e7eb;
    }
    .action-btn.secondary:hover {
      border-color: var(--primary-light);
      background: #f9fafb;
      transform: translateY(-2px);
    }
    .action-btn.warning {
      background: var(--accent-gradient);
      color: white;
      border: none;
    }
    .action-btn.warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
    }

    .spinner {
      border: 4px solid rgba(11, 46, 82, 0.2);
      border-top: 4px solid #d4af37;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Schedule Detail Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: 20px;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--card-hover-shadow);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 25px;
    }

    .modal-header h3 {
      font-size: 20px;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text-light);
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .modal-close:hover {
      color: var(--error);
    }

    .modal-body {
      margin-bottom: 25px;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-section h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      flex-wrap: wrap;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .modal-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-btn.cancel {
      background: var(--bg-light);
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .modal-btn.cancel:hover {
      background: var(--border);
    }

    .modal-btn.confirm {
      background: var(--secondary-gradient);
      color: white;
    }
    .modal-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    .modal-btn.decline {
      background: var(--error);
      color: white;
    }

    .modal-btn.decline:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    .modal-btn.alternative {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
    }
    .modal-btn.alternative:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--secondary-gradient);
      color: white;
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      font-weight: 500;
      box-shadow: var(--card-hover-shadow);
      z-index: 9999;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .toast.error {
      background: var(--error);
    }

    .toast.warning {
      background: var(--warning);
    }

    .toast.info {
      background: var(--info);
    }

    /* Responsive - same as broker dashboard */
    @media (max-width: 1024px) {
      .container { margin-left: 0; padding: 25px; }
      .mobile-menu-toggle { display: flex; align-items: center; justify-content: center; }
      .hero-stats { gap: 20px; }
      .view-toggle { align-self: flex-start; }
    }
    @media (max-width: 768px) {
      .container { padding: 20px; }
      .hero-section h1 { font-size: 1.8rem; }
      .hero-section { padding: 30px 24px; }
      .calendar-container { padding: 15px; }
      .schedules-list-container { padding: 15px; }
      .schedule-date-time { flex-direction: column; align-items: flex-start; gap: 8px; }
      .schedule-item-header { flex-direction: column; align-items: flex-start; }
      .modal { padding: 20px; }
      .modal-grid { grid-template-columns: 1fr; }
      .modal-actions { flex-direction: column; }
      .modal-btn { width: 100%; justify-content: center; }
    }
    @media (max-width: 480px) {
      .container { padding: 15px; }
      .view-toggle { width: 100%; }
      .view-btn { flex: 1; justify-content: center; }
      .schedules-header { flex-direction: column; align-items: flex-start; }
      .filter-buttons { width: 100%; }
      .filter-btn { flex: 1; justify-content: center; }
      .schedule-details { grid-template-columns: 1fr; }
      .schedule-actions { flex-direction: column; }
      .action-btn { width: 100%; justify-content: center; }
    }
</style>
</head>

<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Main - same layout as broker dashboard -->
<div class="container">
  <!-- View controls and refresh -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
    <div class="view-toggle" id="viewToggle">
      <button class="view-btn active" data-view="calendar">
        <i class="fas fa-calendar-alt"></i> Calendar
      </button>
      <button class="view-btn" data-view="list">
        <i class="fas fa-list"></i> List
      </button>
    </div>
    <button class="refresh-btn" id="refreshBtn">
      <i class="fas fa-sync-alt"></i> Refresh
    </button>
  </div>

  <!-- Calendar View - same section style as dashboard -->
  <div id="calendarView">
    <h2 class="section-title" style="margin-bottom: 20px;">
      <i class="fas fa-calendar-alt"></i>
      Viewing Calendar
    </h2>
    <div class="calendar-container">
      <div id="calendar"></div>
    </div>
  </div>

  <!-- List View -->
  <div class="schedules-list-container" id="listView" style="display: none;">
    <div class="schedules-header">
      <h3 class="section-title" style="margin-bottom: 0;"><i class="fas fa-list"></i> All Schedules</h3>
      
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">
          <i class="fas fa-list"></i> All
        </button>
        <button class="filter-btn" data-filter="pending">
          <i class="fas fa-clock"></i> Pending
        </button>
        <button class="filter-btn" data-filter="confirmed">
          <i class="fas fa-check-circle"></i> Confirmed
        </button>
        <button class="filter-btn" data-filter="today">
          <i class="fas fa-calendar-day"></i> Today
        </button>
        <button class="filter-btn" data-filter="upcoming">
          <i class="fas fa-arrow-up"></i> Upcoming
        </button>
      </div>
    </div>
    
    <div class="schedules-list" id="schedulesList">
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading schedules...</p>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Detail Modal -->
<div class="modal-overlay" id="scheduleModal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-calendar-check"></i> Schedule Details</h3>
      <button class="modal-close" id="modalClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body" id="modalBody">
      <!-- Content will be populated by JavaScript -->
    </div>
    
    <div class="modal-actions" id="modalActions">
      <!-- Actions will be populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Sidebar Loader -->
<script src="../sidebar-user.js"></script>
<script>
// Mobile menu functionality
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    sidebar.style.transform = sidebar.style.transform === 'translateX(0px)' ? 
      'translateX(-100%)' : 'translateX(0px)';
  }
});

// Close sidebar when clicking on a link (mobile)
document.addEventListener('click', function(e) {
  if (window.innerWidth <= 1024) {
    if (e.target.closest('.sidebar-link')) {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.style.transform = 'translateX(-100%)';
      }
    }
  }
});

// Load sidebar
fetch('sidebar.html')
  .then(response => response.text())
  .then(html => {
    document.getElementById('sidebar-container').innerHTML = html;
    if (typeof window.updateSidebarUserProfile === 'function') window.updateSidebarUserProfile();
    const links = document.querySelectorAll('.sidebar-link');
    links.forEach(link => {
      if (link.getAttribute('href') === 'schedule_management.html') {
        link.classList.add('active');
      }
    });
    setupLogoutButton();
  })
  .catch(error => console.error('Error loading sidebar:', error));

function setupLogoutButton() {
  const logoutBtn = document.getElementById("logoutBtn");
  if (!logoutBtn) { setTimeout(setupLogoutButton, 100); return; }
  const newLogoutBtn = logoutBtn.cloneNode(true);
  logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
  newLogoutBtn.addEventListener("click", function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (confirm("Are you sure you want to log out?")) {
      if (typeof window.performLogout === 'function') window.performLogout();
      else window.location.href = "../login.html";
    }
  });
}

// Handle window resize
window.addEventListener('resize', function() {
  const sidebar = document.querySelector('.sidebar');
  if (window.innerWidth > 1024 && sidebar) {
    sidebar.style.transform = 'translateX(0)';
  } else if (window.innerWidth <= 1024 && sidebar) {
    sidebar.style.transform = 'translateX(-100%)';
  }
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  query, 
  where, 
  getDocs, 
  getDoc, 
  doc, 
  updateDoc, 
  addDoc,
  onSnapshot, 
  serverTimestamp,
  orderBy,
  Timestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
  authDomain: "bahai-1b76d.firebaseapp.com",
  projectId: "bahai-1b76d",
  storageBucket: "bahai-1b76d.firebasestorage.app",
  messagingSenderId: "646878644941",
  appId: "1:646878644941:web:5b4ccc3412250337587784"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Global variables
let currentUser = null;
let calendar = null;
let allSchedules = [];
let userMap = new Map();
let propertyMap = new Map();
let scheduleListener = null;
let activeFilter = 'all';
let activeView = 'calendar';

// Debug mode
const DEBUG = true;
function debugLog(...args) {
  if (DEBUG) {
    console.log('üîç [DEBUG]', ...args);
  }
}

// Initialize on auth state change
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "../login.html";
    return;
  }
  
  currentUser = user;
  debugLog('üë§ Broker logged in:', user.uid, 'Email:', user.email);
  
  // Initialize the page
  initPage();
});

window.performLogout = async function() {
  try {
    await signOut(auth);
    localStorage.removeItem('userData');
    sessionStorage.removeItem('userData');
    window.location.href = "../login.html";
  } catch (e) {
    console.error('Logout error:', e);
    window.location.href = "../login.html";
  }
};

// Initialize the page
async function initPage() {
  debugLog('üöÄ Initializing schedule management page...');
  
  // Load current user data first
  await loadCurrentUserData();
  
  // Setup event listeners
  setupEventListeners();
  
  // Initialize FullCalendar
  initCalendar();
  
  // Load schedules
  await loadSchedules();
  
  // Setup real-time listener
  setupScheduleListener();
}

// Load current user data
async function loadCurrentUserData() {
  try {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      currentUser.displayName = extractUserName(userData);
      currentUser.role = userData.role || 'broker';
    } else {
      currentUser.displayName = 'Broker';
    }
  } catch (error) {
    debugLog('‚ùå Error loading current user data:', error);
    currentUser.displayName = 'Broker';
  }
}

// Setup event listeners
function setupEventListeners() {
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', refreshSchedules);
  
  // View toggle buttons
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const view = this.dataset.view;
      setActiveView(view);
    });
  });
  
  // Filter buttons (list view)
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const filter = this.dataset.filter;
      setActiveFilter(filter);
    });
  });
  
  // Modal close button
  document.getElementById('modalClose').addEventListener('click', closeModal);
  
  // Close modal when clicking outside
  document.getElementById('scheduleModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });
}

// Initialize FullCalendar
function initCalendar() {
  const calendarEl = document.getElementById('calendar');
  
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    buttonText: {
      today: 'Today',
      month: 'Month',
      week: 'Week',
      day: 'Day'
    },
    height: 'auto',
    editable: false,
    selectable: false,
    eventClick: function(info) {
      const scheduleId = info.event.id;
      const schedule = allSchedules.find(s => s.id === scheduleId);
      if (schedule) {
        showScheduleModal(schedule);
      }
    },
    events: function(fetchInfo, successCallback, failureCallback) {
      // Filter schedules for the current calendar view
      const startDate = fetchInfo.start;
      const endDate = fetchInfo.end;
      
      const filteredSchedules = allSchedules.filter(schedule => {
        const scheduleDate = getScheduleDate(schedule);
        if (!scheduleDate) return false;
        return scheduleDate >= startDate && scheduleDate <= endDate;
      });
      
      // Convert schedules to calendar events
      const events = filteredSchedules.map(schedule => {
        const scheduleDate = getScheduleDate(schedule);
        const status = schedule.status || 'pending';
        const timeStr = schedule.proposedTime || '';
        const buyerName = schedule.buyerName || 'Buyer';
        const propertyTitle = schedule.propertyTitle || 'Property';
        
        // Create event title with time
        let eventTitle = `${buyerName}`;
        if (timeStr) {
          eventTitle = `${timeStr} - ${buyerName}`;
        }
        
        return {
          id: schedule.id,
          title: eventTitle,
          start: scheduleDate,
          allDay: false,
          extendedProps: {
            status: status,
            buyerId: schedule.buyerId,
            propertyId: schedule.propertyId,
            propertyTitle: propertyTitle,
            buyerName: buyerName,
            time: timeStr
          },
          className: `event-${status}`,
          backgroundColor: getStatusColor(status),
          borderColor: getStatusBorderColor(status),
          textColor: getStatusTextColor(status)
        };
      });
      
      successCallback(events);
    },
    eventContent: function(arg) {
      // Custom event content
      const event = arg.event;
      const status = event.extendedProps.status;
      const time = event.extendedProps.time || '';
      const buyerName = event.extendedProps.buyerName || 'Buyer';
      const propertyTitle = event.extendedProps.propertyTitle || 'Property';
      
      const eventEl = document.createElement('div');
      eventEl.className = 'fc-event-content';
      eventEl.style.padding = '2px 4px';
      eventEl.innerHTML = `
        <div style="font-size: 10px; font-weight: 600; margin-bottom: 1px; color: inherit;">
          ${time}
        </div>
        <div style="font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: inherit;">
          ${buyerName}
        </div>
        <div style="font-size: 8px; margin-top: 1px; font-weight: 500; color: inherit;">
          ${status.toUpperCase()}
        </div>
      `;
      
      return { domNodes: [eventEl] };
    }
  });
  
  calendar.render();
}

// Get schedule date for calendar
function getScheduleDate(schedule) {
  try {
    // First try to get date from proposedDate
    if (schedule.proposedDate) {
      if (schedule.proposedDate.toDate) {
        // It's a Firestore Timestamp
        const date = schedule.proposedDate.toDate();
        
        // Add time if available
        if (schedule.proposedTime) {
          addTimeToDate(date, schedule.proposedTime);
        }
        
        return date;
      } else if (typeof schedule.proposedDate === 'string') {
        // It's a string (YYYY-MM-DD format)
        const [year, month, day] = schedule.proposedDate.split('-');
        const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        
        // Add time if available
        if (schedule.proposedTime) {
          addTimeToDate(date, schedule.proposedTime);
        }
        
        return date;
      }
    }
    
    // Fallback to createdAt
    if (schedule.createdAt?.toDate) {
      return schedule.createdAt.toDate();
    }
    
    // Last resort: current date
    return new Date();
  } catch (error) {
    debugLog('‚ùå Error parsing schedule date:', error);
    return new Date();
  }
}

// Helper function to add time to date
function addTimeToDate(date, timeStr) {
  if (!timeStr) return;
  
  const timeMatch = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
  if (timeMatch) {
    let hours = parseInt(timeMatch[1]);
    const minutes = parseInt(timeMatch[2]);
    const period = timeMatch[3].toUpperCase();
    
    if (period === 'PM' && hours < 12) hours += 12;
    if (period === 'AM' && hours === 12) hours = 0;
    
    date.setHours(hours, minutes, 0, 0);
  }
}

// Load schedules for broker
async function loadSchedules() {
  try {
    debugLog('üîç Loading schedules for broker:', currentUser.uid);
    
    // Clear previous data
    allSchedules = [];
    userMap.clear();
    propertyMap.clear();
    
    // Load schedules where broker is the current user
    await loadSchedulesFromDB();
    
    if (allSchedules.length === 0) {
      debugLog('‚ö†Ô∏è No schedules found for broker');
      showEmptyState();
    } else {
      // Load user and property data for schedules
      await loadRelatedData();
      
      // Update stats
      updateStats();
      
      // Update calendar
      if (calendar) {
        calendar.refetchEvents();
      }
      
      // Update list view
      updateListView();
      
      debugLog(`‚úÖ Loaded ${allSchedules.length} schedules`);
    }
    
  } catch (error) {
    console.error('‚ùå Error loading schedules:', error);
    showError('Failed to load schedules: ' + error.message);
  }
}

// Load schedules from database
async function loadSchedulesFromDB() {
  try {
    debugLog('üìã Loading schedules from Firestore...');
    
    const schedulesRef = collection(db, 'schedules');
    
    // Try multiple queries to find schedules
    const queries = [
      // Query 1: Direct brokerId match
      query(
        schedulesRef,
        where('brokerId', '==', currentUser.uid),
        orderBy('createdAt', 'desc')
      ),
      // Query 2: Check if brokerId might be in a different field
      query(
        schedulesRef,
        where('userId', '==', currentUser.uid),
        orderBy('createdAt', 'desc')
      )
    ];
    
    let foundSchedules = false;
    
    for (const q of queries) {
      try {
        const snapshot = await getDocs(q);
        debugLog(`üìÑ Found ${snapshot.size} schedules with query`);
        
        snapshot.forEach(doc => {
          const schedule = {
            id: doc.id,
            ...doc.data()
          };
          
          // Ensure brokerId is set
          if (!schedule.brokerId && schedule.userId) {
            schedule.brokerId = schedule.userId;
          }
          
          // Only add if brokerId matches current user
          if (schedule.brokerId === currentUser.uid) {
            processSchedule(doc.id, schedule);
            foundSchedules = true;
          }
        });
        
        if (foundSchedules) break;
      } catch (queryError) {
        debugLog('‚ö†Ô∏è Query error:', queryError.message);
        // Continue to next query
      }
    }
    
    // If still no schedules, try to get all and filter client-side
    if (!foundSchedules) {
      debugLog('üîç Trying to get all schedules and filter...');
      const allSchedulesSnapshot = await getDocs(schedulesRef);
      
      allSchedulesSnapshot.forEach(doc => {
        const schedule = {
          id: doc.id,
          ...doc.data()
        };
        
        // Check if current user is the broker
        if (schedule.brokerId === currentUser.uid || 
            schedule.userId === currentUser.uid ||
            (schedule.conversationId && schedule.conversationId.includes(currentUser.uid))) {
          
          if (!schedule.brokerId) {
            schedule.brokerId = currentUser.uid;
          }
          
          processSchedule(doc.id, schedule);
          foundSchedules = true;
        }
      });
    }
    
  } catch (error) {
    debugLog('‚ö†Ô∏è Error loading schedules:', error.message);
    throw error;
  }
}

// Process a schedule document
function processSchedule(id, data) {
  try {
    const schedule = {
      id: id,
      ...data
    };
    
    // Ensure we have required fields
    if (!schedule.buyerId && schedule.userId && schedule.userId !== currentUser.uid) {
      schedule.buyerId = schedule.userId;
    }
    
    // Check if schedule already exists (avoid duplicates)
    const exists = allSchedules.some(s => s.id === id);
    if (!exists) {
      allSchedules.push(schedule);
      debugLog(`‚úÖ Added schedule: ${id}`, {
        buyerId: schedule.buyerId,
        brokerId: schedule.brokerId,
        propertyId: schedule.propertyId,
        status: schedule.status,
        date: schedule.proposedDate
      });
    }
    
  } catch (error) {
    debugLog('‚ùå Error processing schedule:', error);
  }
}

// Load related user and property data
async function loadRelatedData() {
  const userIds = new Set();
  const propertyIds = new Set();
  
  allSchedules.forEach(schedule => {
    if (schedule.buyerId) userIds.add(schedule.buyerId);
    if (schedule.propertyId) propertyIds.add(schedule.propertyId);
  });
  
  debugLog(`üë• Loading ${userIds.size} users and ${propertyIds.size} properties...`);
  
  // Load users in parallel
  const userPromises = Array.from(userIds).map(userId => loadUserData(userId));
  await Promise.all(userPromises);
  
  // Load properties in parallel
  const propertyPromises = Array.from(propertyIds).map(propertyId => loadPropertyData(propertyId));
  await Promise.all(propertyPromises);
  
  // Update schedule objects with names
  allSchedules.forEach(schedule => {
    const buyer = userMap.get(schedule.buyerId);
    const property = propertyMap.get(schedule.propertyId);
    
    if (buyer) {
      schedule.buyerName = buyer.displayName;
      schedule.buyerEmail = buyer.email;
      schedule.buyerPhone = buyer.phone;
    } else {
      schedule.buyerName = 'Unknown Buyer';
      schedule.buyerEmail = 'No email';
      schedule.buyerPhone = 'No phone';
    }
    
    if (property) {
      schedule.propertyTitle = property.title;
      schedule.propertyLocation = property.location;
      schedule.propertyPrice = property.price;
      schedule.propertyPhotos = property.photos;
    } else {
      schedule.propertyTitle = 'Unknown Property';
      schedule.propertyLocation = 'Location not specified';
      schedule.propertyPrice = 0;
    }
  });
}

// Load user data
async function loadUserData(userId) {
  if (userMap.has(userId)) return;
  
  try {
    const userDoc = await getDoc(doc(db, "users", userId));
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      const displayName = extractUserName(userData);
      
      userMap.set(userId, {
        id: userId,
        displayName: displayName,
        email: userData.email || 'No email',
        phone: userData.phone || userData.phoneNumber || userData.mobile || 'No phone',
        role: userData.role || 'buyer'
      });
      
      debugLog(`‚úÖ Loaded user: ${displayName} (${userId})`);
    } else {
      debugLog(`‚ö†Ô∏è User document not found: ${userId}`);
      userMap.set(userId, {
        id: userId,
        displayName: `User ${userId.substring(0, 8)}`,
        email: 'No email',
        phone: 'No phone',
        role: 'unknown'
      });
    }
  } catch (error) {
    debugLog(`‚ùå Error loading user ${userId}:`, error);
    userMap.set(userId, {
      id: userId,
      displayName: `User ${userId.substring(0, 8)}`,
      email: 'Error loading',
      phone: 'Error loading',
      role: 'error'
    });
  }
}

// Load property data
async function loadPropertyData(propertyId) {
  if (propertyMap.has(propertyId)) return;
  
  try {
    const propertyDoc = await getDoc(doc(db, "properties", propertyId));
    
    if (propertyDoc.exists()) {
      const propertyData = propertyDoc.data();
      
      propertyMap.set(propertyId, {
        id: propertyId,
        title: propertyData.title || 'Untitled Property',
        location: propertyData.location || propertyData.address || 'Location not specified',
        price: propertyData.pricing || propertyData.monthlyRent || propertyData.price || 0,
        type: propertyData.propertyType || propertyData.type || 'Property',
        photos: propertyData.photos || propertyData.imageUrls || [],
        userId: propertyData.userId || null
      });
      
      debugLog(`‚úÖ Loaded property: ${propertyData.title || propertyId}`);
    } else {
      debugLog(`‚ö†Ô∏è Property document not found: ${propertyId}`);
      propertyMap.set(propertyId, {
        id: propertyId,
        title: 'Unknown Property',
        location: 'Location not specified',
        price: 0,
        type: 'Property',
        photos: [],
        userId: null
      });
    }
  } catch (error) {
    debugLog(`‚ùå Error loading property ${propertyId}:`, error);
    propertyMap.set(propertyId, {
      id: propertyId,
      title: 'Error Loading Property',
      location: 'Error loading location',
      price: 0,
      type: 'Property',
      photos: [],
      userId: null
    });
  }
}

// Extract user name from user data
function extractUserName(userData) {
  if (!userData) return 'Unknown User';
  
  if (userData.fullName && userData.fullName.trim()) {
    return userData.fullName.trim();
  }
  if (userData.displayName && userData.displayName.trim()) {
    return userData.displayName.trim();
  }
  if (userData.name && userData.name.trim()) {
    return userData.name.trim();
  }
  if (userData.firstName || userData.lastName) {
    const firstName = userData.firstName || '';
    const lastName = userData.lastName || '';
    return `${firstName} ${lastName}`.trim();
  }
  if (userData.email) {
    return userData.email.split('@')[0];
  }
  
  return 'Unknown User';
}

// Setup real-time listener for schedules
function setupScheduleListener() {
  try {
    const schedulesRef = collection(db, 'schedules');
    const q = query(
      schedulesRef,
      where('brokerId', '==', currentUser.uid),
      orderBy('createdAt', 'desc')
    );
    
    scheduleListener = onSnapshot(q, (snapshot) => {
      debugLog('üìÖ Schedule update detected');
      
      let needsUpdate = false;
      
      snapshot.docChanges().forEach((change) => {
        const scheduleId = change.doc.id;
        const scheduleData = change.doc.data();
        
        if (change.type === 'added') {
          debugLog('‚ûï New schedule added:', scheduleId);
          processSchedule(scheduleId, scheduleData);
          needsUpdate = true;
        } else if (change.type === 'modified') {
          debugLog('‚úèÔ∏è Schedule updated:', scheduleId);
          const index = allSchedules.findIndex(s => s.id === scheduleId);
          if (index !== -1) {
            allSchedules[index] = {
              id: scheduleId,
              ...scheduleData
            };
            needsUpdate = true;
          }
        } else if (change.type === 'removed') {
          debugLog('üóëÔ∏è Schedule removed:', scheduleId);
          const index = allSchedules.findIndex(s => s.id === scheduleId);
          if (index !== -1) {
            allSchedules.splice(index, 1);
            needsUpdate = true;
          }
        }
      });
      
      if (needsUpdate) {
        // Reload related data
        loadRelatedData().then(() => {
          updateStats();
          if (calendar) calendar.refetchEvents();
          updateListView();
        });
      }
    }, (error) => {
      debugLog('‚ùå Schedule listener error:', error);
      
      // If query fails, try alternative approach
      debugLog('üîÑ Trying alternative schedule listener...');
      setupAlternativeScheduleListener();
    });
    
  } catch (error) {
    debugLog('‚ùå Error setting up schedule listener:', error);
    setupAlternativeScheduleListener();
  }
}

// Alternative schedule listener for when primary query fails
function setupAlternativeScheduleListener() {
  try {
    const schedulesRef = collection(db, 'schedules');
    const q = query(schedulesRef, orderBy('createdAt', 'desc'));
    
    scheduleListener = onSnapshot(q, (snapshot) => {
      debugLog('üìÖ Alternative schedule listener triggered');
      
      // Filter schedules client-side
      const brokerSchedules = [];
      
      snapshot.forEach(doc => {
        const scheduleData = doc.data();
        if (scheduleData.brokerId === currentUser.uid || 
            scheduleData.userId === currentUser.uid) {
          brokerSchedules.push({
            id: doc.id,
            ...scheduleData
          });
        }
      });
      
      // Update all schedules
      allSchedules = brokerSchedules;
      
      // Reload related data
      loadRelatedData().then(() => {
        updateStats();
        if (calendar) calendar.refetchEvents();
        updateListView();
      });
    });
    
  } catch (error) {
    debugLog('‚ùå Error setting up alternative schedule listener:', error);
  }
}

// Show empty state when no schedules
function showEmptyState() {
  const schedulesList = document.getElementById('schedulesList');
  const calendarView = document.getElementById('calendarView');
  
  schedulesList.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">üìÖ</div>
      <h3>No schedules found</h3>
      <p>You don't have any viewing schedules yet. Schedules will appear here when buyers request viewings through your property listings.</p>
      <button class="action-btn primary" onclick="window.location.href='inquiries.html'" style="margin-top: 20px;">
        <i class="fas fa-comments"></i> Check Inquiries
      </button>
    </div>
  `;
  
  // Also show message in calendar view
  if (calendar) {
    calendar.removeAllEvents();
  }
}

// Update statistics (hero stats removed; kept for potential future use)
function updateStats() {
  // Stats display removed with hero section
}

// Set active view (calendar/list)
function setActiveView(view) {
  activeView = view;
  
  // Update button states
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.view === view) {
      btn.classList.add('active');
    }
  });
  
  // Show/hide views
  if (view === 'calendar') {
    document.getElementById('calendarView').style.display = 'block';
    document.getElementById('listView').style.display = 'none';
  } else {
    document.getElementById('calendarView').style.display = 'none';
    document.getElementById('listView').style.display = 'block';
    updateListView();
  }
}

// Set active filter for list view
function setActiveFilter(filter) {
  activeFilter = filter;
  
  // Update button states
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filter === filter) {
      btn.classList.add('active');
    }
  });
  
  // Update list view
  updateListView();
}

// Update list view based on active filter
function updateListView() {
  const schedulesList = document.getElementById('schedulesList');
  
  if (allSchedules.length === 0) {
    showEmptyState();
    return;
  }
  
  let filteredSchedules = [...allSchedules];
  
  // Apply filter
  switch(activeFilter) {
    case 'pending':
      filteredSchedules = filteredSchedules.filter(s => s.status === 'pending');
      break;
    case 'confirmed':
      filteredSchedules = filteredSchedules.filter(s => s.status === 'confirmed');
      break;
    case 'today':
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      filteredSchedules = filteredSchedules.filter(s => {
        const scheduleDate = getScheduleDate(s);
        return scheduleDate >= today && scheduleDate < tomorrow;
      });
      break;
    case 'upcoming':
      const now = new Date();
      filteredSchedules = filteredSchedules.filter(s => {
        const scheduleDate = getScheduleDate(s);
        return scheduleDate >= now && (s.status === 'confirmed' || s.status === 'pending');
      });
      // Sort by date (ascending)
      filteredSchedules.sort((a, b) => getScheduleDate(a) - getScheduleDate(b));
      break;
    // 'all' filter doesn't need additional filtering
  }
  
  if (filteredSchedules.length === 0) {
    schedulesList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üîç</div>
        <h3>No schedules match your filter</h3>
        <p>Try changing your filter settings to see different schedules.</p>
      </div>
    `;
    return;
  }
  
  // Clear and rebuild list
  schedulesList.innerHTML = '';
  
  filteredSchedules.forEach(schedule => {
    const scheduleElement = createScheduleElement(schedule);
    schedulesList.appendChild(scheduleElement);
  });
}

// Create schedule element for list view
function createScheduleElement(schedule) {
  const element = document.createElement('div');
  element.className = 'schedule-item';
  element.dataset.scheduleId = schedule.id;
  
  // Format date and time
  const scheduleDate = getScheduleDate(schedule);
  const dateStr = formatDate(scheduleDate);
  const timeStr = schedule.proposedTime || 'Time not specified';
  const status = schedule.status || 'pending';
  
  element.innerHTML = `
    <div class="schedule-item-header">
      <div class="schedule-date-time">
        <div class="schedule-date">
          <i class="fas fa-calendar-day"></i> ${dateStr}
        </div>
        <div class="schedule-time">
          <i class="fas fa-clock"></i> ${timeStr}
        </div>
      </div>
      <span class="schedule-status status-${status}">${status}</span>
    </div>
    
    <div class="schedule-details">
      <div class="detail-item">
        <span class="detail-label">Buyer</span>
        <span class="detail-value">
          <i class="fas fa-user"></i> ${schedule.buyerName || 'Unknown Buyer'}
        </span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Property</span>
        <span class="detail-value">
          <i class="fas fa-home"></i> ${schedule.propertyTitle || 'Unknown Property'}
        </span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Location</span>
        <span class="detail-value">
          <i class="fas fa-map-marker-alt"></i> ${schedule.propertyLocation || 'Not specified'}
        </span>
      </div>
    </div>
    
    ${schedule.notes ? `
      <div class="schedule-notes">
        <div class="schedule-notes-label">Buyer Notes:</div>
        <div class="schedule-notes-content">${schedule.notes}</div>
      </div>
    ` : ''}
    
    ${schedule.brokerNotes ? `
      <div class="schedule-notes">
        <div class="schedule-notes-label">Your Notes:</div>
        <div class="schedule-notes-content">${schedule.brokerNotes}</div>
      </div>
    ` : ''}
    
    <div class="schedule-actions">
      <button class="action-btn primary" onclick="viewScheduleDetails('${schedule.id}')">
        <i class="fas fa-eye"></i> View Details
      </button>
      ${status === 'pending' ? `
        <button class="action-btn secondary" onclick="confirmSchedule('${schedule.id}')">
          <i class="fas fa-check"></i> Confirm
        </button>
        <button class="action-btn warning" onclick="declineSchedule('${schedule.id}')">
          <i class="fas fa-times"></i> Decline
        </button>
      ` : ''}
      ${status === 'alternative' ? `
        <button class="action-btn primary" onclick="confirmAlternative('${schedule.id}')">
          <i class="fas fa-check"></i> Confirm Alternative
        </button>
      ` : ''}
    </div>
  `;
  
  return element;
}

// Show schedule details modal
function showScheduleModal(schedule) {
  const modalBody = document.getElementById('modalBody');
  const modalActions = document.getElementById('modalActions');
  
  // Format date and time
  const scheduleDate = getScheduleDate(schedule);
  const dateStr = formatDate(scheduleDate);
  const timeStr = schedule.proposedTime || 'Time not specified';
  const status = schedule.status || 'pending';
  
  // Get buyer and property info
  const buyerName = schedule.buyerName || 'Unknown Buyer';
  const buyerEmail = schedule.buyerEmail || 'No email';
  const buyerPhone = schedule.buyerPhone || 'No phone';
  const propertyTitle = schedule.propertyTitle || 'Unknown Property';
  const propertyLocation = schedule.propertyLocation || 'Location not specified';
  
  // Format price
  const price = schedule.propertyPrice || 0;
  const priceDisplay = price < 1000000 ? `‚Ç±${price.toLocaleString()}/month` : `‚Ç±${price.toLocaleString()}`;
  
  // Populate modal body
  modalBody.innerHTML = `
    <div class="modal-section">
      <h4><i class="fas fa-info-circle"></i> Schedule Information</h4>
      <div class="modal-grid">
        <div class="detail-item">
          <span class="detail-label">Date</span>
          <span class="detail-value">
            <i class="fas fa-calendar-day"></i> ${dateStr}
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Time</span>
          <span class="detail-value">
            <i class="fas fa-clock"></i> ${timeStr}
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Status</span>
          <span class="detail-value">
            <span class="schedule-status status-${status}">${status}</span>
          </span>
        </div>
        ${schedule.alternativeDate ? `
          <div class="detail-item">
            <span class="detail-label">Alternative Date</span>
            <span class="detail-value">
              <i class="fas fa-calendar-alt"></i> ${schedule.alternativeDate}
            </span>
          </div>
        ` : ''}
        ${schedule.alternativeTime ? `
          <div class="detail-item">
            <span class="detail-label">Alternative Time</span>
            <span class="detail-value">
              <i class="fas fa-clock"></i> ${schedule.alternativeTime}
            </span>
          </div>
        ` : ''}
      </div>
    </div>
    
    <div class="modal-section">
      <h4><i class="fas fa-user"></i> Buyer Information</h4>
      <div class="modal-grid">
        <div class="detail-item">
          <span class="detail-label">Name</span>
          <span class="detail-value">
            <i class="fas fa-user"></i> ${buyerName}
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Email</span>
          <span class="detail-value">
            <i class="fas fa-envelope"></i> ${buyerEmail}
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Phone</span>
          <span class="detail-value">
            <i class="fas fa-phone"></i> ${buyerPhone}
          </span>
        </div>
      </div>
    </div>
    
    <div class="modal-section">
      <h4><i class="fas fa-home"></i> Property Information</h4>
      <div class="modal-grid">
        <div class="detail-item">
          <span class="detail-label">Title</span>
          <span class="detail-value">
            <i class="fas fa-home"></i> ${propertyTitle}
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Location</span>
          <span class="detail-value">
            <i class="fas fa-map-marker-alt"></i> ${propertyLocation}
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Price</span>
          <span class="detail-value">
            <i class="fas fa-tag"></i> ${priceDisplay}
          </span>
        </div>
      </div>
    </div>
    
    ${schedule.notes ? `
      <div class="modal-section">
        <h4><i class="fas fa-sticky-note"></i> Buyer Notes</h4>
        <div class="schedule-notes">
          <div class="schedule-notes-content">${schedule.notes}</div>
        </div>
      </div>
    ` : ''}
    
    ${schedule.brokerNotes ? `
      <div class="modal-section">
        <h4><i class="fas fa-sticky-note"></i> Your Notes</h4>
        <div class="schedule-notes">
          <div class="schedule-notes-content">${schedule.brokerNotes}</div>
        </div>
      </div>
    ` : ''}
    
    ${schedule.declineReason ? `
      <div class="modal-section">
        <h4><i class="fas fa-comment-alt"></i> Decline Reason</h4>
        <div class="schedule-notes">
          <div class="schedule-notes-content">${schedule.declineReason}</div>
        </div>
      </div>
    ` : ''}
  `;
  
  // Populate modal actions based on status
  modalActions.innerHTML = '';
  
  if (status === 'pending') {
    modalActions.innerHTML = `
      <button class="modal-btn cancel" onclick="closeModal()">
        <i class="fas fa-times"></i> Close
      </button>
      <button class="modal-btn confirm" onclick="confirmSchedule('${schedule.id}', true)">
        <i class="fas fa-check"></i> Confirm Schedule
      </button>
      <button class="modal-btn decline" onclick="declineSchedule('${schedule.id}', true)">
        <i class="fas fa-times"></i> Decline
      </button>
      <button class="modal-btn alternative" onclick="suggestAlternative('${schedule.id}', true)">
        <i class="fas fa-clock"></i> Suggest Alternative
      </button>
    `;
  } else if (status === 'alternative') {
    modalActions.innerHTML = `
      <button class="modal-btn cancel" onclick="closeModal()">
        <i class="fas fa-times"></i> Close
      </button>
      <button class="modal-btn confirm" onclick="confirmAlternative('${schedule.id}', true)">
        <i class="fas fa-check"></i> Confirm Alternative
      </button>
    `;
  } else {
    modalActions.innerHTML = `
      <button class="modal-btn cancel" onclick="closeModal()">
        <i class="fas fa-times"></i> Close
      </button>
      <button class="modal-btn secondary" onclick="reschedule('${schedule.id}')">
        <i class="fas fa-calendar-alt"></i> Reschedule
      </button>
    `;
  }
  
  // Show modal
  document.getElementById('scheduleModal').classList.add('active');
}

// Close modal
function closeModal() {
  document.getElementById('scheduleModal').classList.remove('active');
}

// Confirm schedule
async function confirmSchedule(scheduleId, fromModal = false) {
  const schedule = allSchedules.find(s => s.id === scheduleId);
  if (!schedule) return;
  
  const notes = fromModal ? prompt('Add optional notes for the buyer:') : '';
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    await updateDoc(scheduleRef, {
      status: 'confirmed',
      brokerNotes: notes || null,
      confirmedAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    
    // Send confirmation message
    const messageText = `‚úÖ Viewing confirmed for ${schedule.proposedDate} at ${schedule.proposedTime}`;
    if (notes) messageText += `\nBroker Notes: ${notes}`;
    
    await sendScheduleNotification(schedule.conversationId, 'confirmed', messageText, scheduleId);
    
    showToast('Viewing confirmed!');
    
    if (fromModal) {
      closeModal();
    }
    
  } catch (error) {
    console.error('Error confirming schedule:', error);
    showError('Failed to confirm: ' + error.message);
  }
}

// Decline schedule
async function declineSchedule(scheduleId, fromModal = false) {
  const schedule = allSchedules.find(s => s.id === scheduleId);
  if (!schedule) return;
  
  const reason = prompt('Please provide a reason for declining:');
  if (!reason) return;
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    await updateDoc(scheduleRef, {
      status: 'declined',
      declineReason: reason,
      declinedAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    
    // Send decline message
    const messageText = `‚ùå Viewing declined\nReason: ${reason}`;
    
    await sendScheduleNotification(schedule.conversationId, 'declined', messageText, scheduleId);
    
    showToast('Viewing declined');
    
    if (fromModal) {
      closeModal();
    }
    
  } catch (error) {
    console.error('Error declining schedule:', error);
    showError('Failed to decline: ' + error.message);
  }
}

// Suggest alternative time
async function suggestAlternative(scheduleId, fromModal = false) {
  const schedule = allSchedules.find(s => s.id === scheduleId);
  if (!schedule) return;
  
  const alternativeDate = prompt('Enter alternative date (YYYY-MM-DD):');
  if (!alternativeDate) return;
  
  const alternativeTime = prompt('Enter alternative time (e.g., 02:00 PM):');
  if (!alternativeTime) return;
  
  const reason = prompt('Optional: Provide reason for suggesting alternative time:');
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    await updateDoc(scheduleRef, {
      status: 'alternative',
      alternativeDate: alternativeDate,
      alternativeTime: alternativeTime,
      declineReason: reason || null,
      updatedAt: serverTimestamp()
    });
    
    // Send alternative message
    const messageText = `üîÑ Alternative time suggested: ${alternativeDate} at ${alternativeTime}`;
    if (reason) messageText += `\nReason: ${reason}`;
    
    await sendScheduleNotification(schedule.conversationId, 'alternative', messageText, scheduleId);
    
    showToast('Alternative time suggested');
    
    if (fromModal) {
      closeModal();
    }
    
  } catch (error) {
    console.error('Error suggesting alternative:', error);
    showError('Failed to suggest alternative: ' + error.message);
  }
}

// Confirm alternative time
async function confirmAlternative(scheduleId, fromModal = false) {
  const schedule = allSchedules.find(s => s.id === scheduleId);
  if (!schedule) return;
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    await updateDoc(scheduleRef, {
      status: 'confirmed',
      proposedDate: schedule.alternativeDate || schedule.proposedDate,
      proposedTime: schedule.alternativeTime || schedule.proposedTime,
      confirmedAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    
    // Send confirmation message
    const messageText = `‚úÖ Alternative time confirmed: ${schedule.alternativeDate} at ${schedule.alternativeTime}`;
    
    await sendScheduleNotification(schedule.conversationId, 'confirmed', messageText, scheduleId);
    
    showToast('Alternative time confirmed!');
    
    if (fromModal) {
      closeModal();
    }
    
  } catch (error) {
    console.error('Error confirming alternative:', error);
    showError('Failed to confirm alternative: ' + error.message);
  }
}

// Reschedule function
async function reschedule(scheduleId) {
  const schedule = allSchedules.find(s => s.id === scheduleId);
  if (!schedule) return;
  
  // Open schedule viewing page for rescheduling
  const url = `../buyer/schedule_viewing.html?brokerId=${currentUser.uid}&buyerId=${schedule.buyerId}&propertyId=${schedule.propertyId}&reschedule=true&scheduleId=${scheduleId}`;
  window.open(url, '_blank', 'width=800,height=700,scrollbars=yes');
}

// Send schedule notification as a message
async function sendScheduleNotification(conversationId, action, messageText, scheduleId) {
  try {
    if (!conversationId) {
      debugLog('‚ö†Ô∏è No conversationId for schedule notification');
      return;
    }
    
    let scheduleAction = '';
    
    switch (action) {
      case 'confirmed':
        scheduleAction = 'schedule_confirmed';
        break;
      case 'declined':
        scheduleAction = 'schedule_declined';
        break;
      case 'alternative':
        scheduleAction = 'schedule_alternative';
        break;
    }
    
    // Get buyer ID from schedule
    const schedule = allSchedules.find(s => s.id === scheduleId);
    if (!schedule || !schedule.buyerId) {
      debugLog('‚ö†Ô∏è No buyerId for schedule notification');
      return;
    }
    
    // Create message in Firestore
    await addDoc(collection(db, 'messages'), {
      conversationId: conversationId,
      senderId: currentUser.uid,
      receiverId: schedule.buyerId,
      text: messageText,
      timestamp: serverTimestamp(),
      read: false,
      type: 'schedule',
      scheduleAction: scheduleAction,
      scheduleId: scheduleId,
      propertyId: schedule.propertyId,
      createdAt: serverTimestamp()
    });
    
    // Update conversation last message
    try {
      const conversationRef = doc(db, 'conversations', conversationId);
      const conversationDoc = await getDoc(conversationRef);
      
      if (conversationDoc.exists()) {
        await updateDoc(conversationRef, {
          lastMessage: messageText,
          lastMessageTime: serverTimestamp(),
          [`unreadCount.${schedule.buyerId}`]: 1,
          updatedAt: serverTimestamp()
        });
      }
    } catch (convError) {
      debugLog('‚ö†Ô∏è Error updating conversation:', convError);
    }
    
  } catch (error) {
    console.error('‚ùå Error sending schedule notification:', error);
  }
}

// Refresh schedules
function refreshSchedules() {
  const refreshBtn = document.getElementById('refreshBtn');
  const originalHTML = refreshBtn.innerHTML;
  
  refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
  refreshBtn.classList.add('refreshing');
  
  loadSchedules();
  
  // Reset button after 2 seconds
  setTimeout(() => {
    refreshBtn.innerHTML = originalHTML;
    refreshBtn.classList.remove('refreshing');
  }, 2000);
}

// Utility functions
function formatDate(date) {
  if (!date) return 'Date not specified';
  
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function getStatusColor(status) {
  switch(status) {
    case 'confirmed': return '#d1fae5';
    case 'pending': return '#fef3c7';
    case 'declined': return '#fee2e2';
    case 'alternative': return '#e0f2fe';
    default: return '#f3f4f6';
  }
}

function getStatusBorderColor(status) {
  switch(status) {
    case 'confirmed': return '#10b981';
    case 'pending': return '#f59e0b';
    case 'declined': return '#ef4444';
    case 'alternative': return '#0ea5e9';
    default: return '#6b7280';
  }
}

function getStatusTextColor(status) {
  switch(status) {
    case 'confirmed': return '#065f46';
    case 'pending': return '#92400e';
    case 'declined': return '#991b1b';
    case 'alternative': return '#1e40af';
    default: return '#374151';
  }
}

// Show toast notification
function showToast(message, type = 'success') {
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Show error message
function showError(message) {
  showToast(message, 'error');
}

// Expose functions to global scope for inline event handlers
window.viewScheduleDetails = function(scheduleId) {
  const schedule = allSchedules.find(s => s.id === scheduleId);
  if (schedule) {
    showScheduleModal(schedule);
  }
};

window.confirmSchedule = confirmSchedule;
window.declineSchedule = declineSchedule;
window.suggestAlternative = suggestAlternative;
window.confirmAlternative = confirmAlternative;
window.reschedule = reschedule;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  debugLog('üì± Schedule management page loaded');
});
</script>

</body>
</html>