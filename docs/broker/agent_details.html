<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agent Profile - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
      --primary: #0b2e52;
      --primary-dark: #001F3F;
      --primary-light: #002f3f;
      --secondary: #1976d2;
      --accent: #ff9800;
      --success: #10b981;
      --danger: #ef4444;
      --text-dark: #1a202c;
      --text-light: #718096;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--primary);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
    }

    /* Main Container */
    .container {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: margin-left 0.3s ease;
      max-width: calc(100% - 280px);
    }

    /* Back Button */
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      text-decoration: none;
      margin-bottom: 30px;
    }

    .back-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }

    /* Page Header */
    .page-header {
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-header p {
      color: var(--text-light);
      font-size: 16px;
    }

    /* Profile Header */
    .profile-header {
      background: var(--bg-white);
      padding: 30px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }

    .profile-badges {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .profile-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-agent {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-broker-affiliated {
      background: #f0f7ff;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .badge-active {
      background: #dcfce7;
      color: #166534;
    }

    .badge-verified {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .profile-main {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
      flex-direction: column;
      text-align: center;
    }

    @media (min-width: 768px) {
      .profile-main {
        flex-direction: row;
        text-align: left;
      }
    }

    .profile-photo {
      width: 160px;
      height: 160px;
      border-radius: 16px;
      overflow: hidden;
      border: 4px solid var(--bg-white);
      box-shadow: var(--shadow-lg);
      flex-shrink: 0;
    }

    .profile-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-photo-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      font-size: 60px;
      font-weight: bold;
    }

    .profile-details {
      flex: 1;
    }

    .profile-name {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 5px;
    }

    .profile-title {
      font-size: 18px;
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 10px;
    }

    .profile-location {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-light);
      margin-bottom: 15px;
      font-size: 16px;
      justify-content: center;
    }

    @media (min-width: 768px) {
      .profile-location {
        justify-content: flex-start;
      }
    }

    .profile-location i {
      color: var(--secondary);
    }

    .profile-bio {
      line-height: 1.6;
      color: var(--text-dark);
      margin-bottom: 20px;
      text-align: center;
    }

    @media (min-width: 768px) {
      .profile-bio {
        text-align: left;
      }
    }

    /* Profile Stats */
    .profile-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    @media (min-width: 768px) {
      .profile-stats {
        grid-template-columns: repeat(4, 1fr);
        margin-left: 0;
        margin-right: 0;
      }
    }

    .stat-card {
      background: var(--bg-white);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
      line-height: 1;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-light);
      font-weight: 500;
    }

    /* Profile Actions */
    .profile-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 30px;
    }

    @media (min-width: 768px) {
      .profile-actions {
        justify-content: flex-start;
      }
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      border: none;
      font-family: inherit;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    }

    .btn-secondary {
      background: var(--bg-light);
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    /* Profile Content Grid */
    .profile-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
    }

    @media (min-width: 1024px) {
      .profile-content {
        grid-template-columns: 1fr 350px;
      }
    }

    /* Card Styles */
    .profile-card {
      background: var(--bg-white);
      padding: 25px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 25px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .section-header i {
      font-size: 22px;
      color: var(--primary);
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-dark);
    }

    /* Tags Container */
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .tag {
      background: var(--bg-light);
      color: var(--text-dark);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--border);
    }

    .tag-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    /* Contact List */
    .contact-list {
      list-style: none;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid var(--border);
    }

    .contact-item:last-child {
      border-bottom: none;
    }

    .contact-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 18px;
    }

    .contact-details {
      flex: 1;
    }

    .contact-label {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 3px;
    }

    .contact-value {
      font-weight: 500;
      color: var(--text-dark);
      word-break: break-all;
    }

    /* Social Links */
    .social-links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .social-link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--bg-light);
      color: var(--text-dark);
      font-size: 18px;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .social-link:hover {
      transform: translateY(-3px);
      color: white;
    }

    .social-facebook:hover { background: #1877F2; }
    .social-instagram:hover { background: #E4405F; }
    .social-linkedin:hover { background: #0077B5; }
    .social-whatsapp:hover { background: #25D366; }
    .social-viber:hover { background: #665CAC; }
    .social-globe:hover { background: var(--primary); }

    /* Properties Section */
    .properties-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .properties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
    }

    @media (max-width: 768px) {
      .properties-grid {
        grid-template-columns: 1fr;
      }
    }

    .property-card {
      background: var(--bg-white);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .property-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .property-image {
      height: 200px;
      background: var(--bg-light);
      overflow: hidden;
      position: relative;
    }

    .property-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .property-card:hover .property-image img {
      transform: scale(1.05);
    }

    .property-content {
      padding: 20px;
    }

    .property-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .property-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 5px;
      line-height: 1.3;
    }

    .property-price {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      white-space: nowrap;
    }

    .property-location {
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .property-features {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .feature {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      color: var(--text-light);
    }

    .property-status {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      z-index: 2;
      box-shadow: var(--shadow);
    }

    .status-available,
    .status-active {
      background: #10b981 !important;
      color: white !important;
    }

    .status-sold {
      background: #ef4444 !important;
      color: white !important;
    }

    .status-pending {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-rented {
      background: #ddd6fe;
      color: #5b21b6;
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
      background: var(--bg-white);
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 25px;
    }

    .spinner {
      border: 4px solid var(--bg-light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 10000;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast-success {
      background: var(--success);
    }

    .toast-error {
      background: var(--danger);
    }

    @keyframes slideIn {
      from { transform: translateX(-50%) translateY(100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(-50%) translateY(0); opacity: 1; }
      to { transform: translateX(-50%) translateY(100%); opacity: 0; }
    }

    /* No Data Placeholder */
    .no-data {
      color: var(--text-light);
      font-style: italic;
      padding: 10px 0;
    }

    /* Filter Select */
    .filter-select {
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      background: var(--bg-white);
      color: var(--text-dark);
      cursor: pointer;
      min-width: 200px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    /* Broker Info Section */
    .broker-info-section {
      background: linear-gradient(135deg, #f0f7ff, #e6f7ff);
      border: 2px solid #b3e0ff;
      border-radius: 12px;
      padding: 20px;
      margin-top: 15px;
    }

    .broker-info-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .broker-info-header i {
      color: var(--primary);
      font-size: 18px;
    }

    .broker-name {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 16px;
    }

    .broker-details {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 10px;
    }

    .broker-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    /* Skills Grid */
    .skills-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }

    .skill-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      background: var(--bg-light);
      border-radius: 8px;
      font-size: 14px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .skill-item:hover {
      transform: translateY(-2px);
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }

    .skill-item i {
      color: var(--success);
    }

    /* View All Button */
    .view-all-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 8px;
      background: var(--bg-white);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      font-size: 14px;
      margin-top: 15px;
    }

    .view-all-btn:hover {
      background: var(--bg-light);
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    /* Debug Info Panel */
    .debug-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 12px;
      font-family: monospace;
      display: none;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .debug-toggle {
      background: #6c757d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .debug-toggle:hover {
      background: #5a6268;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .container {
        margin-left: 0;
        padding: 25px;
        max-width: 100%;
      }
      
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 24px;
      }
      
      .profile-photo {
        width: 120px;
        height: 120px;
      }
      
      .profile-name {
        font-size: 24px;
      }
      
      .profile-actions {
        flex-direction: column;
        width: 100%;
      }
      
      .action-btn {
        width: 100%;
        justify-content: center;
      }
      
      .properties-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-select {
        width: 100%;
      }
      
      .skills-grid {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .profile-header {
        padding: 20px;
      }
      
      .stat-value {
        font-size: 28px;
      }
      
      .profile-content {
        grid-template-columns: 1fr;
      }
    }
</style>
</head>
<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">â˜°</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Main Content -->
<div class="container">
    <!-- Debug Panel (hidden by default) -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">Show Debug Info</button>
    <div class="debug-panel" id="debugPanel">
        <div><strong>Debug Information:</strong></div>
        <div id="debugInfo">No debug info yet.</div>
    </div>

    <!-- Back Button -->
    <div>
        <a href="list_agent.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Agents
        </a>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <h1 id="pageTitle">Agent Profile</h1>
        <p id="pageSubtitle">View agent profile and listings</p>
    </div>

    <!-- Profile Content -->
    <div id="profileContent">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-badges" id="profileBadges">
                <span class="profile-badge badge-agent">Agent</span>
                <span class="profile-badge badge-active">Active</span>
            </div>

            <div class="profile-main">
                <!-- Profile Photo -->
                <div class="profile-photo" id="profilePhoto">
                    <div class="profile-photo-placeholder" id="profilePhotoPlaceholder">
                        <!-- Initial will be added by JavaScript -->
                    </div>
                </div>

                <!-- Profile Details -->
                <div class="profile-details">
                    <h1 class="profile-name" id="agentName">Loading...</h1>
                    <div class="profile-title" id="agentTitle">Real Estate Agent</div>
                    <div class="profile-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="agentLocation">Location not specified</span>
                        <span id="yearsExperience"></span>
                    </div>
                    
                    <div class="profile-bio" id="agentBio">
                        <p class="no-data">No bio information provided.</p>
                    </div>

                    <!-- Profile Stats -->
                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="propertiesCount">0</div>
                            <div class="stat-label">Properties</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="yearsExpCount">0</div>
                            <div class="stat-label">Years Experience</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="clientsCount">0</div>
                            <div class="stat-label">Clients Served</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="successRate">0%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                    </div>

                    <!-- Profile Actions -->
                    <div class="profile-actions" id="profileActions">
                        <a href="#" class="action-btn btn-primary" id="contactBtn">
                            <i class="fas fa-envelope"></i> Contact
                        </a>
                        <a href="#" class="action-btn btn-secondary" id="whatsappBtn" style="display: none;">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                        <a href="#" class="action-btn btn-outline" id="callBtn">
                            <i class="fas fa-phone"></i> Call Now
                        </a>
                        <a href="#" class="action-btn btn-secondary" id="viberBtn" style="display: none;">
                            <i class="fab fa-viber"></i> Viber
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="profile-content">
            <!-- Left Column -->
            <div class="left-column">
                <!-- About Section -->
                <div class="profile-card">
                    <div class="section-header">
                        <i class="fas fa-user"></i>
                        <h2>About</h2>
                    </div>
                    <div class="about-content" id="agentAbout">
                        <p class="no-data">No about information provided.</p>
                    </div>
                </div>

                <!-- Specializations Section -->
                <div class="profile-card">
                    <div class="section-header">
                        <i class="fas fa-star"></i>
                        <h2>Specializations</h2>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: var(--text-dark); font-size: 16px; font-weight: 600;">Property Types</h3>
                        <div class="tags-container" id="propertyTypes">
                            <span class="tag no-data">Not specified</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: var(--text-dark); font-size: 16px; font-weight: 600;">Agent Skills</h3>
                        <div class="skills-grid" id="agentSkills">
                            <span class="no-data" style="grid-column: 1 / -1;">No skills specified</span>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 10px; color: var(--text-dark); font-size: 16px; font-weight: 600;">Service Areas</h3>
                        <div class="tags-container" id="serviceAreas">
                            <span class="tag no-data">Not specified</span>
                        </div>
                    </div>
                </div>

                <!-- Broker Information (if applicable) -->
                <div class="profile-card" id="brokerSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-handshake"></i>
                        <h2>Working With Broker</h2>
                    </div>
                    <div class="broker-info-section" id="brokerInfo">
                        <!-- Broker info will be loaded here -->
                    </div>
                </div>

                <!-- Properties Section -->
                <div class="profile-card">
                    <div class="properties-header">
                        <div class="section-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 0;">
                            <i class="fas fa-home"></i>
                            <h2>Properties</h2>
                        </div>
                        <div>
                            <select id="propertyFilter" class="filter-select">
                                <option value="all">All Properties</option>
                                <option value="available">Available</option>
                                <option value="sold">Sold</option>
                                <option value="rented">Rented</option>
                                <option value="rent">For Rent</option>
                                <option value="sale">For Sale</option>
                                <option value="lease">For Lease</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="properties-grid" id="propertiesGrid">
                        <!-- Loading State -->
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading properties...</p>
                        </div>
                    </div>
                    
                    <!-- View All Button -->
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" class="view-all-btn" id="viewAllBtn" style="display: none;">
                            <i class="fas fa-eye"></i> View All Properties
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Contact Information -->
                <div class="profile-card">
                    <div class="section-header">
                        <i class="fas fa-address-card"></i>
                        <h2>Contact Info</h2>
                    </div>
                    <ul class="contact-list">
                        <li class="contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="contact-details">
                                <div class="contact-label">Email</div>
                                <div class="contact-value" id="contactEmail">Not provided</div>
                            </div>
                        </li>
                        <li class="contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="contact-details">
                                <div class="contact-label">Phone</div>
                                <div class="contact-value" id="contactPhone">Not provided</div>
                            </div>
                        </li>
                        <li class="contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="contact-details">
                                <div class="contact-label">Location</div>
                                <div class="contact-value" id="contactLocation">Not provided</div>
                            </div>
                        </li>
                        <li class="contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="contact-details">
                                <div class="contact-label">Availability</div>
                                <div class="contact-value" id="contactAvailability">Not specified</div>
                            </div>
                        </li>
                        <li class="contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div class="contact-details">
                                <div class="contact-label">Working Hours</div>
                                <div class="contact-value" id="workingHours">Not specified</div>
                            </div>
                        </li>
                        <li class="contact-item">
                            <div class="contact-icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="contact-details">
                                <div class="contact-label">Website/Portfolio</div>
                                <a href="#" class="contact-value" id="contactWebsite" target="_blank" style="color: var(--primary); text-decoration: none; display: none;">Visit Portfolio</a>
                                <span id="noWebsite" class="no-data">Not provided</span>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- Professional Details -->
                <div class="profile-card">
                    <div class="section-header">
                        <i class="fas fa-briefcase"></i>
                        <h2>Professional Details</h2>
                    </div>
                    <div class="professional-details">
                        <div style="margin-bottom: 15px;">
                            <div class="contact-label">Agent ID</div>
                            <div class="contact-value" id="agentId">Not assigned</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div class="contact-label">Languages Spoken</div>
                            <div class="contact-value" id="languagesSpoken">Not specified</div>
                        </div>
                        <div>
                            <div class="contact-label">Member Since</div>
                            <div class="contact-value" id="memberSince">N/A</div>
                        </div>
                    </div>
                </div>

                <!-- Social Media -->
                <div class="profile-card">
                    <div class="section-header">
                        <i class="fas fa-share-alt"></i>
                        <h2>Connect</h2>
                    </div>
                    <div class="social-links" id="socialLinks">
                        <p class="no-data" style="width: 100%; text-align: center;">No social media links available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar Loader Script -->
<script>
// Mobile menu functionality
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.style.transform = sidebar.style.transform === 'translateX(0px)' ? 
            'translateX(-100%)' : 'translateX(0px)';
    }
});

// Debug panel toggle
function toggleDebugPanel() {
    const panel = document.getElementById('debugPanel');
    const button = document.querySelector('.debug-toggle');
    if (panel.style.display === 'block') {
        panel.style.display = 'none';
        button.textContent = 'Show Debug Info';
    } else {
        panel.style.display = 'block';
        button.textContent = 'Hide Debug Info';
    }
}

// Update debug info
function updateDebugInfo(info) {
    document.getElementById('debugInfo').textContent = info;
    console.log('Debug:', info);
}

// Simple logout function
function setupLogoutButton() {
    const logoutBtn = document.getElementById("logoutBtn");
    if (!logoutBtn) {
        console.warn("Logout button not found, retrying...");
        setTimeout(setupLogoutButton, 100);
        return;
    }

    // Remove existing event listeners
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

    // Add new event listener
    newLogoutBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (confirm("Are you sure you want to log out?")) {
            // Check if performLogout function exists (from main script)
            if (typeof window.performLogout === 'function') {
                window.performLogout();
            } else {
                // Fallback to simple redirect
                window.location.href = "login.html";
            }
        }
    });

    console.log('Logout button initialized successfully');
}

// Function to load sidebar based on user role
async function loadSidebarBasedOnRole(userRole) {
    let sidebarFile = 'sidebar.html'; // Default
    
    if (userRole === 'agent') {
        sidebarFile = 'agent_sidebar.html';
    } else if (userRole === 'broker') {
        sidebarFile = 'broker_sidebar.html';
    }
    // For other roles (admin, landlord, user) use default sidebar
    
    try {
        const response = await fetch(sidebarFile);
        if (!response.ok) {
            throw new Error('Failed to load sidebar: ' + response.status);
        }
        const html = await response.text();
        document.getElementById('sidebar-container').innerHTML = html;
        
        // Setup logout button
        setupLogoutButton();
        
        console.log(`âœ… Loaded sidebar: ${sidebarFile} for role: ${userRole}`);
    } catch (error) {
        console.error('Error loading sidebar:', error);
        // Fallback to default sidebar
        try {
            const fallbackResponse = await fetch('sidebar.html');
            const fallbackHtml = await fallbackResponse.text();
            document.getElementById('sidebar-container').innerHTML = fallbackHtml;
            setupLogoutButton();
        } catch (fallbackError) {
            console.error('Failed to load fallback sidebar:', fallbackError);
            document.getElementById('sidebar-container').innerHTML = 
                '<div class="sidebar" style="padding: 20px; background: var(--bg-light); color: #ef4444;">' +
                '<p>Unable to load navigation. Please refresh the page.</p>' +
                '</div>';
        }
    }
}

// Function to get user role from Firebase authentication
async function getUserRole(userId) {
    try {
        // Initialize Firebase if not already done
        if (!window.firebaseApp) {
            // Check if firebase is available
            if (typeof firebase === 'undefined') {
                return 'user'; // Default role
            }
        }
        
        // Try to get user from auth
        const auth = firebase.auth();
        const currentUser = auth.currentUser;
        
        if (currentUser) {
            // You might need to fetch user role from Firestore
            // This is a placeholder - you'll need to implement based on your setup
            return 'user';
        }
        
    } catch (error) {
        console.error("Error getting user role:", error);
    }
    return 'user'; // Default role
}

// Load sidebar on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Try to get user role from localStorage or other storage
    let userRole = localStorage.getItem('userRole') || 'user';
    
    // Load sidebar
    await loadSidebarBasedOnRole(userRole);
});
</script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc,
  collection,
  query,
  where,
  getDocs,
  Timestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
  authDomain: "bahai-1b76d.firebaseapp.com",
  projectId: "bahai-1b76d",
  storageBucket: "bahai-1b76d.firebasestorage.app",
  messagingSenderId: "646878644941",
  appId: "1:646878644941:web:5b4ccc3412250337587784"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Make signOut available globally for the logout button
window.performLogout = async function() {
    try {
        await signOut(auth);
        window.location.href = "login.html";
    } catch (error) {
        console.error("Logout error:", error);
        alert("Error logging out. Please try again.");
    }
};

// Global variables
let currentUser = null;
let currentProperties = [];
let currentAgentId = null;

// ==================== PAGE INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  console.log("Agent profile page loaded");
  
  // Get agent ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const agentIdFromUrl = urlParams.get('id');
  
  if (!agentIdFromUrl) {
    showToast('No agent ID specified. Redirecting to agents list.', 'error');
    setTimeout(() => {
      window.location.href = 'list_agent.html';
    }, 2000);
    return;
  }
  
  currentAgentId = agentIdFromUrl;
  updateDebugInfo(`Agent ID from URL: ${agentIdFromUrl}`);
  loadAgentProfile(agentIdFromUrl);
});

// ==================== PROFILE FUNCTIONS ====================
async function loadAgentProfile(agentId) {
  try {
    showLoading();
    console.log("Loading profile for agent ID:", agentId);
    updateDebugInfo(`Loading profile for agent ID: ${agentId}`);
    
    let profileData = null;
    
    // Try agents collection first (primary)
    try {
      const agentDoc = await getDoc(doc(db, "agents", agentId));
      if (agentDoc.exists()) {
        const data = agentDoc.data();
        console.log("âœ… Loaded from agents collection:", data);
        updateDebugInfo(`âœ… Found in agents collection: ${Object.keys(data).join(', ')} fields`);
        profileData = { ...data, id: agentId };
      } else {
        console.log("âŒ No document found in agents collection");
        updateDebugInfo("âŒ No document found in agents collection");
      }
    } catch (error) {
      console.log("Error loading from agents:", error.message);
      updateDebugInfo(`âŒ Error loading from agents: ${error.message}`);
    }
    
    // If still no data, try users collection
    if (!profileData || Object.keys(profileData).length === 0) {
      try {
        const userDoc = await getDoc(doc(db, "users", agentId));
        if (userDoc.exists()) {
          const data = userDoc.data();
          console.log("âœ… Loaded from users collection:", data);
          updateDebugInfo(`âœ… Found in users collection: userType=${data.userType}, role=${data.role}`);
          
          // Check if this looks like an agent profile
          if (data.userType === 'agent' || data.role === 'agent' || data.title || data.agentId) {
            profileData = { ...data, id: agentId };
            updateDebugInfo("âœ… User is an agent profile");
          } else {
            updateDebugInfo("âŒ User is not an agent profile");
          }
        } else {
          console.log("âŒ No document found in users collection");
          updateDebugInfo("âŒ No document found in users collection");
        }
      } catch (error) {
        console.log("Error loading from users:", error.message);
        updateDebugInfo(`âŒ Error loading from users: ${error.message}`);
      }
    }
    
    // Display profile
    if (profileData && Object.keys(profileData).length > 0) {
      console.log("âœ… Displaying agent profile data:", profileData);
      updateDebugInfo(`âœ… Profile loaded: ${profileData.fullName || profileData.displayName || 'Unknown'}`);
      displayAgentProfile(profileData);
      
      // Load properties - FIXED: Using same logic as profile_agent.html
      await loadAgentProperties(agentId);
      
      // Load broker info if agent has a broker
      if (profileData.brokerId) {
        updateDebugInfo(`ðŸ”— Agent has broker: ${profileData.brokerId}`);
        await loadBrokerInfo(profileData.brokerId);
      } else {
        updateDebugInfo("â„¹ï¸ Agent has no broker");
      }
      
      hideLoading();
      return profileData;
      
    } else {
      console.log("âŒ No profile data found");
      updateDebugInfo("âŒ No profile data found for this ID");
      hideLoading();
      displayEmptyProfile();
      showToast('Agent profile not found or not set up yet.', 'error');
      return null;
    }
    
  } catch (error) {
    console.error('âŒ Error loading agent profile:', error);
    updateDebugInfo(`âŒ Error: ${error.message}`);
    hideLoading();
    showToast('Error loading profile. Please try again.', 'error');
    displayEmptyProfile();
    return null;
  }
}

function displayAgentProfile(agent) {
  console.log("Displaying agent profile:", agent);
  updateDebugInfo(`ðŸ‘¤ Displaying: ${agent.fullName || agent.name || 'Unknown'}`);
  
  // Extract data with fallbacks
  const fullName = agent.fullName || agent.displayName || agent.name || 'Agent';
  const title = agent.title || agent.role || agent.profession || 'Real Estate Agent';
  const location = agent.location || agent.city || agent.address || 'Location not specified';
  const email = agent.email || 'Not provided';
  const phone = agent.phone || agent.phoneNumber || agent.contactNumber || 'Not provided';
  const yearsExperience = agent.yearsExperience || agent.experienceYears || 0;
  const bio = agent.bio || agent.description || agent.about || '';
  const agentId = agent.agentId || agent.agentCode || 'Not assigned';
  const languages = agent.languages || agent.spokenLanguages || 'Not specified';
  const availability = agent.availability || 'Not specified';
  const workingHours = agent.workingHours || agent.preferredHours || 'Not specified';
  const website = agent.website || (agent.socialMedia && agent.socialMedia.website) || '';
  
  // Status
  const status = agent.status || 'active';
  
  // Photos - check multiple field names
  const photoURL = agent.photoURL || agent.profilePhoto || agent.profileImage || agent.imageURL || '';
  
  console.log('Photo URLs:', { photoURL });
  
  // Update basic info
  document.getElementById('agentName').textContent = fullName;
  document.getElementById('agentTitle').textContent = title;
  document.getElementById('agentLocation').textContent = location;
  
  // Years experience
  if (yearsExperience > 0) {
    document.getElementById('yearsExperience').textContent = ` â€¢ ${yearsExperience} years experience`;
    document.getElementById('yearsExpCount').textContent = yearsExperience;
  } else {
    document.getElementById('yearsExpCount').textContent = '0';
  }
  
  // Update bio
  const bioElement = document.getElementById('agentBio');
  const aboutElement = document.getElementById('agentAbout');
  if (bio.trim()) {
    bioElement.innerHTML = `<p>${bio}</p>`;
    aboutElement.innerHTML = `<p>${bio.replace(/\n/g, '</p><p>')}</p>`;
  } else {
    bioElement.innerHTML = `<p class="no-data">No bio information provided.</p>`;
    aboutElement.innerHTML = `<p class="no-data">No about information provided.</p>`;
  }
  
  // Update contact info
  document.getElementById('contactEmail').textContent = email;
  document.getElementById('contactPhone').textContent = phone;
  document.getElementById('contactLocation').textContent = location;
  document.getElementById('contactAvailability').textContent = availability;
  document.getElementById('workingHours').textContent = workingHours;
  document.getElementById('agentId').textContent = agentId;
  document.getElementById('languagesSpoken').textContent = languages;
  // Setup contact buttons
  setupContactButtons(email, phone, agent.socialMedia);
  
  // Update specializations
  updateTagsSection('propertyTypes', agent.propertyTypes);
  updateTagsSection('serviceAreas', agent.serviceAreas);
  
  // Update agent skills
  updateAgentSkills(agent.agentSkills || agent.skills);
  
  // Update photos
  updateProfilePhoto(photoURL, fullName);
  
  // Update social links
  updateSocialLinks(agent.socialMedia);
  
  // Update website
  updateWebsiteLink(website);
  
  // Update member since
  updateMemberSince(agent.createdAt || agent.joinedDate || agent.dateCreated || agent.lastUpdated);
  
  // Update stats
  updateAgentStats(agent);
  
  // Update badges
  updateProfileBadges(agent);
}

function setupContactButtons(email, phone, socialMedia) {
  const contactBtn = document.getElementById('contactBtn');
  const callBtn = document.getElementById('callBtn');
  const whatsappBtn = document.getElementById('whatsappBtn');
  const viberBtn = document.getElementById('viberBtn');
  
  // Email button
  if (email && email !== 'Not provided') {
    contactBtn.href = `mailto:${email}?subject=Inquiry about working with you`;
    contactBtn.style.display = 'inline-flex';
  } else {
    contactBtn.style.display = 'none';
  }
  
  // Call button
  if (phone && phone !== 'Not provided') {
    const cleanPhone = phone.replace(/\D/g, '');
    callBtn.href = `tel:${cleanPhone}`;
    callBtn.style.display = 'inline-flex';
  } else {
    callBtn.style.display = 'none';
  }
  
  // WhatsApp button
  let whatsappNumber = '';
  if (socialMedia && socialMedia.whatsapp) {
    whatsappNumber = socialMedia.whatsapp.replace(/\D/g, '');
  } else if (phone && phone !== 'Not provided') {
    whatsappNumber = phone.replace(/\D/g, '');
  }
  
  if (whatsappNumber) {
    whatsappBtn.href = `https://wa.me/${whatsappNumber}`;
    whatsappBtn.style.display = 'inline-flex';
  } else {
    whatsappBtn.style.display = 'none';
  }
  
  // Viber button
  let viberNumber = '';
  if (socialMedia && socialMedia.viber) {
    viberNumber = socialMedia.viber.replace(/\D/g, '');
  } else if (phone && phone !== 'Not provided') {
    viberNumber = phone.replace(/\D/g, '');
  }
  
  if (viberNumber) {
    viberBtn.href = `viber://chat?number=${viberNumber}`;
    viberBtn.style.display = 'inline-flex';
  } else {
    viberBtn.style.display = 'none';
  }
}

function updateTagsSection(containerId, data) {
  const container = document.getElementById(containerId);
  let items = [];
  
  if (data) {
    if (Array.isArray(data)) {
      items = data;
    } else if (typeof data === 'string' && data.trim()) {
      items = data.split(',').map(item => item.trim());
    }
  }
  
  if (items.length > 0) {
    container.innerHTML = items
      .map(item => `<span class="tag ${containerId === 'propertyTypes' ? 'tag-primary' : ''}">${item}</span>`)
      .join('');
  } else {
    container.innerHTML = '<span class="tag no-data">Not specified</span>';
  }
}

function updateAgentSkills(skills) {
  const container = document.getElementById('agentSkills');
  let skillItems = [];
  
  if (skills) {
    if (Array.isArray(skills)) {
      skillItems = skills;
    } else if (typeof skills === 'string' && skills.trim()) {
      skillItems = skills.split(',').map(skill => skill.trim());
    }
  }
  
  if (skillItems.length > 0) {
    container.innerHTML = skillItems
      .map(skill => `
        <div class="skill-item">
          <i class="fas fa-check-circle"></i>
          <span>${skill}</span>
        </div>
      `)
      .join('');
  } else {
    container.innerHTML = '<span class="no-data" style="grid-column: 1 / -1;">No skills specified</span>';
  }
}

function updateProfilePhoto(photoURL, fullName) {
  console.log("Updating profile photo:", { photoURL, fullName });
  
  const profilePhotoContainer = document.getElementById('profilePhoto');
  const placeholder = document.getElementById('profilePhotoPlaceholder');
  
  if (photoURL) {
    // Create image
    const img = document.createElement('img');
    img.src = photoURL;
    img.alt = fullName;
    img.onerror = function() {
      // On error, show placeholder with initial
      this.style.display = 'none';
      placeholder.textContent = fullName.charAt(0).toUpperCase();
      placeholder.style.display = 'flex';
    };
    
    // Clear container and add image
    profilePhotoContainer.innerHTML = '';
    profilePhotoContainer.appendChild(img);
    
    // Hide placeholder
    placeholder.style.display = 'none';
  } else {
    // Show placeholder with initial
    placeholder.textContent = fullName.charAt(0).toUpperCase();
    placeholder.style.display = 'flex';
    
    // Remove any existing image
    const existingImg = profilePhotoContainer.querySelector('img');
    if (existingImg) {
      existingImg.remove();
    }
  }
}

async function loadBrokerInfo(brokerId) {
  try {
    console.log("Loading broker info:", brokerId);
    updateDebugInfo(`ðŸ” Loading broker info: ${brokerId}`);
    
    let brokerData = null;
    
    // Try users collection first (where brokers are usually stored)
    try {
      const userDoc = await getDoc(doc(db, "users", brokerId));
      if (userDoc.exists()) {
        const data = userDoc.data();
        if (data.userType === 'broker') {
          brokerData = data;
          updateDebugInfo(`âœ… Found broker in users collection: ${data.fullName || data.name}`);
        }
      }
    } catch (error) {
      console.log("Error loading from users:", error);
      updateDebugInfo(`âŒ Error loading broker from users: ${error.message}`);
    }
    
    // Try brokers collection if needed
    if (!brokerData) {
      try {
        const brokerDoc = await getDoc(doc(db, "brokers", brokerId));
        if (brokerDoc.exists()) {
          brokerData = brokerDoc.data();
          updateDebugInfo(`âœ… Found broker in brokers collection: ${brokerData.fullName || brokerData.name}`);
        }
      } catch (error) {
        console.log("Error loading from brokers:", error);
        updateDebugInfo(`âŒ Error loading broker from brokers: ${error.message}`);
      }
    }
    
    if (brokerData) {
      displayBrokerInfo(brokerData, brokerId);
      updateDebugInfo(`âœ… Broker info displayed: ${brokerData.fullName || brokerData.name}`);
    } else {
      updateDebugInfo("âŒ No broker data found");
    }
    
  } catch (error) {
    console.error('Error loading broker info:', error);
    updateDebugInfo(`âŒ Error loading broker info: ${error.message}`);
  }
}

function displayBrokerInfo(brokerData, brokerId) {
  const brokerSection = document.getElementById('brokerSection');
  const brokerInfo = document.getElementById('brokerInfo');
  
  if (!brokerData) {
    brokerSection.style.display = 'none';
    return;
  }
  
  brokerSection.style.display = 'block';
  
  const brokerName = brokerData.fullName || brokerData.displayName || brokerData.name || 'Broker';
  const brokerTitle = brokerData.title || brokerData.role || 'Real Estate Broker';
  const brokerCompany = brokerData.company || '';
  const brokerEmail = brokerData.email || '';
  const brokerPhone = brokerData.phone || brokerData.phoneNumber || '';
  
  brokerInfo.innerHTML = `
    <div class="broker-info-header">
      <i class="fas fa-user-tie"></i>
      <div>
        <div class="broker-name">${brokerName}</div>
        <div class="broker-details">${brokerTitle}${brokerCompany ? ` â€¢ ${brokerCompany}` : ''}</div>
      </div>
    </div>
    ${brokerEmail ? `<div style="margin: 8px 0; font-size: 14px;"><strong>Email:</strong> ${brokerEmail}</div>` : ''}
    ${brokerPhone ? `<div style="margin: 8px 0; font-size: 14px;"><strong>Phone:</strong> ${brokerPhone}</div>` : ''}
    <div class="broker-actions">
      <a href="profile.html?id=${brokerId}" class="action-btn btn-outline" style="font-size: 13px; padding: 8px 16px;">
        <i class="fas fa-eye"></i> View Broker Profile
      </a>
    </div>
  `;
  
  // Add broker-affiliated badge
  const badgesContainer = document.getElementById('profileBadges');
  if (!badgesContainer.querySelector('.badge-broker-affiliated')) {
    badgesContainer.innerHTML += '<span class="profile-badge badge-broker-affiliated">Broker Affiliated</span>';
  }
}

function updateSocialLinks(socialMedia) {
  const container = document.getElementById('socialLinks');
  container.innerHTML = '';
  
  if (!socialMedia || typeof socialMedia !== 'object') {
    container.innerHTML = '<p class="no-data" style="width: 100%; text-align: center;">No social media links available</p>';
    return;
  }
  
  const platforms = [
    { key: 'facebook', icon: 'fab fa-facebook-f', url: 'https://facebook.com/' },
    { key: 'instagram', icon: 'fab fa-instagram', url: 'https://instagram.com/' },
    { key: 'linkedin', icon: 'fab fa-linkedin-in', url: 'https://linkedin.com/in/' },
    { key: 'whatsapp', icon: 'fab fa-whatsapp', url: 'https://wa.me/' },
    { key: 'viber', icon: 'fab fa-viber', url: 'viber://chat?number=' }
  ];
  
  let hasLinks = false;
  
  platforms.forEach(platform => {
    const username = socialMedia[platform.key];
    if (username && username.trim()) {
      hasLinks = true;
      const link = document.createElement('a');
      
      // Special handling for WhatsApp and Viber
      if (platform.key === 'whatsapp' || platform.key === 'viber') {
        const cleanNumber = username.replace(/\D/g, '');
        link.href = `${platform.url}${cleanNumber}`;
      } else {
        link.href = `${platform.url}${username.trim()}`;
      }
      
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.className = `social-link social-${platform.key}`;
      link.innerHTML = `<i class="${platform.icon}"></i>`;
      container.appendChild(link);
    }
  });
  
  // Add website if available
  if (socialMedia.website && socialMedia.website.trim()) {
    hasLinks = true;
    const link = document.createElement('a');
    link.href = socialMedia.website.startsWith('http') ? socialMedia.website : `https://${socialMedia.website}`;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    link.className = 'social-link social-globe';
    link.innerHTML = '<i class="fas fa-globe"></i>';
    link.title = 'Website/Portfolio';
    container.appendChild(link);
  }
  
  if (!hasLinks) {
    container.innerHTML = '<p class="no-data" style="width: 100%; text-align: center;">No social media links available</p>';
  }
}

function updateWebsiteLink(website) {
  const websiteLink = document.getElementById('contactWebsite');
  const noWebsite = document.getElementById('noWebsite');
  
  if (website && website.trim()) {
    let url = website.trim();
    if (!url.startsWith('http')) {
      url = 'https://' + url;
    }
    websiteLink.href = url;
    websiteLink.textContent = new URL(url).hostname.replace('www.', '');
    websiteLink.style.display = 'inline';
    noWebsite.style.display = 'none';
  } else {
    websiteLink.style.display = 'none';
    noWebsite.style.display = 'inline';
  }
}

function updateMemberSince(dateString) {
  const element = document.getElementById('memberSince');
  
  if (dateString) {
    try {
      let date;
      if (dateString.toDate && typeof dateString.toDate === 'function') {
        // Handle Firebase Timestamp
        date = dateString.toDate();
      } else {
        // Handle regular date string
        date = new Date(dateString);
      }
      
      if (!isNaN(date.getTime())) {
        element.textContent = date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long' 
        });
        return;
      }
    } catch (e) {
      console.log("Error parsing date:", e);
    }
  }
  
  element.textContent = 'N/A';
}

function updateAgentStats(agent) {
  // Properties count updated when properties load
  document.getElementById('yearsExpCount').textContent = agent.yearsExperience || agent.experienceYears || 0;
  document.getElementById('clientsCount').textContent = agent.clientsServed || agent.totalClients || '0';
  document.getElementById('successRate').textContent = agent.successRate ? `${agent.successRate}%` : '0%';
}

function updateProfileBadges(agent) {
  const badgesContainer = document.getElementById('profileBadges');
  badgesContainer.innerHTML = '';
  
  // Add agent badge
  badgesContainer.innerHTML += '<span class="profile-badge badge-agent">Agent</span>';
  
  // Add active badge
  const status = agent.status || 'active';
  if (status === 'active') {
    badgesContainer.innerHTML += '<span class="profile-badge badge-active">Active</span>';
  } else if (status === 'pending') {
    badgesContainer.innerHTML += '<span class="profile-badge badge-pending">Pending</span>';
  }
  
  // Add verified badge if applicable
  if (agent.verified || agent.isVerified) {
    badgesContainer.innerHTML += '<span class="profile-badge badge-verified">Verified</span>';
  }
  
  // Add broker-affiliated badge if agent has a broker
  if (agent.brokerId) {
    badgesContainer.innerHTML += '<span class="profile-badge badge-broker-affiliated">Broker Affiliated</span>';
  }
}

// ==================== PROPERTIES FUNCTIONS - FIXED VERSION ====================
async function loadAgentProperties(agentId) {
  try {
    console.log("ðŸ” Loading properties for agent:", agentId);
    updateDebugInfo(`=== ðŸ  LOADING PROPERTIES FOR AGENT ${agentId} ===\n`);
    
    currentProperties = [];
    let debugMessages = [];
    
    // Try multiple possible queries (same as profile_agent.html)
    const queries = [
      // Query 1: Properties where agentId matches
      query(collection(db, "properties"), where("agentId", "==", agentId)),
      // Query 2: Properties where userId matches
      query(collection(db, "properties"), where("userId", "==", agentId)),
      // Query 3: Properties where listedBy matches
      query(collection(db, "properties"), where("listedBy", "==", agentId))
    ];
    
    debugMessages.push("ðŸ” Trying multiple queries to find agent properties...");
    
    for (const q of queries) {
      try {
        const snapshot = await getDocs(q);
        debugMessages.push(`âœ… Query found ${snapshot.length} properties`);
        
        snapshot.forEach(docItem => {
          // Avoid duplicates
          if (!currentProperties.find(p => p.id === docItem.id)) {
            const data = docItem.data();
            currentProperties.push({ 
              id: docItem.id, 
              ...data,
              isAgentProperty: true
            });
            debugMessages.push(`   - Found: ${data.title || 'Untitled'} (ID: ${docItem.id})`);
            debugMessages.push(`     Status: ${data.status || 'unknown'}, Type: ${data.type || 'unknown'}`);
            if (data.agentId) debugMessages.push(`     Agent ID in property: ${data.agentId}`);
          }
        });
      } catch (error) {
        debugMessages.push(`âŒ Query error: ${error.message}`);
      }
    }
    
    // Check if agent has personalProperties array in their document
    try {
      const agentDoc = await getDoc(doc(db, "agents", agentId));
      if (agentDoc.exists()) {
        const agentData = agentDoc.data();
        
        // Check for personalProperties array
        if (agentData.personalProperties && Array.isArray(agentData.personalProperties)) {
          debugMessages.push(`ðŸ“‹ Found ${agentData.personalProperties.length} properties in agent's personalProperties array`);
          
          for (const propertyId of agentData.personalProperties) {
            if (!currentProperties.find(p => p.id === propertyId)) {
              try {
                const propertyDoc = await getDoc(doc(db, "properties", propertyId));
                if (propertyDoc.exists()) {
                  currentProperties.push({ 
                    id: propertyId, 
                    ...propertyDoc.data(),
                    isAgentProperty: true
                  });
                  debugMessages.push(`   - Loaded from personalProperties array: ${propertyId}`);
                }
              } catch (error) {
                debugMessages.push(`   - Error loading property ${propertyId}: ${error.message}`);
              }
            }
          }
        }
      }
    } catch (error) {
      debugMessages.push(`âŒ Error checking agent document: ${error.message}`);
    }
    
    // Update debug info
    debugMessages.push(`\nðŸ“Š FINAL RESULTS:`);
    debugMessages.push(`âœ… TOTAL AGENT PROPERTIES FOUND: ${currentProperties.length}`);
    
    if (currentProperties.length > 0) {
      debugMessages.push(`\nðŸ“‹ Properties Found:`);
      currentProperties.forEach(prop => {
        debugMessages.push(`   â€¢ ${prop.title || 'Untitled'} (ID: ${prop.id})`);
        debugMessages.push(`     Type: ${prop.type || 'sale'}, Status: ${prop.status || 'unknown'}`);
        if (prop.agentId) debugMessages.push(`     Agent ID in property: ${prop.agentId}`);
        if (prop.userId) debugMessages.push(`     User ID: ${prop.userId}`);
        if (prop.listedBy) debugMessages.push(`     Listed By: ${prop.listedBy}`);
        debugMessages.push(``);
      });
    } else {
      debugMessages.push(`\nâŒ No properties found for this agent`);
      debugMessages.push(`   Possible reasons:`);
      debugMessages.push(`   â€¢ Agent hasn't added any properties yet`);
      debugMessages.push(`   â€¢ Properties are assigned to a different agent ID`);
      debugMessages.push(`   â€¢ Database structure may be different`);
    }
    
    const allDebugMessages = debugMessages.join('\n');
    updateDebugInfo(allDebugMessages);
    
    // Update properties count
    document.getElementById('propertiesCount').textContent = currentProperties.length;
    
    // Display properties
    if (currentProperties.length > 0) {
      displayPropertiesGrid(currentProperties);
      setupPropertyFilter();
      
      // Show view all button if there are more than 6 properties
      if (currentProperties.length > 6) {
        document.getElementById('viewAllBtn').style.display = 'inline-flex';
        document.getElementById('viewAllBtn').onclick = function(e) {
          e.preventDefault();
          displayPropertiesGrid(currentProperties);
          this.style.display = 'none';
        };
      }
    } else {
      showNoPropertiesMessage();
    }
    
  } catch (error) {
    console.error('âŒ Error loading agent properties:', error);
    updateDebugInfo(`âŒ Error loading agent properties: ${error.message}\n${error.stack}`);
    showNoPropertiesMessage();
  }
}

// Display properties grid
function displayPropertiesGrid(properties) {
  const grid = document.getElementById('propertiesGrid');
  grid.innerHTML = '';
  
  if (properties.length === 0) {
    showNoPropertiesMessage();
    return;
  }
  
  properties.forEach(property => {
    const card = createPropertyCard(property);
    grid.appendChild(card);
  });
}

function createPropertyCard(property) {
  const card = document.createElement('div');
  card.className = 'property-card';
  
  // Extract data with proper fallbacks
  const status = property.status || 'available';
  const price = property.price || property.salePrice || property.monthlyRent || property.annualRent || property.rent || 0;
  const title = property.title || property.name || property.propertyName || 'Untitled Property';
  const location = property.address || property.location || property.city || property.area || 'Location not specified';
  const bedrooms = property.bedrooms || property.bedroom || property.beds || 0;
  const bathrooms = property.bathrooms || property.bathroom || property.baths || 0;
  const area = property.floorArea || property.totalArea || property.area || property.lotArea || property.size || 0;
  const images = property.imageUrls || property.photos || property.images || property.image || [];
  const imageUrl = Array.isArray(images) && images.length > 0 ? images[0] : (typeof images === 'string' ? images : '');
  const listingType = property.type || property.listingType || property.category || 'sale';
  const propertyType = property.propertyType || property.propertyCategory || 'residential';
  
  // Format price
  let priceText = 'Price on request';
  if (price > 0) {
    const formattedPrice = parseFloat(price).toLocaleString();
    if (listingType === 'rent' || listingType === 'rental') {
      priceText = `â‚±${formattedPrice}/month`;
    } else if (listingType === 'lease') {
      priceText = `â‚±${formattedPrice}/year`;
    } else {
      priceText = `â‚±${formattedPrice}`;
    }
  }
  
  // Status text and class
  let statusText = status.charAt(0).toUpperCase() + status.slice(1);
  let statusClass = `status-${status}`;
  
  if (status === 'available') {
    if (listingType === 'rent' || listingType === 'rental') {
      statusText = 'For Rent';
      statusClass = 'status-available';
    } else if (listingType === 'lease') {
      statusText = 'For Lease';
      statusClass = 'status-available';
    } else if (listingType === 'sale') {
      statusText = 'For Sale';
      statusClass = 'status-available';
    }
  } else if (status === 'rented' || status === 'leased') {
    statusClass = 'status-rented';
    statusText = status === 'leased' ? 'Leased' : 'Rented';
  } else if (status === 'sold') {
    statusClass = 'status-sold';
    statusText = 'Sold';
  } else if (status === 'pending') {
    statusClass = 'status-pending';
    statusText = 'Pending';
  }
  
  // Create property image or placeholder
  let imageContent = '';
  if (imageUrl && imageUrl.trim() !== '') {
    imageContent = `<img src="${imageUrl}" alt="${title}" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%230b2e52%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22>ðŸ </text></svg>'">`;
  } else {
    imageContent = `<div style="width:100%;height:100%;background:linear-gradient(135deg, var(--primary), var(--primary-light));display:flex;align-items:center;justify-content:center;color:white;">
      <i class="fas fa-home fa-3x"></i>
    </div>`;
  }
  
  card.innerHTML = `
    <div class="property-image">
      ${imageContent}
      <div class="property-status ${statusClass}">${statusText}</div>
    </div>
    <div class="property-content">
      <div class="property-header">
        <div>
          <h3 class="property-title">${title}</h3>
          <div class="property-location">
            <i class="fas fa-map-marker-alt"></i>
            <span>${location}</span>
          </div>
        </div>
        <div class="property-price">${priceText}</div>
      </div>
      <div class="property-features">
        ${bedrooms > 0 ? `<div class="feature">
          <i class="fas fa-bed"></i>
          <span>${bedrooms} bed${bedrooms !== 1 ? 's' : ''}</span>
        </div>` : ''}
        ${bathrooms > 0 ? `<div class="feature">
          <i class="fas fa-bath"></i>
          <span>${bathrooms} bath${bathrooms !== 1 ? 's' : ''}</span>
        </div>` : ''}
        ${area > 0 ? `<div class="feature">
          <i class="fas fa-ruler-combined"></i>
          <span>${area.toLocaleString()} sqm</span>
        </div>` : ''}
        ${propertyType ? `<div class="feature">
          <i class="fas fa-building"></i>
          <span>${propertyType.charAt(0).toUpperCase() + propertyType.slice(1)}</span>
        </div>` : ''}
      </div>
    </div>
  `;
  
  card.addEventListener('click', function() {
    if (property.id) {
      window.location.href = `property_details.html?id=${property.id}`;
    }
  });
  
  return card;
}

function setupPropertyFilter() {
  const filter = document.getElementById('propertyFilter');
  
  filter.addEventListener('change', function() {
    const value = this.value;
    let filtered = currentProperties;
    
    if (value === 'available') {
      filtered = currentProperties.filter(p => p.status === 'available');
    } else if (value === 'sold') {
      filtered = currentProperties.filter(p => p.status === 'sold');
    } else if (value === 'rented') {
      filtered = currentProperties.filter(p => p.status === 'rented' || p.status === 'leased');
    } else if (value === 'rent') {
      filtered = currentProperties.filter(p => 
        (p.type === 'rent' || p.type === 'rental' || p.listingType === 'rent') &&
        (p.status === 'available')
      );
    } else if (value === 'sale') {
      filtered = currentProperties.filter(p => 
        (p.type === 'sale' || p.listingType === 'sale') &&
        (p.status === 'available')
      );
    } else if (value === 'lease') {
      filtered = currentProperties.filter(p => 
        (p.type === 'lease' || p.listingType === 'lease') &&
        (p.status === 'available')
      );
    }
    
    displayPropertiesGrid(filtered);
    
    // Hide view all button when filtering
    document.getElementById('viewAllBtn').style.display = 'none';
  });
}

function showNoPropertiesMessage() {
  const grid = document.getElementById('propertiesGrid');
  
  grid.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ </div>
      <h3>No Properties Listed Yet</h3>
      <p>This agent hasn't listed any properties yet.</p>
      <p style="font-size: 14px; color: var(--text-light); margin-top: 10px;">
        <i class="fas fa-info-circle"></i> Check the debug panel above for detailed information
      </p>
    </div>
  `;
}

// ==================== UTILITY FUNCTIONS ====================
function displayEmptyProfile() {
  document.getElementById('agentName').textContent = 'Profile Not Found';
  document.getElementById('agentTitle').textContent = '';
  document.getElementById('agentBio').innerHTML = '<p class="no-data">This profile could not be loaded.</p>';
  document.getElementById('agentAbout').innerHTML = '<p class="no-data">This profile could not be loaded.</p>';
  document.getElementById('contactBtn').style.display = 'none';
  document.getElementById('callBtn').style.display = 'none';
  document.getElementById('whatsappBtn').style.display = 'none';
  document.getElementById('viberBtn').style.display = 'none';
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showLoading() {
  // Loading is handled by the loading state in the properties grid
}

function hideLoading() {
  const loadingState = document.querySelector('.loading-state');
  if (loadingState) {
    loadingState.style.display = 'none';
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Add CSS for debug panel
  const style = document.createElement('style');
  style.textContent = `
    .debug-panel {
      font-family: 'Courier New', monospace;
      line-height: 1.4;
    }
    .debug-panel strong {
      color: #0b2e52;
    }
  `;
  document.head.appendChild(style);
});
</script>
</body>
</html>