<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agent Profile - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="../buyer/style.css">
<style>
    /* Agent Profile - same design as broker (navy + gold) */
    :root {
      --primary: #0b2e52;
      --primary-gradient: linear-gradient(135deg, #0b2e52 0%, #1e3a5f 100%);
      --primary-light: #1e3a5f;
      --primary-dark: #071e38;
      --secondary-gradient: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      --accent-gradient: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      --premium-gradient: linear-gradient(135deg, #0b2e52 0%, #1e3a5f 100%);
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      --card-hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
      --border-radius: 16px;
      --border-radius-sm: 12px;
      --border-radius-lg: 24px;
      --text-dark: #1a202c;
      --text-light: #718096;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --premium: #0b2e52;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--text-dark);
      display: flex;
      min-height: 100vh;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--premium-gradient);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
    }

    .container {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    .page-header {
      margin-bottom: 30px;
    }
    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 10px;
      line-height: 1.2;
    }
    .page-header p {
      color: var(--text-light);
      font-size: 16px;
    }

    /* Profile Header - same as broker (navy + gold) */
    .profile-header {
      background: var(--bg-white);
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      border-top: 5px solid var(--premium);
    }

    .profile-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .profile-header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .profile-badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .profile-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-agent {
      background: var(--premium-gradient);
      color: white;
    }

    .badge-broker-affiliated {
      background: var(--accent-gradient);
      color: white;
    }

    .badge-active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .badge-verified {
      background: var(--accent-gradient);
      color: white;
    }

    .badge-available {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .profile-main {
      display: flex;
      align-items: flex-start;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .profile-main {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
    }

    .profile-photo {
      width: 160px;
      height: 160px;
      border-radius: 16px;
      overflow: hidden;
      border: 4px solid var(--bg-white);
      box-shadow: var(--shadow-lg);
      flex-shrink: 0;
      border-color: var(--premium);
    }

    .profile-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-photo-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--premium-gradient);
      color: white;
      font-size: 60px;
      font-weight: bold;
    }

    .profile-details {
      flex: 1;
    }

    .profile-name {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 5px;
    }

    .profile-title {
      font-size: 18px;
      color: var(--premium);
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .profile-title i {
      color: #d4af37;
    }

    .profile-location {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-light);
      margin-bottom: 15px;
      font-size: 16px;
    }

    .profile-location i {
      color: #d4af37;
    }

    .profile-bio {
      line-height: 1.6;
      color: var(--text-dark);
      margin-bottom: 20px;
      font-style: italic;
      max-width: 800px;
    }

    /* Agent Specific Info */
    .agent-info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 15px;
    }

    .agent-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: var(--text-dark);
    }

    .agent-info-item i {
      color: #d4af37;
      width: 20px;
    }

    /* Broker Affiliated - who agent works under */
    .broker-info-container {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      margin-top: 20px;
      border: 1px solid rgba(11, 46, 82, 0.2);
    }

    .broker-info-header {
      font-weight: 600;
      color: var(--premium);
      margin-bottom: 10px;
      font-size: 16px;
    }

    .broker-info-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .broker-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--premium-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      overflow: hidden;
      flex-shrink: 0;
    }

    .broker-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .broker-details {
      flex: 1;
    }

    .broker-name {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 5px;
    }

    .broker-company {
      font-size: 14px;
      color: var(--text-light);
    }

    .no-broker {
      color: var(--text-light);
      font-style: italic;
    }

    /* Profile Actions - same as broker */
    .profile-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      border: none;
      font-family: inherit;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary {
      background: var(--premium-gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(11, 46, 82, 0.35);
    }

    .btn-secondary {
      background: white;
      color: var(--text-dark);
      border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-outline:hover {
      background: var(--premium);
      color: white;
      transform: translateY(-2px);
    }

    .btn-accent {
      background: var(--accent-gradient);
      color: white;
    }

    .btn-accent:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }

    /* Profile Content Grid */
    .profile-content {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
    }

    @media (max-width: 1024px) {
      .profile-content {
        grid-template-columns: 1fr;
      }
    }

    /* Card Styles - same as broker */
    .profile-card {
      background: var(--bg-white);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
      border-top: 3px solid var(--premium);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .section-header i {
      font-size: 22px;
      color: var(--premium);
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-dark);
    }

    /* Tags Container - same as broker */
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .tag {
      background: var(--bg-light);
      color: var(--text-dark);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--border);
    }

    .tag-primary {
      background: var(--premium-gradient);
      color: white;
      border: none;
    }

    .tag-skill {
      background: rgba(11, 46, 82, 0.08);
      color: var(--premium);
      border: 1px solid rgba(11, 46, 82, 0.2);
    }

    /* Contact List - same as broker */
    .contact-list {
      list-style: none;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid var(--border);
    }

    .contact-item:last-child {
      border-bottom: none;
    }

    .contact-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(11, 46, 82, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--premium);
      font-size: 18px;
    }

    .contact-details {
      flex: 1;
    }

    .contact-label {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 3px;
    }

    .contact-value {
      font-weight: 500;
      color: var(--text-dark);
      word-break: break-all;
    }

    /* Social Links */
    .social-links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .social-link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--bg-light);
      color: var(--text-dark);
      font-size: 18px;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .social-link:hover {
      transform: translateY(-3px);
      color: white;
    }

    .social-facebook:hover { background: #1877F2; }
    .social-twitter:hover { background: #1DA1F2; }
    .social-linkedin:hover { background: #0077B5; }
    .social-instagram:hover { background: #E4405F; }
    .social-whatsapp:hover { background: #25D366; }
    .social-viber:hover { background: #7360F2; }

    /* Properties Section */
    .properties-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .properties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 30px;
      margin-top: 25px;
    }

    @media (max-width: 768px) {
      .properties-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Listing cards - same as agent dashboard */
    .listing-card-wrapper {
      transition: all 0.3s ease;
    }
    .listing-card-wrapper:hover {
      transform: translateY(-5px);
    }
    .listing-card {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      cursor: pointer;
    }
    .listing-card:hover {
      box-shadow: var(--card-hover-shadow);
    }
    .listing-card-image-container {
      position: relative;
      height: 220px;
      overflow: hidden;
    }
    .listing-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    .listing-card:hover .listing-image {
      transform: scale(1.05);
    }
    .listing-type-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: white;
      z-index: 2;
    }
    .listing-type-badge.rent, .listing-type-badge.lease {
      background: #10b981;
    }
    .listing-type-badge.sale {
      background: #3b82f6;
    }
    .listing-content {
      padding: 25px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .listing-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 12px;
    }
    .listing-header > div:first-child {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    .listing-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-dark);
      line-height: 1.35;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .listing-price {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-dark);
      white-space: normal;
      word-break: break-word;
      text-align: right;
      min-width: fit-content;
      flex-shrink: 0;
      max-width: 45%;
    }
    .listing-location {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 14px;
    }
    .listing-location-text {
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }
    .listing-details {
      display: flex;
      gap: 16px;
      margin-bottom: 14px;
      padding-bottom: 14px;
      border-bottom: 1px solid #e5e7eb;
    }
    .detail {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-light);
      font-size: 0.9rem;
    }
    .listing-broker {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--bg-light);
      border-radius: 8px;
      margin-top: auto;
    }
    .listing-broker .broker-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--premium-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }
    .listing-broker .broker-info {
      flex: 1;
      min-width: 0;
    }
    .listing-broker .broker-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .listing-broker .broker-contact {
      font-size: 12px;
      color: var(--text-light);
    }
    .card-link-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      opacity: 0;
      cursor: pointer;
    }

    /* Loading State - same as broker */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
      background: var(--bg-white);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }

    .spinner {
      border: 4px solid rgba(11, 46, 82, 0.2);
      border-top: 4px solid #d4af37;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
      color: var(--premium);
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    /* Toast Notification - same as broker */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--premium-gradient);
      color: white;
      padding: 14px 24px;
      border-radius: var(--border-radius-sm);
      z-index: 10000;
      font-weight: 600;
      box-shadow: var(--card-hover-shadow);
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast-success {
      background: var(--success);
    }

    .toast-error {
      background: var(--danger);
    }

    @keyframes slideIn {
      from { transform: translateX(-50%) translateY(100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(-50%) translateY(0); opacity: 1; }
      to { transform: translateX(-50%) translateY(100%); opacity: 0; }
    }

    /* Incomplete Profile Banner - same as broker */
    .incomplete-banner {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid rgba(139, 69, 19, 0.3);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }

    .incomplete-banner-content {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }

    .incomplete-banner i {
      color: var(--primary);
      font-size: 24px;
    }

    .incomplete-banner p {
      color: var(--primary);
      font-weight: 500;
    }

    /* No Data Placeholder */
    .no-data {
      color: var(--text-light);
      font-style: italic;
      padding: 10px 0;
    }

    /* Filter Select */
    .filter-select {
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      background: var(--bg-white);
      color: var(--text-dark);
      cursor: pointer;
      min-width: 200px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--premium);
      box-shadow: 0 0 0 3px rgba(11, 46, 82, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .container {
        margin-left: 0;
        padding: 25px;
      }
      
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .page-header h1 {
        font-size: 24px;
      }
      
      .profile-photo {
        width: 120px;
        height: 120px;
      }
      
      .profile-name {
        font-size: 24px;
      }
      
      .profile-actions {
        flex-direction: column;
        width: 100%;
      }
      
      .action-btn {
        width: 100%;
        justify-content: center;
      }
      
      .properties-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-select {
        width: 100%;
      }
      
      .agent-info-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .broker-info-content {
        flex-direction: column;
        text-align: center;
      }
    }
</style>
</head>
<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Main Content -->
<div class="container">
  <!-- Page Header - same structure as broker -->
  <div class="page-header" style="margin-bottom: 25px;">
    <h1 id="pageTitle">Agent Profile</h1>
    <p id="pageSubtitle">Manage your agent profile and listings</p>
    <a href="agent_dashboard.html" id="backButton" class="action-btn btn-secondary" style="margin-top: 15px; display: inline-flex;">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Incomplete Profile Banner (hidden by default) -->
  <div id="incompleteBanner" class="incomplete-banner" style="display: none;">
    <div class="incomplete-banner-content">
      <i class="fas fa-exclamation-circle"></i>
      <p>Your profile is incomplete. Complete your profile to attract more brokers and clients.</p>
    </div>
    <a href="agent_edit_profile.html" id="completeProfileLink" class="action-btn btn-primary">
      <i class="fas fa-edit"></i> Complete Profile
    </a>
  </div>

  <!-- Profile Content -->
  <div id="profileContent" class="profile-content-section">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-header-top">
        <div class="profile-badges" id="profileBadges">
          <!-- Only Broker Affiliated badge when applicable -->
        </div>
        <div class="profile-header-actions" id="profileHeaderActions">
          <!-- Edit Profile button added by JavaScript for own profile -->
        </div>
      </div>

      <div class="profile-main">
        <!-- Profile Photo -->
        <div class="profile-photo" id="profilePhoto">
          <div class="profile-photo-placeholder" id="profilePhotoPlaceholder">
            <!-- Initial will be added by JavaScript -->
          </div>
        </div>

        <!-- Profile Details -->
        <div class="profile-details">
          <h1 class="profile-name" id="agentName">Loading...</h1>
          <div class="profile-title" id="agentTitle">
            <i class="fas fa-user-tie"></i>
            <span>Real Estate Agent</span>
          </div>
          <div class="profile-location">
            <i class="fas fa-map-marker-alt"></i>
            <span id="agentLocation">Location not specified</span>
            <span id="yearsExperience"></span>
          </div>
          
          <!-- Agent Specific Info Row -->
          <div class="agent-info-row">
            <div class="agent-info-item" id="agentAvailability">
              <i class="fas fa-clock"></i>
              <span>Availability: <span id="availabilityText">Not specified</span></span>
            </div>
            <div class="agent-info-item" id="agentWorkingHours">
              <i class="fas fa-briefcase"></i>
              <span>Working Hours: <span id="workingHoursText">Flexible</span></span>
            </div>
          </div>
          
          <div class="profile-bio" id="agentBio">
            <p class="no-data">No bio information provided.</p>
          </div>

          <!-- Broker Info (if applicable) -->
          <div id="brokerInfo" style="display: none;">
            <div class="broker-info-container">
              <div class="broker-info-header">Working Under Broker</div>
              <div class="broker-info-content">
                <div class="broker-avatar" id="brokerAvatar">
                  <!-- Broker avatar will be added by JavaScript -->
                </div>
                <div class="broker-details">
                  <div class="broker-name" id="brokerName">Loading broker...</div>
                  <div class="broker-company" id="brokerCompany"></div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Profile Content -->
    <div class="profile-content">
      <!-- Left Column -->
      <div class="left-column">
        <!-- About Section -->
        <div class="profile-card">
          <div class="section-header">
            <i class="fas fa-user-tie"></i>
            <h2>Professional Profile</h2>
          </div>
          <div class="about-content" id="agentAbout">
            <p class="no-data">No about information provided.</p>
          </div>
        </div>

        <!-- Specializations Section -->
        <div class="profile-card">
          <div class="section-header">
            <i class="fas fa-star"></i>
            <h2>Specializations</h2>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px; color: var(--text-dark); font-size: 16px; font-weight: 600;">Property Types</h3>
            <div class="tags-container" id="propertyTypes">
              <span class="tag no-data">Not specified</span>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px; color: var(--text-dark); font-size: 16px; font-weight: 600;">Service Areas</h3>
            <div class="tags-container" id="serviceAreas">
              <span class="tag no-data">Not specified</span>
            </div>
          </div>
          
          <div>
            <h3 style="margin-bottom: 10px; color: var(--text-dark); font-size: 16px; font-weight: 600;">Agent Skills</h3>
            <div class="tags-container" id="agentSkills">
              <span class="tag no-data">Not specified</span>
            </div>
          </div>
        </div>

        <!-- Properties Section -->
        <div class="profile-card">
          <div class="properties-header">
            <div class="section-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 0;">
              <i class="fas fa-home"></i>
              <h2>Properties</h2>
            </div>
            <div>
              <select id="propertyFilter" class="filter-select">
                <option value="all">All Properties</option>
                <option value="available">Available</option>
                <option value="sold">Sold</option>
                <option value="rent">For Rent</option>
                <option value="sale">For Sale</option>
              </select>
            </div>
          </div>
          
          <div class="properties-grid" id="propertiesGrid">
            <!-- Loading State -->
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Loading properties...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Contact Information -->
        <div class="profile-card">
          <div class="section-header">
            <i class="fas fa-address-card"></i>
            <h2>Contact Information</h2>
          </div>
          <ul class="contact-list">
            <li class="contact-item">
              <div class="contact-icon">
                <i class="fas fa-envelope"></i>
              </div>
              <div class="contact-details">
                <div class="contact-label">Email</div>
                <div class="contact-value" id="contactEmail">Not provided</div>
              </div>
            </li>
            <li class="contact-item">
              <div class="contact-icon">
                <i class="fas fa-phone"></i>
              </div>
              <div class="contact-details">
                <div class="contact-label">Phone</div>
                <div class="contact-value" id="contactPhone">Not provided</div>
              </div>
            </li>
            <li class="contact-item">
              <div class="contact-icon">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div class="contact-details">
                <div class="contact-label">Office Location</div>
                <div class="contact-value" id="contactLocation">Not provided</div>
              </div>
            </li>
            <li class="contact-item">
              <div class="contact-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="contact-details">
                <div class="contact-label">Availability / Hours</div>
                <div class="contact-value" id="contactAvailability">Not specified</div>
              </div>
            </li>
            <li class="contact-item">
              <div class="contact-icon">
                <i class="fas fa-globe"></i>
              </div>
              <div class="contact-details">
                <div class="contact-label">Website</div>
                <a href="#" class="contact-value" id="contactWebsite" target="_blank" style="color: var(--premium); text-decoration: none; display: none;">Visit Website</a>
                <span id="noWebsite" class="no-data">Not provided</span>
              </div>
            </li>
          </ul>
        </div>

        <!-- Professional Details -->
        <div class="profile-card">
          <div class="section-header">
            <i class="fas fa-briefcase"></i>
            <h2>Professional Details</h2>
          </div>
          <div class="professional-details">
            <div style="margin-bottom: 15px;">
              <div class="contact-label">Agent ID</div>
              <div class="contact-value" id="agentId">Not provided</div>
            </div>
            <div style="margin-bottom: 15px;">
              <div class="contact-label">Languages Spoken</div>
              <div class="contact-value" id="languagesSpoken">Not specified</div>
            </div>
            <div>
              <div class="contact-label">Member Since</div>
              <div class="contact-value" id="memberSince">N/A</div>
            </div>
          </div>
        </div>

        <!-- Social Media -->
        <div class="profile-card">
          <div class="section-header">
            <i class="fas fa-share-alt"></i>
            <h2>Connect</h2>
          </div>
          <div class="social-links" id="socialLinks">
            <p class="no-data" style="width: 100%; text-align: center;">No social media links available</p>
          </div>
        </div>

        <!-- Quick Actions - for own profile -->
        <div class="profile-card" id="quickActionsCard" style="display: none;">
          <div class="section-header">
            <i class="fas fa-bolt"></i>
            <h2>Quick Actions</h2>
          </div>
          <div class="profile-actions" style="flex-direction: column; gap: 10px;">
            <a href="agent_add_property.html" class="action-btn btn-primary">
              <i class="fas fa-plus"></i> Add New Property
            </a>
            <a href="agent_listings.html" class="action-btn btn-secondary">
              <i class="fas fa-list"></i> My Listings
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sidebar Loader Script -->
<script src="../sidebar-user.js"></script>
<script>
// Mobile menu functionality
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.style.transform = sidebar.style.transform === 'translateX(0px)' ? 
            'translateX(-100%)' : 'translateX(0px)';
    }
});

// Load sidebar
fetch('sidebar.html')
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load sidebar: ' + response.status);
        }
        return response.text();
    })
    .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;
        // Highlight active link - adjust based on user type
        const links = document.querySelectorAll('.sidebar-link');
        links.forEach(link => {
            if (link.getAttribute('href') === 'agent_dashboard.html') {
                link.classList.add('active');
            }
        });
        // Setup logout button
        setupLogoutButton();
    })
    .catch(error => {
        console.error('Error loading sidebar:', error);
        document.getElementById('sidebar-container').innerHTML = 
            '<div class="sidebar" style="padding: 20px; background: var(--bg-light); color: #ef4444;">' +
            '<p>Unable to load navigation. Please refresh the page.</p>' +
            '</div>';
    });

// Simple logout function (will be overridden by the main script)
function setupLogoutButton() {
    const logoutBtn = document.getElementById("logoutBtn");
    if (!logoutBtn) {
        console.warn("Logout button not found, retrying...");
        setTimeout(setupLogoutButton, 100);
        return;
    }

    // Remove existing event listeners
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

    // Add new event listener
    newLogoutBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (confirm("Are you sure you want to log out?")) {
            // Check if performLogout function exists (from main script)
            if (typeof window.performLogout === 'function') {
                window.performLogout();
            } else {
                // Fallback to simple redirect
                window.location.href = "login.html";
            }
        }
    });

    console.log('Logout button initialized successfully');
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
  authDomain: "bahai-1b76d.firebaseapp.com",
  projectId: "bahai-1b76d",
  storageBucket: "bahai-1b76d.firebasestorage.app",
  messagingSenderId: "646878644941",
  appId: "1:646878644941:web:5b4ccc3412250337587784"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Global variables
let currentUser = null;
let isOwnProfile = false;
let currentProperties = [];
let currentProfileId = null;
let userType = 'agent';

// ==================== PAGE INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  console.log("Agent Profile page loaded");
  
  // First check for profile ID in URL
  const urlParams = new URLSearchParams(window.location.search);
  const profileIdFromUrl = urlParams.get('id');
  
  // Check authentication status
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      console.log("User authenticated:", user.uid);
      
      // Determine profile ID
      let profileId = profileIdFromUrl || user.uid;
      currentProfileId = profileId;
      
      // Check if viewing own profile
      isOwnProfile = (profileId === user.uid);
      console.log("Is own profile:", isOwnProfile);
      
      // Load appropriate sidebar based on who's viewing
      await loadSidebarBasedOnViewer(user, isOwnProfile);
      
      // Update page title
      updatePageTitle(isOwnProfile);
      
      // Load agent profile
      await loadAgentProfile(profileId);
      
    } else {
      console.log("No user authenticated");
      
      // If no profile ID in URL, redirect to login
      if (!profileIdFromUrl) {
        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
        return;
      }
      
      // Load public profile
      currentProfileId = profileIdFromUrl;
      updatePageTitle(false);
      
      // For public view, use default sidebar
      await loadSidebarBasedOnViewer(null, false);
      
      // Load agent profile
      await loadAgentProfile(profileIdFromUrl);
    }
  });
});

// Load agent profile for sidebar (agents collection first, then users)
async function loadAgentProfileForSidebar(user) {
  if (!user || typeof window.updateSidebarUserProfile !== 'function') return;
  try {
    const agentDoc = await getDoc(doc(db, "agents", user.uid));
    if (agentDoc.exists()) {
      const d = agentDoc.data();
      window.updateSidebarUserProfile({
        fullName: d.fullName || d.name || d.displayName,
        displayName: d.fullName || d.name || d.displayName,
        email: user.email || d.email,
        role: d.userType || d.role || 'agent'
      });
      return;
    }
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      const d = userDoc.data();
      window.updateSidebarUserProfile({
        fullName: d.fullName || d.name || d.displayName,
        displayName: d.fullName || d.name || d.displayName,
        email: user.email || d.email,
        role: d.userType || d.role || 'agent'
      });
      return;
    }
    window.updateSidebarUserProfile({
      fullName: user.displayName,
      displayName: user.displayName,
      email: user.email,
      role: 'agent'
    });
  } catch (e) {
    console.warn('Could not load agent profile:', e);
    window.updateSidebarUserProfile({
      fullName: user.displayName,
      email: user.email,
      role: 'agent'
    });
  }
}

// Load sidebar based on who's viewing the profile
async function loadSidebarBasedOnViewer(user, isOwnProfile) {
  let sidebarFile = 'sidebar.html'; // Default for public view
  
  if (user) {
    if (isOwnProfile) {
      // Agent viewing own profile
      sidebarFile = 'agent_sidebar.html';
    } else {
      // Someone else viewing agent profile
      sidebarFile = 'sidebar.html';
    }
  }
  
  console.log("Loading sidebar:", sidebarFile);
  
  try {
    const response = await fetch(sidebarFile);
    if (!response.ok) {
      throw new Error(`Failed to load sidebar: ${response.status}`);
    }
    const html = await response.text();
    document.getElementById('sidebar-container').innerHTML = html;
    
    // Update sidebar with agent profile when agent views own profile
    if (user && isOwnProfile) {
      await loadAgentProfileForSidebar(user);
    }
    
    // Highlight active link
    highlightActiveSidebarLink();
    
    // Setup logout button if it exists
    setupLogoutButton();
    
  } catch (error) {
    console.error('Error loading sidebar:', error);
    // Fallback to default sidebar
    await loadDefaultSidebar();
  }
}

// Load default sidebar
async function loadDefaultSidebar() {
  try {
    const response = await fetch('sidebar.html');
    const html = await response.text();
    document.getElementById('sidebar-container').innerHTML = html;
    highlightActiveSidebarLink();
    setupLogoutButton();
  } catch (fallbackError) {
    console.error('Failed to load fallback sidebar:', fallbackError);
    document.getElementById('sidebar-container').innerHTML = 
      '<div class="sidebar" style="padding: 20px; background: var(--bg-light); color: #ef4444;">' +
      '<p>Unable to load navigation. Please refresh the page.</p>' +
      '</div>';
  }
}

// Highlight active sidebar link
function highlightActiveSidebarLink() {
  const links = document.querySelectorAll('.sidebar-link');
  links.forEach(link => {
    // Remove active class from all links
    link.classList.remove('active');
    
    // Check if this link points to a profile page
    const href = link.getAttribute('href') || '';
    if (href.includes('profile.html') || 
        href.includes('agent_profile') || 
        href.includes('profile_agent')) {
      link.classList.add('active');
    }
  });
}

function updatePageTitle(isOwnProfile) {
  const title = document.getElementById('pageTitle');
  const subtitle = document.getElementById('pageSubtitle');
  
  if (isOwnProfile) {
    title.textContent = 'My Agent Profile';
    subtitle.textContent = 'Manage your agent profile and listings';
  } else {
    title.textContent = 'Agent Profile';
    subtitle.textContent = 'View agent profile and listings';
  }
}

// Update back button
function updateBackButton() {
  const backButton = document.getElementById('backButton');
  if (!backButton) return;
  
  if (isOwnProfile) {
    backButton.href = 'agent_dashboard.html';
    console.log("Back button set to agent dashboard");
  } else {
    backButton.href = 'index.html';
    console.log("Back button set to home (viewing other profile)");
  }
}

// ==================== AGENT PROFILE FUNCTIONS ====================
async function loadAgentProfile(agentId) {
  try {
    console.log("Loading agent profile for ID:", agentId);
    
    showLoading();

    // Always fetch from Firestore first (agents collection) for fresh data from agent_edit_profile
    let profileData = await loadAgentProfileFromFirestore(agentId);

    // Display profile
    if (profileData && Object.keys(profileData).length > 0) {
      console.log("Displaying agent profile data:", profileData);
      displayAgentProfile(profileData);

      // Load agent properties
      await loadAgentProperties(agentId);

      // Check profile completeness (only for own profile)
      if (isOwnProfile) {
        checkProfileCompleteness(profileData);
        addEditProfileButton(profileData);
      }

      hideLoading();
      updateBackButton();
      return profileData;

    } else {
      console.log("No agent profile data found");
      hideLoading();

      if (isOwnProfile) {
        showToast('No agent profile found. Please complete your agent profile setup.', 'error');

        setTimeout(() => {
          window.location.href = 'agent_profile_setup.html';
        }, 2000);
      } else {
        displayEmptyProfile();
        showToast('Agent profile not found or not set up yet.', 'error');
      }

      return null;
    }

  } catch (error) {
    console.error('Error loading agent profile:', error);
    hideLoading();
    showToast('Error loading agent profile. Please try again.', 'error');
    displayEmptyProfile();
    return null;
  }
}

async function loadAgentProfileFromFirestore(agentId) {
  let profileData = null;
  
  // Try agents collection first (where edit profile saves data)
  try {
    const agentDoc = await getDoc(doc(db, "agents", agentId));
    if (agentDoc.exists()) {
      const data = agentDoc.data();
      console.log("Loaded from agents collection:", data);
      profileData = { ...data, id: agentId, userType: 'agent' };
      
      // Update localStorage
      localStorage.setItem(`agent_${agentId}`, JSON.stringify(profileData));
    }
  } catch (error) {
    console.log("Error loading from agents:", error.message);
  }
  
  // If still no data, try users collection
  if (!profileData || Object.keys(profileData).length === 0) {
    try {
      const userDoc = await getDoc(doc(db, "users", agentId));
      if (userDoc.exists()) {
        const data = userDoc.data();
        console.log("Loaded from users collection:", data);
        
        // Check if this looks like an agent profile
        if (data.userType === 'agent' || data.userRole === 'agent') {
          profileData = { ...data, id: agentId, userType: 'agent' };
          
          // Update localStorage
          localStorage.setItem(`agent_${agentId}`, JSON.stringify(profileData));
        }
      }
    } catch (error) {
      console.log("Error loading from users:", error.message);
    }
  }
  
  // Merge Firebase Auth user data as fallback when viewing own profile
  if (currentUser && agentId === currentUser.uid && profileData) {
    const authPhoto = currentUser.photoURL;
    if (!profileData.photoURL && authPhoto) {
      profileData.photoURL = authPhoto;
    }
    if (!profileData.profilePhoto && (profileData.photoURL || authPhoto)) {
      profileData.profilePhoto = profileData.photoURL || authPhoto;
    }
    if (!profileData.profileImage && (profileData.photoURL || authPhoto)) {
      profileData.profileImage = profileData.photoURL || authPhoto;
    }
    if (!profileData.email && currentUser.email) {
      profileData.email = currentUser.email;
    }
    if (!profileData.fullName && !profileData.displayName && currentUser.displayName) {
      profileData.fullName = profileData.displayName = currentUser.displayName;
    }
  }
  
  return profileData;
}

function displayAgentProfile(profile) {
  console.log("Displaying agent profile:", profile);
  
  // Extract common data with fallbacks
  const fullName = profile.fullName || profile.displayName || profile.name || 'Agent';
  const title = profile.title || profile.role || profile.profession || 'Real Estate Agent';
  const location = profile.location || profile.city || profile.address || 'Location not specified';
  const email = profile.email || 'Not provided';
  const phone = profile.phone || profile.phoneNumber || profile.contactNumber || 'Not provided';
  const yearsExperience = profile.yearsExperience || profile.experienceYears || 0;
  const bio = profile.bio || profile.description || profile.about || '';
  const agentId = profile.agentId || profile.agentID || 'Not provided';
  const languages = profile.languages || profile.spokenLanguages || 'Not specified';
  const availability = profile.availability || 'Not specified';
  const workingHours = profile.workingHours || profile.preferredHours || 'Flexible';
  const website = profile.website || (profile.socialMedia && profile.socialMedia.website) || '';
  
  // Photos - check multiple field names
  const photoURL = profile.photoURL || profile.profilePhoto || profile.profileImage || profile.imageURL || '';
  
  console.log('Agent Photo URL:', photoURL);
  
  // Update basic info
  document.getElementById('agentName').textContent = fullName;
  const titleEl = document.getElementById('agentTitle');
  if (titleEl) titleEl.innerHTML = `<i class="fas fa-user-tie"></i><span>${title}</span>`;
  document.getElementById('agentLocation').textContent = location;
  
  // Years experience
  if (yearsExperience > 0) {
    document.getElementById('yearsExperience').textContent = ` • ${yearsExperience} years experience`;
  } else {
    document.getElementById('yearsExperience').textContent = '';
  }
  
  // Update agent specific info
  document.getElementById('availabilityText').textContent = availability;
  document.getElementById('workingHoursText').textContent = workingHours;
  // Update bio
  const bioElement = document.getElementById('agentBio');
  const aboutElement = document.getElementById('agentAbout');
  if (bio.trim()) {
    bioElement.innerHTML = `<p>${bio}</p>`;
    aboutElement.innerHTML = `<p>${bio.replace(/\n/g, '</p><p>')}</p>`;
  } else {
    const placeholderText = isOwnProfile 
      ? `Add a bio to tell brokers and clients about your experience and expertise.`
      : 'No bio information provided.';
    bioElement.innerHTML = `<p class="no-data">${placeholderText}</p>`;
    aboutElement.innerHTML = `<p class="no-data">${placeholderText}</p>`;
  }
  
  // Update contact info
  document.getElementById('contactEmail').textContent = email;
  document.getElementById('contactPhone').textContent = phone;
  document.getElementById('contactLocation').textContent = location;
  document.getElementById('contactAvailability').textContent = 
    (workingHours && workingHours !== 'Flexible') ? workingHours : availability;
  document.getElementById('agentId').textContent = agentId;
  document.getElementById('languagesSpoken').textContent = languages;
  
  // Update specializations
  updateTagsSection('propertyTypes', profile.propertyTypes);
  updateTagsSection('serviceAreas', profile.serviceAreas);
  updateAgentSkills(profile.agentSkills || profile.skills || []);
  
  // Update photos
  updateProfilePhoto(photoURL, fullName);
  
  // Update social links
  updateSocialLinks(profile.socialMedia);
  
  // Update website
  updateWebsiteLink(website);
  
  // Update member since
  updateMemberSince(profile.createdAt || profile.joinedDate || profile.dateCreated);
  
  // Update badges based on agent status
  updateAgentBadges(profile);
  
  // Update broker info if applicable (kept - who agent is affiliated with)
  updateBrokerInfo(profile);
  
  // Show Quick Actions for own profile
  const quickActionsCard = document.getElementById('quickActionsCard');
  if (quickActionsCard) quickActionsCard.style.display = isOwnProfile ? 'block' : 'none';
  
}

function updateTagsSection(containerId, data) {
  const container = document.getElementById(containerId);
  const items = ensureArray(data);
  
  if (items.length > 0) {
    container.innerHTML = items
      .map(item => `<span class="tag tag-primary">${item}</span>`)
      .join('');
  } else {
    container.innerHTML = isOwnProfile 
      ? `<span class="tag" style="border-style: dashed; opacity: 0.7;"><i class="fas fa-plus"></i> Add ${containerId.replace(/([A-Z])/g, ' $1').toLowerCase()}</span>`
      : '<span class="tag no-data">Not specified</span>';
  }
}

function updateAgentSkills(skills) {
  const container = document.getElementById('agentSkills');
  const items = ensureArray(skills);
  
  if (items.length > 0) {
    container.innerHTML = items
      .map(skill => `<span class="tag tag-skill">${skill}</span>`)
      .join('');
  } else {
    container.innerHTML = isOwnProfile 
      ? `<span class="tag" style="border-style: dashed; opacity: 0.7;"><i class="fas fa-plus"></i> Add skills</span>`
      : '<span class="tag no-data">Not specified</span>';
  }
}

function ensureArray(data) {
  if (!data) return [];
  if (Array.isArray(data)) return data;
  if (typeof data === 'string') return data.split(',').map(item => item.trim());
  return [String(data)];
}

function updateProfilePhoto(photoURL, fullName) {
  console.log("Updating agent profile photo:", { photoURL, fullName });
  
  const profilePhotoContainer = document.getElementById('profilePhoto');
  const placeholder = document.getElementById('profilePhotoPlaceholder');
  
  if (!profilePhotoContainer || !placeholder) return;
  
  const initial = (fullName || 'A').charAt(0).toUpperCase();
  
  if (photoURL) {
    // Remove any existing image first
    const existingImg = profilePhotoContainer.querySelector('img');
    if (existingImg) existingImg.remove();
    
    const img = document.createElement('img');
    img.src = photoURL;
    img.alt = fullName;
    img.onerror = function() {
      // On error: remove broken image, show placeholder with initial
      this.remove();
      placeholder.textContent = initial;
      placeholder.style.display = 'flex';
    };
    
    profilePhotoContainer.appendChild(img);
    placeholder.textContent = initial;
    placeholder.style.display = 'none';
  } else {
    placeholder.textContent = initial;
    placeholder.style.display = 'flex';
    
    const existingImg = profilePhotoContainer.querySelector('img');
    if (existingImg) existingImg.remove();
  }
}

function updateSocialLinks(socialMedia) {
  const container = document.getElementById('socialLinks');
  container.innerHTML = '';
  
  if (!socialMedia) {
    container.innerHTML = '<p class="no-data" style="width: 100%; text-align: center;">No social media links available</p>';
    return;
  }
  
  const platforms = [
    { key: 'facebook', icon: 'fab fa-facebook-f', url: 'https://facebook.com/' },
    { key: 'twitter', icon: 'fab fa-twitter', url: 'https://twitter.com/' },
    { key: 'linkedin', icon: 'fab fa-linkedin-in', url: 'https://linkedin.com/in/' },
    { key: 'instagram', icon: 'fab fa-instagram', url: 'https://instagram.com/' },
    { key: 'whatsapp', icon: 'fab fa-whatsapp', url: 'https://wa.me/' },
    { key: 'viber', icon: 'fab fa-viber', url: 'viber://chat?number=' }
  ];
  
  let hasLinks = false;
  
  platforms.forEach(platform => {
    const username = socialMedia[platform.key];
    if (username && username.trim()) {
      hasLinks = true;
      const link = document.createElement('a');
      
      // Special handling for WhatsApp and Viber
      if (platform.key === 'whatsapp' || platform.key === 'viber') {
        const cleanNumber = username.replace(/\D/g, '');
        link.href = `${platform.url}${cleanNumber}`;
      } else {
        link.href = `${platform.url}${username.trim()}`;
      }
      
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.className = `social-link social-${platform.key}`;
      link.innerHTML = `<i class="${platform.icon}"></i>`;
      container.appendChild(link);
    }
  });
  
  // Add website if available
  if (socialMedia.website && socialMedia.website.trim()) {
    hasLinks = true;
    const link = document.createElement('a');
    link.href = socialMedia.website.startsWith('http') ? socialMedia.website : `https://${socialMedia.website}`;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    link.className = 'social-link';
    link.innerHTML = '<i class="fas fa-globe"></i>';
    link.title = 'Website';
    container.appendChild(link);
  }
  
  if (!hasLinks) {
    container.innerHTML = '<p class="no-data" style="width: 100%; text-align: center;">No social media links available</p>';
  }
}

function updateWebsiteLink(website) {
  const websiteLink = document.getElementById('contactWebsite');
  const noWebsite = document.getElementById('noWebsite');
  
  if (website && website.trim()) {
    let url = website.trim();
    if (!url.startsWith('http')) {
      url = 'https://' + url;
    }
    websiteLink.href = url;
    websiteLink.textContent = new URL(url).hostname.replace('www.', '');
    websiteLink.style.display = 'inline';
    noWebsite.style.display = 'none';
  } else {
    websiteLink.style.display = 'none';
    noWebsite.style.display = 'inline';
  }
}

function updateMemberSince(dateString) {
  const element = document.getElementById('memberSince');
  
  if (dateString) {
    try {
      const date = new Date(dateString);
      if (!isNaN(date.getTime())) {
        element.textContent = date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long' 
        });
        return;
      }
    } catch (e) {
      console.log("Error parsing date:", e);
    }
  }
  
  element.textContent = 'N/A';
}

function updateAgentBadges(profile) {
  const badgesContainer = document.getElementById('profileBadges');
  badgesContainer.innerHTML = '';
  
  // Only show Broker Affiliated badge when agent has a broker
  if (profile.brokerId) {
    badgesContainer.innerHTML += '<span class="profile-badge badge-broker-affiliated">Broker Affiliated</span>';
  }
}

async function updateBrokerInfo(profile) {
  const brokerInfoContainer = document.getElementById('brokerInfo');
  const brokerAvatar = document.getElementById('brokerAvatar');
  const brokerName = document.getElementById('brokerName');
  const brokerCompany = document.getElementById('brokerCompany');
  
  if (profile.brokerId && profile.brokerId.trim()) {
    try {
      // Try to load broker data
      const brokerDoc = await getDoc(doc(db, "users", profile.brokerId));
      if (brokerDoc.exists()) {
        const brokerData = brokerDoc.data();
        
        // Update broker info
        brokerName.textContent = brokerData.fullName || brokerData.displayName || 'Broker';
        brokerCompany.textContent = brokerData.company || brokerData.title || 'Real Estate Broker';
        
        // Set broker avatar
        if (brokerData.photoURL) {
          brokerAvatar.innerHTML = `<img src="${brokerData.photoURL}" alt="${brokerData.fullName || 'Broker'}">`;
        } else {
          const initials = (brokerData.fullName || 'B').charAt(0).toUpperCase();
          brokerAvatar.innerHTML = `<span>${initials}</span>`;
        }
        
        // Make broker name clickable
        brokerName.style.cursor = 'pointer';
        brokerName.style.color = 'var(--primary)';
        brokerName.onclick = function() {
          window.location.href = `profile.html?id=${profile.brokerId}`;
        };
        
        brokerInfoContainer.style.display = 'block';
      } else {
        // Use profile broker data if available
        if (profile.brokerName) {
          brokerName.textContent = profile.brokerName;
          brokerCompany.textContent = profile.brokerCompany || 'Real Estate Broker';
          
          // Set broker avatar from profile
          const initials = profile.brokerName.charAt(0).toUpperCase();
          brokerAvatar.innerHTML = `<span>${initials}</span>`;
          
          brokerInfoContainer.style.display = 'block';
        } else {
          brokerInfoContainer.style.display = 'none';
        }
      }
    } catch (error) {
      console.log("Error loading broker info:", error);
      brokerInfoContainer.style.display = 'none';
    }
  } else {
    brokerInfoContainer.style.display = 'none';
  }
}

function addEditProfileButton(profile) {
  const container = document.getElementById('profileHeaderActions');
  if (!container || document.querySelector('.edit-profile-btn')) return;
  
  const editButton = document.createElement('a');
  editButton.className = 'action-btn btn-accent edit-profile-btn';
  editButton.innerHTML = '<i class="fas fa-edit"></i> Edit Profile';
  editButton.href = 'agent_edit_profile.html';
  
  container.appendChild(editButton);
}

function checkProfileCompleteness(profileData) {
  const requiredFields = ['fullName', 'title', 'location', 'phone', 'bio', 'photoURL'];
  const missingFields = requiredFields.filter(field => {
    const value = profileData[field];
    return !value || value === 'Not provided' || value === '';
  });
  
  if (missingFields.length > 2) {
    document.getElementById('incompleteBanner').style.display = 'flex';
  }
}

// ==================== PROPERTIES FUNCTIONS ====================
async function loadAgentProperties(agentId) {
  try {
    console.log("Loading properties for agent:", agentId);
    
    currentProperties = [];
    
    // Try multiple possible queries
    const queries = [
      // Query 1: Properties where agentId matches
      query(collection(db, "properties"), where("agentId", "==", agentId)),
      // Query 2: Properties where userId matches
      query(collection(db, "properties"), where("userId", "==", agentId)),
      // Query 3: Properties where listedBy matches
      query(collection(db, "properties"), where("listedBy", "==", agentId))
    ];
    
    for (const q of queries) {
      try {
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
          // Avoid duplicates
          if (!currentProperties.find(p => p.id === doc.id)) {
            currentProperties.push({ id: doc.id, ...doc.data() });
          }
        });
      } catch (error) {
        console.log("Query failed, continuing:", error.message);
      }
    }
    
    console.log(`Found ${currentProperties.length} properties for agent`);
    
    // Display properties
    if (currentProperties.length > 0) {
      displayProperties(currentProperties);
      setupPropertyFilter();
    } else {
      showNoPropertiesMessage();
    }
    
  } catch (error) {
    console.error('Error loading agent properties:', error);
    showNoPropertiesMessage();
  }
}

function displayProperties(properties) {
  const grid = document.getElementById('propertiesGrid');
  grid.innerHTML = '';
  
  if (properties.length === 0) {
    showNoPropertiesMessage();
    return;
  }
  
  properties.forEach(property => {
    const card = createPropertyCard(property);
    grid.appendChild(card);
  });
}

function createPropertyCard(property) {
  const wrapper = document.createElement('div');
  wrapper.className = 'listing-card-wrapper';
  
  // Extract data with proper fallbacks
  const title = property.title || property.name || 'Untitled Property';
  const location = property.address || property.location || property.city || 'Location not specified';
  const bedrooms = property.bedrooms || property.bedroom || 0;
  const bathrooms = property.bathrooms || property.bathroom || 0;
  const area = property.floorArea || property.totalArea || property.squareFootage || property.area || 0;
  const images = property.photos || property.images || property.imageUrls || [];
  const imageUrl = images.length > 0 ? images[0] : 'https://via.placeholder.com/400x200/0b2e52/white?text=No+Image';
  const rawType = (property.type || property.listingType || 'sale').toLowerCase();
  const listingTypeDisplay = rawType === 'sale' ? 'For Sale' : rawType === 'lease' ? 'For Lease' : 'For Rent';
  const badgeClass = (rawType === 'sale') ? 'sale' : 'rent';
  
  // Price
  let priceLabel = 'Price on request';
  if (rawType === 'sale') {
    const p = property.salePrice || property.price || 0;
    priceLabel = p > 0 ? `₱${parseFloat(p).toLocaleString()}` : priceLabel;
  } else if (rawType === 'lease' || rawType === 'rent') {
    const p = property.annualRent || property.monthlyRent || property.price || 0;
    const period = rawType === 'lease' ? '/year' : '/month';
    priceLabel = p > 0 ? `₱${parseFloat(p).toLocaleString()}${period}` : priceLabel;
  } else {
    const p = property.price || 0;
    priceLabel = p > 0 ? `₱${parseFloat(p).toLocaleString()}` : priceLabel;
  }
  
  const areaText = typeof area === 'number' ? `${area} sqm` : (area || 'N/A');
  
  wrapper.innerHTML = `
    <div class="listing-card" data-listing-id="${property.id || ''}">
      <a href="property_details.html?id=${property.id || ''}" class="card-link-overlay" aria-label="View ${title}"></a>
      <div class="listing-card-image-container">
        <span class="listing-type-badge ${badgeClass}">${listingTypeDisplay}</span>
        <img src="${imageUrl}" alt="${title}" class="listing-image" onerror="this.src='https://via.placeholder.com/400x200/0b2e52/white?text=No+Image'">
      </div>
      <div class="listing-content">
        <div class="listing-header">
          <div style="flex: 1; min-width: 0;">
            <h3 class="listing-title">${title}</h3>
          </div>
          <div class="listing-price">${priceLabel}</div>
        </div>
        <div class="listing-location">
          <span>📍</span>
          <div class="listing-location-text">
            ${location}
            <br><small>${listingTypeDisplay}</small>
          </div>
        </div>
        <div class="listing-details">
          <div class="detail">
            <span>🛏️</span> ${bedrooms} beds
          </div>
          <div class="detail">
            <span>🚿</span> ${bathrooms} baths
          </div>
          <div class="detail">
            <span>📐</span> ${areaText}
          </div>
        </div>
      </div>
    </div>
  `;
  
  return wrapper;
}

function setupPropertyFilter() {
  const filter = document.getElementById('propertyFilter');
  
  filter.addEventListener('change', function() {
    const value = this.value;
    let filtered = currentProperties;
    
    if (value === 'available') {
      filtered = currentProperties.filter(p => (p.status || 'active') === 'available');
    } else if (value === 'sold') {
      filtered = currentProperties.filter(p => (p.status || 'active') === 'sold');
    } else if (value === 'rent') {
      filtered = currentProperties.filter(p => 
        (p.type || p.listingType || '').toLowerCase() === 'rent' || 
        (p.type || p.listingType || '').toLowerCase() === 'lease'
      );
    } else if (value === 'sale') {
      filtered = currentProperties.filter(p => 
        (p.type || p.listingType || '').toLowerCase() === 'sale'
      );
    }
    
    displayProperties(filtered);
  });
}

function showNoPropertiesMessage() {
  const grid = document.getElementById('propertiesGrid');
  
  if (isOwnProfile) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🏠</div>
        <h3>No Properties Listed Yet</h3>
        <p>You haven't listed any properties yet. Start by adding your first property!</p>
        <a href="agent_add_property.html" class="action-btn btn-primary" style="margin-top: 20px; display: inline-flex;">
          <i class="fas fa-plus"></i> Add First Property
        </a>
      </div>
    `;
  } else {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🏠</div>
        <h3>No Properties Listed Yet</h3>
        <p>This agent hasn't listed any properties yet.</p>
      </div>
    `;
  }
}

// ==================== UTILITY FUNCTIONS ====================
function displayEmptyProfile() {
  document.getElementById('agentName').textContent = 'Agent Profile Not Found';
  const titleEl = document.getElementById('agentTitle');
  if (titleEl) titleEl.innerHTML = '<i class="fas fa-user-tie"></i><span>Real Estate Agent</span>';
  document.getElementById('agentBio').innerHTML = '<p class="no-data">This agent profile could not be loaded.</p>';
  document.getElementById('agentAbout').innerHTML = '<p class="no-data">This agent profile could not be loaded.</p>';
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showLoading() {
  // Loading is handled by the loading state in the properties grid
}

function hideLoading() {
  // Loading is handled by the loading state in the properties grid
}

// Make performLogout available globally
window.performLogout = async function() {
    try {
        await signOut(auth);
        window.location.href = "login.html";
    } catch (error) {
        console.error("Logout error:", error);
        alert("Error logging out. Please try again.");
    }
};
</script>
</body>
</html>