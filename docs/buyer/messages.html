<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Messages - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="style.css">
<style>
    /* Same design tokens as buyer dashboard */
    :root {
      --primary-gradient: linear-gradient(135deg, #0b2e52 0%, #667eea 100%);
      --primary-light: #667eea;
      --primary-dark: #764ba2;
      --secondary-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --accent-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      --card-hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
      --border-radius: 16px;
      --border-radius-sm: 12px;
      --border-radius-lg: 24px;
      --text-dark: #1a202c;
      --text-light: #718096;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border: #e5e7eb;
      --unread-bg: #eef2ff;
      --unread-border: rgba(102, 126, 234, 0.3);
      --message-sent: #e3f2fd;
      --message-received: #f5f5f5;
      --success: #10b981;
      --error: #ef4444;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Schedule message styles for sent/received */
.message-schedule.sent-schedule {
  align-self: flex-end;
  margin-left: auto;
  margin-right: 10px;
}

.message-schedule.received-schedule {
  align-self: flex-start;
  margin-right: auto;
  margin-left: 10px;
}

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--text-dark);
      display: flex;
      min-height: 100vh;
    }

    /* Mobile Menu Toggle - same as buyer dashboard */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--primary-gradient);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: var(--border-radius-sm);
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--card-hover-shadow);
    }

    .container {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    /* Hero Section - same as buyer dashboard */
    .hero-section {
      background: var(--primary-gradient);
      color: white;
      border-radius: var(--border-radius-lg);
      padding: 50px 40px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" fill="white"/></svg>');
      background-size: cover;
      opacity: 0.1;
    }
    .hero-section h1 {
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 15px;
      line-height: 1.2;
      max-width: 800px;
      position: relative;
      z-index: 1;
    }
    .hero-section p {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    .hero-actions {
      margin-top: 25px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    .refresh-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.4);
      padding: 14px 24px;
      border-radius: var(--border-radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .refresh-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .refresh-btn.refreshing {
      background: rgba(255,255,255,0.15);
      cursor: not-allowed;
      transform: none;
    }

    .messages-container {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 25px;
      height: calc(100vh - 180px);
      min-height: 600px;
    }

    /* Conversations List - same card style as dashboard */
    .conversations-sidebar {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .conversations-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    /* Schedule status message styles */
    .message-schedule {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      max-width: 85%;
      align-self: center;
    }

    .message-schedule.confirmed {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #10b981;
    }

    .message-schedule.declined {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-color: #ef4444;
    }

    .message-schedule.pending {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }

    .message-schedule.alternative {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border-color: #0ea5e9;
    }

    .schedule-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .schedule-header i {
      font-size: 18px;
    }

    .schedule-details {
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
    }

    .schedule-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
    }

    .schedule-info-label {
      color: var(--text-light);
      font-weight: 500;
    }

    .schedule-info-value {
      color: var(--text-dark);
      font-weight: 600;
    }

    .schedule-notes {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--border-radius-sm);
      border-left: 4px solid var(--primary-light);
    }

    .schedule-notes-label {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .schedule-notes-content {
      font-size: 13px;
      color: var(--text-dark);
    }

    .schedule-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .schedule-action-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.3s ease;
    }

    .schedule-action-btn.primary {
      background: var(--primary-gradient);
      color: white;
      border: none;
    }
    .schedule-action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    .schedule-action-btn.secondary {
      background: white;
      color: var(--text-dark);
      border: 2px solid #e5e7eb;
    }
    .schedule-action-btn.secondary:hover {
      border-color: var(--primary-light);
      background: #f9fafb;
      transform: translateY(-2px);
    }

    .schedule-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-confirmed {
      background: var(--secondary-gradient);
      color: white;
    }
    .status-pending {
      background: var(--accent-gradient);
      color: white;
    }
    .status-declined {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .status-alternative {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
    }

    .conversations-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }
    .conversations-header h2 i {
      color: var(--primary-light);
      font-size: 1.2rem;
    }

    .index-notice {
      background: #fff3cd;
      border: 1px solid #ffecb5;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #856404;
    }

    .index-notice a {
      color: var(--primary-light);
      font-weight: 600;
      text-decoration: underline;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .stat-value {
      font-weight: 700;
      color: var(--primary-light);
      font-size: 20px;
    }

    .stat-label {
      color: var(--text-light);
      font-size: 12px;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }

    .filter-btn {
      padding: 10px 18px;
      border: 2px solid #e5e7eb;
      background: white;
      color: var(--text-dark);
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .filter-btn:hover {
      border-color: var(--primary-light);
      background: #f9fafb;
    }
    .filter-btn.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    .conversations-search {
      position: relative;
    }

    .conversations-search input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
    }

    .conversations-search input:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .conversations-search i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    .conversation-item {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .conversation-item:hover {
      background: var(--bg-light);
    }

    .conversation-item.active {
      background: var(--unread-bg);
      border-left: 4px solid var(--primary-light);
    }

    .conversation-item.unread {
      background: var(--unread-bg);
    }

    .conversation-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .conversation-info {
      flex: 1;
      min-width: 0;
    }

    .conversation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }

    .conversation-name {
      font-weight: 600;
      color: var(--text-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-time {
      font-size: 12px;
      color: var(--text-light);
      white-space: nowrap;
    }

    .conversation-preview {
      font-size: 14px;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }

    .conversation-property {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--primary-light);
      background: rgba(102, 126, 234, 0.08);
      padding: 4px 8px;
      border-radius: var(--border-radius-sm);
      width: fit-content;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation-property i {
      font-size: 10px;
    }

    .conversation-badge {
      position: absolute;
      top: 16px;
      right: 20px;
      background: var(--secondary-gradient);
      color: white;
      font-size: 11px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
    }

    /* Delete button for conversations */
    .delete-conversation-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: all 0.2s ease;
    }

    .conversation-item:hover .delete-conversation-btn {
      opacity: 1;
    }

    .delete-conversation-btn:hover {
      background: var(--error);
      color: white;
      transform: scale(1.1);
    }

    /* Chat Container - same card style as dashboard */
    .chat-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-white);
      flex-wrap: wrap;
      gap: 15px;
    }

    .chat-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .chat-user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .chat-user-details {
      flex: 1;
      min-width: 0;
    }

    .chat-user-details h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-user-details p {
      font-size: 13px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-user-details p i {
      font-size: 11px;
    }

    .chat-property-info {
      background: var(--bg-light);
      padding: 12px 16px;
      border-radius: 10px;
      max-width: 300px;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-property-info:hover {
      background: white;
      box-shadow: var(--card-shadow);
    }

    .chat-property-info h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-property-info p {
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
    }

    .chat-property-price {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .chat-messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      background: var(--bg-light);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message-date {
      text-align: center;
      margin: 10px 0;
      position: relative;
    }

    .message-date span {
      background: var(--bg-white);
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-light);
      border: 1px solid var(--border);
    }

    .message-bubble {
      max-width: 65%;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-bubble.received {
      align-self: flex-start;
    }

    .message-bubble.sent {
      align-self: flex-end;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 14px;
    }

    .message-bubble.received .message-content {
      background: var(--message-received);
      border-bottom-left-radius: 4px;
      color: var(--text-dark);
    }

    .message-bubble.sent .message-content {
      background: var(--primary-gradient);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 4px;
      padding: 0 8px;
    }

    .message-bubble.sent .message-time {
      text-align: right;
      color: var(--text-light);
    }

    .message-bubble.received .message-time {
      text-align: left;
    }

    .typing-indicator {
      align-self: flex-start;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      background: var(--message-received);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      width: fit-content;
      margin-bottom: 10px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: var(--text-light);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .chat-input-container {
      padding: 20px 25px;
      border-top: 1px solid var(--border);
      background: var(--bg-white);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: var(--border-radius-sm);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      transition: all 0.3s ease;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .send-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    .send-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    .send-button:disabled {
      background: #e5e7eb;
      cursor: not-allowed;
      transform: none;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      text-align: center;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
    }

    .spinner {
      border: 4px solid rgba(102, 126, 234, 0.2);
      border-top: 4px solid var(--primary-light);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-state {
      text-align: center;
      padding: 40px;
      color: var(--error);
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    /* Property Quick View */
    .property-quick-view {
      background: var(--bg-light);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      display: flex;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .property-quick-view:hover {
      background: white;
      box-shadow: var(--card-shadow);
    }

    .property-quick-view img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .property-quick-info {
      flex: 1;
      min-width: 0;
    }

    .property-quick-info h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .property-quick-info p {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .property-quick-price {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    /* Toast Notifications - same as buyer dashboard */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--secondary-gradient);
      color: white;
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      font-weight: 500;
      box-shadow: var(--card-hover-shadow);
      z-index: 9999;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      border: 1px solid var(--border);
      background: var(--bg-light);
      color: var(--text-dark);
    }

    .action-btn:hover {
      background: var(--border);
      transform: translateY(-1px);
    }

    .action-btn.primary {
      background: var(--primary-gradient);
      color: white;
      border: none;
    }
    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    /* Delete Conversation Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--card-hover-shadow);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .modal-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .modal-content h3 {
      font-size: 20px;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .modal-content p {
      color: var(--text-light);
      line-height: 1.6;
      margin-bottom: 25px;
    }

    .modal-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .modal-btn.cancel {
      background: var(--bg-light);
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .modal-btn.cancel:hover {
      background: var(--border);
    }

    .modal-btn.delete {
      background: var(--error);
      color: white;
    }

    .modal-btn.delete:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    /* ===== RESPONSIVE DESIGN ===== */
    
    /* Tablet */
    @media (max-width: 1024px) {
      .container {
        margin-left: 0;
        padding: 25px;
      }
      
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .messages-container {
        grid-template-columns: 1fr;
        height: auto;
        min-height: calc(100vh - 180px);
      }
      
      .conversations-sidebar {
        max-height: 400px;
      }
      
      .chat-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .chat-property-info {
        max-width: 100%;
        width: 100%;
      }
    }

    /* Large Mobile - same as buyer dashboard */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      .mobile-menu-toggle {
        top: 15px;
        left: 15px;
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
      .hero-section h1 {
        font-size: 1.8rem;
      }
      .hero-section {
        padding: 30px 24px;
      }
      .hero-actions {
        margin-top: 20px;
      }
      .refresh-btn {
        align-self: flex-start;
      }
      
      .message-bubble {
        max-width: 85%;
      }
      
      .filter-buttons {
        flex-wrap: wrap;
      }
    }

    /* Small Mobile */
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      .mobile-menu-toggle {
        top: 10px;
        left: 10px;
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .page-header h1 {
        font-size: 22px;
      }
      
      .conversation-item {
        padding: 12px 15px;
      }
      
      .conversation-avatar {
        width: 40px;
        height: 40px;
        font-size: 14px;
      }
      
      .chat-header {
        padding: 15px;
      }
      
      .chat-messages-container {
        padding: 15px;
      }
      
      .chat-input-container {
        padding: 15px;
      }
      
      .message-bubble {
        max-width: 90%;
      }
      
      .property-quick-view {
        flex-direction: column;
        text-align: center;
      }
      
      .property-quick-view img {
        width: 100%;
        height: 120px;
      }
    }
</style>
</head>

<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Main - same layout as buyer dashboard -->
<div class="container">
  <!-- Hero Section - same design as buyer dashboard -->
  <div class="hero-section">
    <h1>My Messages</h1>
    <p>View and manage your conversations with brokers and property owners</p>
    <div class="hero-actions">
      <button class="refresh-btn" id="refreshBtn">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </div>

  <div class="messages-container">
    <!-- Conversations Sidebar -->
    <div class="conversations-sidebar">
      <div class="conversations-header">
        <h2><i class="fas fa-comments"></i> Conversations</h2>
        
        <div class="index-notice" id="indexNotice">
          <i class="fas fa-info-circle"></i> 
          <span id="noticeText">No conversations yet. Start messaging brokers from property listings.</span>
        </div>
        
        <div class="stats-row" id="conversationStats">
          <div class="stat-item">
            <div class="stat-value">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">0</div>
            <div class="stat-label">Unread</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">0</div>
            <div class="stat-label">Today</div>
          </div>
        </div>
        
        <div class="filter-buttons">
          <button class="filter-btn active" id="filterAll">
            <i class="fas fa-list"></i> All
          </button>
          <button class="filter-btn" id="filterUnread">
            <i class="fas fa-envelope"></i> Unread
          </button>
          <button class="filter-btn" id="filterToday">
            <i class="fas fa-calendar-day"></i> Today
          </button>
          <button class="filter-btn" id="fixDataBtn" style="background: var(--accent-gradient); color: white; border: none;">
            <i class="fas fa-wrench"></i> Fix Data
          </button>
        </div>
        
        <div class="conversations-search">
          <i class="fas fa-search"></i>
          <input type="text" id="searchConversations" placeholder="Search conversations...">
        </div>
      </div>
      <div class="conversations-list" id="conversationsList">
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading conversations...</p>
        </div>
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-user-info">
          <div class="chat-user-avatar" id="chatUserAvatar">BR</div>
          <div class="chat-user-details">
            <h3 id="chatUserName">Select a conversation</h3>
            <p id="chatUserStatus"><i class="fas fa-circle" style="color: #ccc; font-size: 8px;"></i> Choose a conversation to start messaging</p>
          </div>
        </div>
        <div class="chat-property-info" id="chatPropertyInfo" style="display: none;">
          <h4 id="propertyTitle">Property Title</h4>
          <p><i class="fas fa-map-marker-alt"></i> <span id="propertyLocation">Location</span></p>
          <div class="property-quick-price" id="propertyPrice">‚Ç±0</div>
        </div>
      </div>

      <div class="chat-messages-container" id="chatMessagesContainer">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <h3>No conversation selected</h3>
          <p>Select a conversation from the list to view messages</p>
        </div>
      </div>

      <div class="chat-input-container" id="chatInputContainer" style="display: none;">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chatInput" placeholder="Type your message here..." rows="1"></textarea>
          <button class="send-button" id="sendButton">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        
        <div class="quick-actions" id="quickActions" style="display: none;">
          <button class="action-btn" id="sendEmailBtn">
            <i class="fas fa-envelope"></i> Send Email
          </button>
          <button class="action-btn" id="makeCallBtn">
            <i class="fas fa-phone"></i> Make Call
          </button>
          <button class="action-btn primary" id="scheduleViewingBtn">
            <i class="fas fa-calendar-check"></i> Schedule Viewing
          </button>
          <button class="action-btn" id="deleteConversationBtn" style="background: #fee; color: var(--error); border-color: var(--error);">
            <i class="fas fa-trash-alt"></i> Delete Conversation
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Conversation Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="modal-content">
        <h3>Delete Conversation</h3>
        <p id="deleteModalMessage">Are you sure you want to delete this conversation? This action cannot be undone and all messages will be permanently deleted.</p>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" id="cancelDelete">Cancel</button>
      <button class="modal-btn delete" id="confirmDelete">Delete Conversation</button>
    </div>
  </div>
</div>

<!-- Sidebar Loader -->
<script>
// Mobile menu functionality
document.getElementById('mobileMenuToggle').addEventListener('click', function() {
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    sidebar.style.transform = sidebar.style.transform === 'translateX(0px)' ? 
      'translateX(-100%)' : 'translateX(0px)';
  }
});

// Close sidebar when clicking on a link (mobile)
document.addEventListener('click', function(e) {
  if (window.innerWidth <= 1024) {
    if (e.target.closest('.sidebar-link')) {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.style.transform = 'translateX(-100%)';
      }
    }
  }
});

// Load sidebar
fetch('sidebar.html')
  .then(response => response.text())
  .then(html => {
    document.getElementById('sidebar-container').innerHTML = html;
    const links = document.querySelectorAll('.sidebar-link');
    links.forEach(link => {
      if (link.getAttribute('href') === 'messages.html') {
        link.classList.add('active');
      }
    });
  })
  .catch(error => console.error('Error loading sidebar:', error));

// Handle window resize
window.addEventListener('resize', function() {
  const sidebar = document.querySelector('.sidebar');
  if (window.innerWidth > 1024 && sidebar) {
    sidebar.style.transform = 'translateX(0)';
  } else if (window.innerWidth <= 1024 && sidebar) {
    sidebar.style.transform = 'translateX(-100%)';
  }
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  query, 
  where, 
  getDocs, 
  getDoc, 
  doc, 
  addDoc, 
  updateDoc, 
  setDoc,
  deleteDoc,
  onSnapshot, 
  serverTimestamp,
  orderBy,
  writeBatch
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
  authDomain: "bahai-1b76d.firebaseapp.com",
  projectId: "bahai-1b76d",
  storageBucket: "bahai-1b76d.firebasestorage.app",
  messagingSenderId: "646878644941",
  appId: "1:646878644941:web:5b4ccc3412250337587784"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Global variables
let currentUser = null;
let currentConversationId = null;
let currentBrokerId = null;
let currentPropertyId = null;
let messageListener = null;
let conversationsListener = null;
let userMap = new Map();
let propertyMap = new Map();
let allConversations = [];
let activeFilter = 'all';
let searchTerm = '';
let isLoadingMessages = false;
let conversationToDelete = null;

// Debug mode
const DEBUG = true;
function debugLog(...args) {
  if (DEBUG) {
    console.log('üîç [DEBUG]', ...args);
  }
}

// Initialize on auth state change
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  
  currentUser = user;
  debugLog('üë§ Buyer logged in:', user.uid, 'Email:', user.email);
  
  // Initialize the page
  initPage();
});

// Initialize the page
async function initPage() {
  debugLog('üöÄ Initializing messages page...');
  
  // Load current user data first
  await loadCurrentUserData();
  
  // Update notice text
  document.getElementById('noticeText').textContent = 
    `Logged in as: ${currentUser.displayName || currentUser.email}`;
  
  // Setup event listeners
  setupEventListeners();
  
  // Load conversations
  await loadConversations();
}

// Load current user data
async function loadCurrentUserData() {
  try {
    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      currentUser.displayName = extractUserName(userData);
      currentUser.phone = userData.phone || userData.phoneNumber || '';
      currentUser.role = userData.role || 'buyer';
    } else {
      currentUser.displayName = 'Buyer';
    }
  } catch (error) {
    debugLog('‚ùå Error loading current user data:', error);
    currentUser.displayName = 'Buyer';
  }
}

// Setup event listeners
function setupEventListeners() {
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', refreshConversations);
  
  // Fix Data button
  document.getElementById('fixDataBtn').addEventListener('click', async function() {
    if (confirm('This will create conversation documents from your existing messages. Continue?')) {
      await createConversationsFromMessages();
    }
  });
  
  // Filter buttons
  document.getElementById('filterAll').addEventListener('click', () => setFilter('all'));
  document.getElementById('filterUnread').addEventListener('click', () => setFilter('unread'));
  document.getElementById('filterToday').addEventListener('click', () => setFilter('today'));
  
  // Search input
  document.getElementById('searchConversations').addEventListener('input', function(e) {
    searchTerm = e.target.value.toLowerCase();
    filterConversations();
  });
  
  // Send message
  document.getElementById('sendButton').addEventListener('click', sendMessage);
  
  // Enter key for sending messages
  document.getElementById('chatInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Auto-resize textarea
  document.getElementById('chatInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
  
  // Quick actions
  document.getElementById('sendEmailBtn').addEventListener('click', sendEmailToBroker);
  document.getElementById('makeCallBtn').addEventListener('click', makeCallToBroker);
  document.getElementById('scheduleViewingBtn').addEventListener('click', scheduleViewing);
  document.getElementById('deleteConversationBtn').addEventListener('click', openDeleteModal);
  
  // Property info click
  document.getElementById('chatPropertyInfo').addEventListener('click', function() {
    if (currentPropertyId) {
      viewPropertyDetails(currentPropertyId);
    }
  });
  
  // Delete modal buttons
  document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
  document.getElementById('confirmDelete').addEventListener('click', deleteConversation);
  
  // Close modal when clicking outside
  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDeleteModal();
    }
  });
}

// ==================== CONVERSATIONS MANAGEMENT ====================

// Load conversations for buyer
async function loadConversations() {
  const conversationsList = document.getElementById('conversationsList');
  
  try {
    debugLog('üîç Loading conversations for buyer...');
    
    // Show loading state
    conversationsList.innerHTML = `
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading conversations...</p>
      </div>
    `;
    
    // Clear previous data
    allConversations = [];
    userMap.clear();
    propertyMap.clear();
    
    // Stop any existing listener
    if (conversationsListener) {
      conversationsListener();
      conversationsListener = null;
    }
    
    // Load conversations where current user is a participant (as buyer)
    await loadConversationsFromDB();
    
    if (allConversations.length === 0) {
      showNoConversations();
    } else {
      // Sort by last message time
      allConversations.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
      
      // Update UI
      updateStats();
      
      // Load all user data for conversations
      await loadAllUsersForConversations();
      
      // Display conversations
      displayConversations(allConversations);
      
      // Update notice
      document.getElementById('indexNotice').style.display = 'none';
      
      // Set up real-time listener for conversations
      setupConversationsListener();
    }
    
  } catch (error) {
    console.error('‚ùå Error loading conversations:', error);
    showError('Failed to load conversations: ' + error.message);
  }
}

// Load all users for conversations
async function loadAllUsersForConversations() {
  const userIds = new Set();
  
  allConversations.forEach(conv => {
    // For buyer, we want to load broker/landlord info
    if (conv.brokerId) userIds.add(conv.brokerId);
    if (conv.participants) {
      conv.participants.forEach(id => {
        if (id !== currentUser.uid) userIds.add(id);
      });
    }
  });
  
  debugLog(`üë• Loading ${userIds.size} brokers/landlords for conversations...`);
  
  // Load users in parallel
  const userPromises = Array.from(userIds).map(userId => loadUserData(userId));
  await Promise.all(userPromises);
}

// Load conversations from database for buyer
async function loadConversationsFromDB() {
  try {
    debugLog('üìã Loading conversations from Firestore...');
    
    const conversationsRef = collection(db, 'conversations');
    
    // Query where buyer is in participants array
    const q = query(
      conversationsRef,
      where('participants', 'array-contains', currentUser.uid)
    );
    
    const snapshot = await getDocs(q);
    
    // Process results
    snapshot.forEach(doc => {
      const conversation = doc.data();
      debugLog('üìÑ Found conversation:', conversation);
      processConversation(doc.id, conversation);
    });
    
    debugLog(`‚úÖ Loaded ${allConversations.length} conversations from database`);
    
  } catch (error) {
    debugLog('‚ö†Ô∏è Error loading conversations:', error.message);
    // If no conversations found, show empty state
  }
}

// Process a conversation document for buyer
function processConversation(id, data) {
  try {
    const lastMessageTime = data.lastMessageTime?.toDate ? 
      data.lastMessageTime.toDate() : 
      new Date(data.lastMessageTime || data.updatedAt || data.createdAt || Date.now());
    
    const conversation = {
      id: id,
      ...data,
      lastMessageTime: lastMessageTime
    };
    
    // Ensure participants array exists
    if (!conversation.participants || !Array.isArray(conversation.participants)) {
      if (conversation.buyerId && conversation.brokerId) {
        conversation.participants = [conversation.buyerId, conversation.brokerId];
      } else {
        debugLog('‚ö†Ô∏è Conversation missing participants:', conversation);
        return;
      }
    }
    
    // Identify broker/landlord (the other participant who is not current user)
    const otherParticipant = conversation.participants.find(id => id !== currentUser.uid);
    if (otherParticipant) {
      conversation.brokerId = otherParticipant;
      conversation.buyerId = currentUser.uid;
    }
    
    // Check if conversation already exists (avoid duplicates)
    const exists = allConversations.some(c => c.id === id);
    if (!exists) {
      allConversations.push(conversation);
    } else {
      debugLog('‚ö†Ô∏è Skipping duplicate conversation:', id);
    }
    
  } catch (error) {
    debugLog('‚ùå Error processing conversation:', error);
  }
}

// Set up real-time listener for conversations
function setupConversationsListener() {
  try {
    const conversationsRef = collection(db, 'conversations');
    const q = query(
      conversationsRef,
      where('participants', 'array-contains', currentUser.uid)
    );
    
    conversationsListener = onSnapshot(q, async (snapshot) => {
      let needsRefresh = false;
      
      snapshot.docChanges().forEach((change) => {
        const conversationId = change.doc.id;
        const conversationData = change.doc.data();
        
        if (change.type === 'added') {
          // New conversation added
          debugLog('‚ûï New conversation added:', conversationId);
          processConversation(conversationId, conversationData);
          needsRefresh = true;
        } else if (change.type === 'modified') {
          // Conversation updated
          debugLog('‚úèÔ∏è Conversation updated:', conversationId);
          // Update existing conversation
          const index = allConversations.findIndex(c => c.id === conversationId);
          if (index !== -1) {
            processConversation(conversationId, conversationData);
            // Replace the conversation in array
            allConversations[index] = {
              id: conversationId,
              ...conversationData,
              lastMessageTime: conversationData.lastMessageTime?.toDate ? 
                conversationData.lastMessageTime.toDate() : 
                new Date(conversationData.lastMessageTime || Date.now())
            };
            needsRefresh = true;
          }
        } else if (change.type === 'removed') {
          // Conversation removed
          debugLog('üóëÔ∏è Conversation removed:', conversationId);
          const index = allConversations.findIndex(c => c.id === conversationId);
          if (index !== -1) {
            allConversations.splice(index, 1);
            needsRefresh = true;
          }
        }
      });
      
      if (needsRefresh) {
        // Reload user data for new conversations
        await loadAllUsersForConversations();
        filterConversations();
      }
    });
    
  } catch (error) {
    debugLog('‚ùå Error setting up conversations listener:', error);
  }
}

// Show no conversations state
function showNoConversations() {
  const conversationsList = document.getElementById('conversationsList');
  conversationsList.innerHTML = `
    <div class="empty-state" style="padding: 40px;">
      <div class="empty-state-icon">üí¨</div>
      <h3>No conversations yet</h3>
      <p>When you message brokers or property owners through property listings, conversations will appear here.</p>
      <a href="buyer_dashboard.html" class="action-btn primary" style="margin-top: 20px;">
        <i class="fas fa-search"></i> Browse Properties
      </a>
    </div>
  `;
  updateStats();
}

// Update conversation statistics
function updateStats() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const total = allConversations.length;
  const unread = allConversations.filter(conv => conv.unreadCount?.[currentUser.uid] > 0).length;
  const todayCount = allConversations.filter(conv => {
    const lastTime = conv.lastMessageTime;
    return lastTime >= today;
  }).length;
  
  document.querySelectorAll('.stat-value')[0].textContent = total;
  document.querySelectorAll('.stat-value')[1].textContent = unread;
  document.querySelectorAll('.stat-value')[2].textContent = todayCount;
}

// Filter and display conversations
function filterConversations() {
  let filteredConversations = [...allConversations];
  
  // Apply search filter
  if (searchTerm) {
    filteredConversations = filteredConversations.filter(conversation => {
      const brokerId = conversation.brokerId;
      const brokerInfo = userMap.get(brokerId);
      const propertyInfo = conversation.propertyId ? propertyMap.get(conversation.propertyId) : null;
      
      const brokerName = brokerInfo?.displayName?.toLowerCase() || '';
      const lastMessage = conversation.lastMessage?.toLowerCase() || '';
      const propertyName = propertyInfo?.title?.toLowerCase() || '';
      
      return brokerName.includes(searchTerm) || 
             lastMessage.includes(searchTerm) || 
             propertyName.includes(searchTerm);
    });
  }
  
  // Apply active filter
  switch(activeFilter) {
    case 'unread':
      filteredConversations = filteredConversations.filter(conv => conv.unreadCount?.[currentUser.uid] > 0);
      break;
    case 'today':
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      filteredConversations = filteredConversations.filter(conv => {
        const lastTime = conv.lastMessageTime;
        return lastTime >= today;
      });
      break;
    // 'all' filter doesn't need additional filtering
  }
  
  // Display filtered conversations
  displayConversations(filteredConversations);
}

// Load user data for broker/landlord
async function loadUserData(userId) {
  // Skip if already loaded
  if (userMap.has(userId)) {
    return;
  }
  
  // Don't load current user (we already have their data)
  if (userId === currentUser.uid) {
    userMap.set(userId, {
      id: userId,
      displayName: currentUser.displayName || 'Me',
      email: currentUser.email || 'No email',
      phone: currentUser.phone || 'No phone',
      role: currentUser.role || 'buyer'
    });
    return;
  }
  
  try {
    debugLog(`üìã Loading user: ${userId}`);
    
    const userDoc = await getDoc(doc(db, "users", userId));
    
    if (userDoc.exists()) {
      const userData = userDoc.data();
      debugLog(`‚úÖ Loaded user data for ${userId}:`, userData);
      
      const displayName = extractUserName(userData);
      const email = userData.email || 'No email';
      const phone = userData.phone || userData.phoneNumber || userData.mobile || 'No phone';
      const role = userData.role || 'broker';
      const roleDisplay = role === 'landlord' ? 'Property Owner' : 
                         role === 'broker' ? 'Licensed Broker' : 
                         role === 'seller' ? 'Property Seller' : 'Contact';
      
      userMap.set(userId, {
        id: userId,
        displayName: displayName,
        email: email,
        phone: phone,
        role: role,
        roleDisplay: roleDisplay
      });
      
      debugLog(`‚úÖ User ${userId}: ${displayName} (${roleDisplay})`);
    } else {
      // User not found in database
      debugLog(`‚ö†Ô∏è User document not found for: ${userId}`);
      userMap.set(userId, {
        id: userId,
        displayName: `Contact ${userId.substring(0, 8)}`,
        email: 'No email',
        phone: 'No phone',
        role: 'unknown',
        roleDisplay: 'Contact'
      });
    }
  } catch (error) {
    debugLog(`‚ùå Error loading user ${userId}:`, error);
    userMap.set(userId, {
      id: userId,
      displayName: `Contact ${userId.substring(0, 8)}`,
      email: 'No email',
      phone: 'No phone',
      role: 'error',
      roleDisplay: 'Contact'
    });
  }
}

// Extract user name from user data
function extractUserName(userData) {
  if (!userData) return 'Unknown User';
  
  // Try different possible name fields
  if (userData.fullName && userData.fullName.trim()) {
    return userData.fullName.trim();
  }
  if (userData.displayName && userData.displayName.trim()) {
    return userData.displayName.trim();
  }
  if (userData.name && userData.name.trim()) {
    return userData.name.trim();
  }
  if (userData.firstName || userData.lastName) {
    const firstName = userData.firstName || '';
    const lastName = userData.lastName || '';
    return `${firstName} ${lastName}`.trim();
  }
  if (userData.email) {
    return userData.email.split('@')[0];
  }
  
  return 'Unknown User';
}

// Display conversations in the sidebar
function displayConversations(conversations) {
  const conversationsList = document.getElementById('conversationsList');
  
  if (conversations.length === 0) {
    let message = 'No conversations found';
    if (searchTerm) {
      message = 'No conversations match your search';
    } else if (activeFilter === 'unread') {
      message = 'No unread conversations';
    } else if (activeFilter === 'today') {
      message = 'No conversations today';
    }
    
    conversationsList.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <div class="empty-state-icon">üîç</div>
        <h3>${message}</h3>
        <p>Try changing your search or filter settings</p>
      </div>
    `;
    return;
  }
  
  // Clear and rebuild list
  conversationsList.innerHTML = '';
  
  conversations.forEach(conversation => {
    const brokerId = conversation.brokerId;
    const brokerInfo = userMap.get(brokerId);
    
    // Create a default broker info if not loaded yet
    const displayInfo = brokerInfo || {
      id: brokerId,
      displayName: `Contact ${brokerId ? brokerId.substring(0, 8) : 'Unknown'}`,
      roleDisplay: 'Contact',
      email: 'No email',
      phone: 'No phone',
      role: 'broker'
    };
    
    const propertyInfo = conversation.propertyId ? propertyMap.get(conversation.propertyId) : null;
    const unreadCount = conversation.unreadCount?.[currentUser.uid] || 0;
    
    // Check if there's a pending schedule for this conversation
    const hasPendingSchedule = checkPendingSchedule(conversation.id);
    
    const conversationElement = document.createElement('div');
    conversationElement.className = `conversation-item ${unreadCount > 0 ? 'unread' : ''} ${conversation.id === currentConversationId ? 'active' : ''}`;
    conversationElement.dataset.conversationId = conversation.id;
    conversationElement.dataset.brokerId = brokerId;
    conversationElement.dataset.propertyId = conversation.propertyId || '';
    
    // Format time
    const timeString = formatTime(conversation.lastMessageTime);
    
    // Get initials from display name
    const initials = getInitials(displayInfo.displayName);
    
    // Truncate last message
    const lastMessage = conversation.lastMessage || 'No messages yet';
    const preview = lastMessage.length > 50 ? lastMessage.substring(0, 50) + '...' : lastMessage;
    
    conversationElement.innerHTML = `
      <div class="conversation-avatar" style="background: ${getAvatarColor(displayInfo.displayName)}">
        ${initials}
        ${hasPendingSchedule ? '<span style="position: absolute; bottom: -2px; right: -2px; background: #f59e0b; color: white; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center;">üìÖ</span>' : ''}
      </div>
      <div class="conversation-info">
        <div class="conversation-header">
          <div class="conversation-name" title="${displayInfo.displayName}">${displayInfo.displayName}</div>
          <div class="conversation-time">${timeString}</div>
        </div>
        <div class="conversation-preview">
          ${preview}
          ${hasPendingSchedule ? ' <span style="color: #f59e0b;">üìÖ</span>' : ''}
        </div>
        <div class="conversation-property">
          <i class="fas fa-user-tag"></i> ${displayInfo.roleDisplay}
          ${propertyInfo ? `
            <span style="margin-left: 5px;">‚Ä¢</span>
            <i class="fas fa-home"></i>
            ${propertyInfo.title.substring(0, 20)}${propertyInfo.title.length > 20 ? '...' : ''}
          ` : ''}
        </div>
      </div>
      ${unreadCount > 0 ? `<div class="conversation-badge">${unreadCount}</div>` : ''}
      <button class="delete-conversation-btn" data-conversation-id="${conversation.id}">
        <i class="fas fa-times"></i>
      </button>
    `;
    
    // Click handler for selecting conversation
    conversationElement.addEventListener('click', (e) => {
      // Don't trigger if delete button was clicked
      if (!e.target.closest('.delete-conversation-btn')) {
        selectConversation(conversation.id, brokerId, conversation.propertyId);
      }
    });
    
    // Delete button handler
    const deleteBtn = conversationElement.querySelector('.delete-conversation-btn');
    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent triggering conversation selection
      conversationToDelete = {
        id: conversation.id,
        brokerName: displayInfo.displayName,
        propertyId: conversation.propertyId
      };
      openDeleteModal();
    });
    
    conversationsList.appendChild(conversationElement);
  });
}

// ==================== MESSAGES MANAGEMENT ====================

// Select a conversation
async function selectConversation(conversationId, brokerId, propertyId = null) {
  debugLog('üí¨ Selecting conversation:', conversationId, 'Broker:', brokerId);
  
  // Prevent multiple clicks
  if (isLoadingMessages) {
    debugLog('‚ö†Ô∏è Already loading messages, please wait...');
    return;
  }
  
  currentConversationId = conversationId;
  currentBrokerId = brokerId;
  currentPropertyId = propertyId;
  
  // Update UI to show active conversation
  document.querySelectorAll('.conversation-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.conversationId === conversationId) {
      item.classList.add('active');
    }
  });
  
  // Get broker info
  const brokerInfo = userMap.get(brokerId);
  
  // If broker info isn't loaded yet, load it now
  if (!brokerInfo) {
    await loadUserData(brokerId);
  }
  
  const finalBrokerInfo = userMap.get(brokerId) || {
    displayName: `Contact ${brokerId.substring(0, 8)}`,
    email: 'No email',
    phone: 'No phone',
    role: 'broker',
    roleDisplay: 'Contact'
  };
  
  // Update chat header
  const initials = getInitials(finalBrokerInfo.displayName);
  document.getElementById('chatUserAvatar').textContent = initials;
  document.getElementById('chatUserAvatar').style.background = getAvatarColor(finalBrokerInfo.displayName);
  document.getElementById('chatUserName').textContent = finalBrokerInfo.displayName;
  document.getElementById('chatUserStatus').innerHTML = `<i class="fas fa-circle" style="color: #10b981; font-size: 8px;"></i> ${finalBrokerInfo.roleDisplay}`;
  
  // Load property data if available
  if (propertyId && !propertyMap.has(propertyId)) {
    await loadPropertyData(propertyId);
  }
  
  const propertyInfo = propertyId ? propertyMap.get(propertyId) : null;
  const propertyInfoElement = document.getElementById('chatPropertyInfo');
  
  if (propertyInfo) {
    propertyInfoElement.style.display = 'block';
    document.getElementById('propertyTitle').textContent = propertyInfo.title;
    document.getElementById('propertyLocation').textContent = propertyInfo.location;
    
    // Format price
    const price = propertyInfo.price || 0;
    const isRental = propertyInfo.type === 'rent' || (price < 1000000);
    const priceDisplay = isRental ? `‚Ç±${price.toLocaleString()}/month` : `‚Ç±${price.toLocaleString()}`;
    document.getElementById('propertyPrice').textContent = priceDisplay;
  } else {
    propertyInfoElement.style.display = 'none';
  }
  
  // Show chat input and quick actions
  document.getElementById('chatInputContainer').style.display = 'block';
  document.getElementById('quickActions').style.display = 'flex';
  
  // Update quick action buttons
  if (finalBrokerInfo.email && finalBrokerInfo.email !== 'No email') {
    document.getElementById('sendEmailBtn').disabled = false;
    document.getElementById('sendEmailBtn').title = `Send email to ${finalBrokerInfo.email}`;
  } else {
    document.getElementById('sendEmailBtn').disabled = true;
    document.getElementById('sendEmailBtn').title = 'No email available';
  }
  
  if (finalBrokerInfo.phone && finalBrokerInfo.phone !== 'No phone') {
    document.getElementById('makeCallBtn').disabled = false;
    document.getElementById('makeCallBtn').title = `Call ${finalBrokerInfo.phone}`;
  } else {
    document.getElementById('makeCallBtn').disabled = true;
    document.getElementById('makeCallBtn').title = 'No phone number available';
  }
  
  // Load messages for this conversation
  await loadMessages(conversationId, brokerId);
  
  // Mark conversation as read
  await markConversationAsRead(conversationId);
}

// Load property data
async function loadPropertyData(propertyId) {
  try {
    const propertyDoc = await getDoc(doc(db, "properties", propertyId));
    if (propertyDoc.exists()) {
      const propertyData = propertyDoc.data();
      propertyMap.set(propertyId, {
        id: propertyId,
        title: propertyData.title || 'Untitled Property',
        location: propertyData.location || propertyData.address || 'Location not specified',
        price: propertyData.pricing || propertyData.monthlyRent || propertyData.price || 0,
        type: propertyData.propertyType || propertyData.type || 'Property',
        photos: propertyData.photos || propertyData.imageUrls || [],
        userId: propertyData.userId || null
      });
    }
  } catch (error) {
    debugLog(`‚ùå Error loading property ${propertyId}:`, error);
  }
}

// Load messages for a conversation
async function loadMessages(conversationId, brokerId) {
  debugLog('üì© Loading messages for conversation:', conversationId);
  
  if (isLoadingMessages) {
    debugLog('‚ö†Ô∏è Message load already in progress, skipping...');
    return;
  }
  
  isLoadingMessages = true;
  
  const messagesContainer = document.getElementById('chatMessagesContainer');
  
  // Clear previous listener FIRST
  if (messageListener) {
    debugLog('üîá Stopping previous message listener');
    messageListener();
    messageListener = null;
  }
  
  // Clear the container and show loading
  messagesContainer.innerHTML = '';
  showMessageLoadingState();
  
  try {
    // Query messages for this conversation
    const messagesRef = collection(db, 'messages');
    const messagesQuery = query(
      messagesRef,
      where('conversationId', '==', conversationId),
      orderBy('timestamp', 'asc')
    );
    
    // Get initial snapshot
    const initialSnapshot = await getDocs(messagesQuery);
    debugLog(`üì® Loaded ${initialSnapshot.size} initial messages`);
    
    if (initialSnapshot.empty) {
      showEmptyMessagesState();
      isLoadingMessages = false;
      return;
    }
    
    // Display initial messages
    displayMessages(initialSnapshot);
    
    // Set up real-time listener
    messageListener = onSnapshot(messagesQuery, 
      (snapshot) => {
        debugLog(`üì° Real-time update: ${snapshot.size} messages`);
        const isFirstLoad = messagesContainer.querySelector('.message-bubble') === null;
        
        if (!isFirstLoad) {
          messagesContainer.innerHTML = '';
          displayMessages(snapshot);
        }
      }, 
      (error) => {
        debugLog('‚ùå Error in message listener:', error);
        showError('Error loading messages: ' + error.message);
        isLoadingMessages = false;
      }
    );
    
    isLoadingMessages = false;
    
  } catch (error) {
    debugLog('üí• Error setting up message listener:', error);
    showError('Error loading messages: ' + error.message);
    isLoadingMessages = false;
  }
}

// Show message loading state
function showMessageLoadingState() {
  const messagesContainer = document.getElementById('chatMessagesContainer');
  messagesContainer.innerHTML = `
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading messages...</p>
    </div>
  `;
}

// Show empty messages state
function showEmptyMessagesState() {
  const messagesContainer = document.getElementById('chatMessagesContainer');
  
  if (currentPropertyId && propertyMap.has(currentPropertyId)) {
    const property = propertyMap.get(currentPropertyId);
    const photo = property.photos && property.photos.length > 0 ? property.photos[0] : 'https://via.placeholder.com/80x80/0b2e52/white?text=Property';
    
    messagesContainer.innerHTML = `
      <div class="property-quick-view" onclick="viewPropertyDetails('${currentPropertyId}')">
        <img src="${photo}" alt="${property.title}">
        <div class="property-quick-info">
          <h4>${property.title}</h4>
          <p><i class="fas fa-map-marker-alt"></i> ${property.location}</p>
          <div class="property-quick-price">‚Ç±${property.price.toLocaleString()}</div>
        </div>
      </div>
      <div class="message-date">
        <span>Start of conversation</span>
      </div>
      <div class="empty-state" style="padding: 40px 0;">
        <div class="empty-state-icon">üí¨</div>
        <h3>No messages yet</h3>
        <p>Send a message to start the conversation</p>
      </div>
    `;
  } else {
    messagesContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <h3>No messages yet</h3>
        <p>Send a message to start the conversation</p>
      </div>
    `;
  }
}

// Display messages
function displayMessages(snapshot) {
  const messagesContainer = document.getElementById('chatMessagesContainer');
  
  const displayedMessageIds = new Set();
  messagesContainer.innerHTML = '';
  
  // Add property quick view at the top if available
  if (currentPropertyId && propertyMap.has(currentPropertyId)) {
    const property = propertyMap.get(currentPropertyId);
    const photo = property.photos && property.photos.length > 0 ? property.photos[0] : 'https://via.placeholder.com/80x80/0b2e52/white?text=Property';
    
    const propertyView = document.createElement('div');
    propertyView.className = 'property-quick-view';
    propertyView.onclick = () => viewPropertyDetails(currentPropertyId);
    propertyView.innerHTML = `
      <img src="${photo}" alt="${property.title}">
      <div class="property-quick-info">
        <h4>${property.title}</h4>
        <p><i class="fas fa-map-marker-alt"></i> ${property.location}</p>
        <div class="property-quick-price">‚Ç±${property.price.toLocaleString()}</div>
      </div>
    `;
    
    messagesContainer.appendChild(propertyView);
  }
  
  // Collect all messages
  const messages = [];
  snapshot.forEach((doc) => {
    const message = doc.data();
    
    if (displayedMessageIds.has(doc.id)) {
      debugLog('‚ö†Ô∏è Skipping duplicate message:', doc.id);
      return;
    }
    
    displayedMessageIds.add(doc.id);
    
    const messageTime = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
    messages.push({
      id: doc.id,
      ...message,
      timestamp: messageTime
    });
  });
  
  // Sort messages by timestamp
  messages.sort((a, b) => a.timestamp - b.timestamp);
  
  // Group messages by date
  const messagesByDate = groupMessagesByDate(messages);
  
  // Display messages grouped by date
  Object.keys(messagesByDate).forEach(date => {
    // Add date separator
    const dateElement = document.createElement('div');
    dateElement.className = 'message-date';
    dateElement.innerHTML = `<span>${date}</span>`;
    messagesContainer.appendChild(dateElement);
    
    // Add messages for this date
    messagesByDate[date].forEach(message => {
      const isSent = message.senderId === currentUser.uid;
      const messageTime = formatMessageTime(message.timestamp);
      
      // Check if it's a schedule message
      if (message.type === 'schedule' || message.scheduleAction) {
        const scheduleElement = renderScheduleMessage(message);
        messagesContainer.appendChild(scheduleElement);
        return;
      }
      
      // Regular message
      const statusIcon = isSent ? (message.read ? '<i class="fas fa-check-double" style="font-size: 9px; opacity: 0.7;"></i>' : '<i class="fas fa-check" style="font-size: 9px; opacity: 0.7;"></i>') : '';
      
      const messageElement = document.createElement('div');
      messageElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
      
      messageElement.innerHTML = `
        <div class="message-content">${escapeHtml(message.text)}</div>
        <div class="message-time">${messageTime} ${statusIcon}</div>
      `;
      
      messagesContainer.appendChild(messageElement);
    });
  });
  
  // Scroll to bottom
  setTimeout(() => {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }, 100);
}

// Group messages by date
function groupMessagesByDate(messages) {
  const groups = {};
  
  messages.forEach(message => {
    const date = formatDate(message.timestamp);
    
    if (!groups[date]) {
      groups[date] = [];
    }
    
    groups[date].push(message);
  });
  
  return groups;
}

// Mark conversation as read
async function markConversationAsRead(conversationId) {
  try {
    const conversationRef = doc(db, 'conversations', conversationId);
    const conversationDoc = await getDoc(conversationRef);
    
    if (conversationDoc.exists()) {
      const currentData = conversationDoc.data();
      const currentUnread = currentData.unreadCount?.[currentUser.uid] || 0;
      
      if (currentUnread > 0) {
        await updateDoc(conversationRef, {
          [`unreadCount.${currentUser.uid}`]: 0
        });
        
        // Update local data
        const conversationIndex = allConversations.findIndex(c => c.id === conversationId);
        if (conversationIndex !== -1) {
          allConversations[conversationIndex].unreadCount = {
            ...allConversations[conversationIndex].unreadCount,
            [currentUser.uid]: 0
          };
          
          // Update stats and UI
          updateStats();
          filterConversations();
        }
      }
    }
  } catch (error) {
    debugLog('‚ùå Error marking conversation as read:', error);
  }
}

// Send message
async function sendMessage() {
  const messageInput = document.getElementById('chatInput');
  const messageText = messageInput.value.trim();
  const sendButton = document.getElementById('sendButton');
  
  if (!messageText || !currentBrokerId) {
    showError('Please select a conversation first');
    return;
  }
  
  if (!currentConversationId) {
    currentConversationId = [currentBrokerId, currentUser.uid].sort().join('_');
  }
  
  debugLog('üì§ Sending message:', { 
    conversationId: currentConversationId, 
    brokerId: currentBrokerId,
    text: messageText 
  });
  
  // Disable send button and show loading
  const originalHTML = sendButton.innerHTML;
  sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  sendButton.disabled = true;
  
  try {
    // 1. First, ensure conversation exists
    const conversationRef = doc(db, 'conversations', currentConversationId);
    const conversationDoc = await getDoc(conversationRef);
    
    if (!conversationDoc.exists()) {
      // Create conversation
      await setDoc(conversationRef, {
        participants: [currentBrokerId, currentUser.uid],
        lastMessage: messageText,
        lastMessageTime: serverTimestamp(),
        unreadCount: { [currentBrokerId]: 1 },
        buyerId: currentUser.uid,
        brokerId: currentBrokerId,
        propertyId: currentPropertyId,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    } else {
      // Update conversation
      await updateDoc(conversationRef, {
        lastMessage: messageText,
        lastMessageTime: serverTimestamp(),
        [`unreadCount.${currentBrokerId}`]: (conversationDoc.data().unreadCount?.[currentBrokerId] || 0) + 1,
        updatedAt: serverTimestamp()
      });
    }
    
    // 2. Add message to Firestore
    await addDoc(collection(db, 'messages'), {
      conversationId: currentConversationId,
      senderId: currentUser.uid,
      receiverId: currentBrokerId,
      text: messageText,
      timestamp: serverTimestamp(),
      read: false,
      createdAt: serverTimestamp(),
      type: 'text',
      propertyId: currentPropertyId || null
    });
    
    debugLog('‚úÖ Message sent and conversation updated');
    
    // Clear input and reset button
    messageInput.value = '';
    sendButton.innerHTML = originalHTML;
    sendButton.disabled = false;
    
    // Auto-resize textarea
    messageInput.style.height = 'auto';
    
    // Show success feedback
    sendButton.style.background = '#10b981';
    setTimeout(() => {
      sendButton.style.background = '';
    }, 1000);
    
    // Show toast notification
    showToast('Message sent successfully!');
    
  } catch (error) {
    console.error('‚ùå Error sending message:', error);
    sendButton.innerHTML = originalHTML;
    sendButton.disabled = false;
    showError('Failed to send message. Error: ' + error.message);
  }
}

// ==================== DELETE CONVERSATION FUNCTIONS ====================

// Open delete confirmation modal
function openDeleteModal() {
  if (!currentConversationId) {
    showError('No conversation selected');
    return;
  }
  
  const conversation = allConversations.find(c => c.id === currentConversationId);
  if (!conversation) {
    showError('Conversation not found');
    return;
  }
  
  const brokerInfo = userMap.get(currentBrokerId);
  const brokerName = brokerInfo?.displayName || 'this contact';
  
  document.getElementById('deleteModalMessage').textContent = 
    `Are you sure you want to delete your conversation with ${brokerName}? This action will permanently delete all messages and cannot be undone.`;
  
  conversationToDelete = {
    id: currentConversationId,
    brokerName: brokerName,
    propertyId: currentPropertyId
  };
  
  document.getElementById('deleteModal').classList.add('active');
}

// Close delete modal
function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('active');
  conversationToDelete = null;
}

// Delete conversation and all related messages
async function deleteConversation() {
  if (!conversationToDelete) {
    showError('No conversation to delete');
    return;
  }
  
  const conversationId = conversationToDelete.id;
  const brokerName = conversationToDelete.brokerName;
  
  try {
    debugLog('üóëÔ∏è Deleting conversation:', conversationId);
    
    // Disable delete button and show loading
    const confirmBtn = document.getElementById('confirmDelete');
    const originalText = confirmBtn.textContent;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    confirmBtn.disabled = true;
    
    // Create a batch for atomic operations
    const batch = writeBatch(db);
    
    // 1. Delete all messages in this conversation
    const messagesRef = collection(db, 'messages');
    const messagesQuery = query(
      messagesRef,
      where('conversationId', '==', conversationId)
    );
    
    const messagesSnapshot = await getDocs(messagesQuery);
    debugLog(`üóëÔ∏è Deleting ${messagesSnapshot.size} messages...`);
    
    messagesSnapshot.forEach((doc) => {
      batch.delete(doc.ref);
    });
    
    // 2. Delete the conversation document
    const conversationRef = doc(db, 'conversations', conversationId);
    batch.delete(conversationRef);
    
    // Commit the batch
    await batch.commit();
    
    debugLog('‚úÖ Conversation and messages deleted successfully');
    
    // Close modal
    closeDeleteModal();
    
    // Reset chat UI
    resetChatUI();
    
    // Refresh conversations
    await refreshConversations();
    
    // Show success message
    showToast(`Conversation with ${brokerName} deleted successfully`);
    
  } catch (error) {
    console.error('‚ùå Error deleting conversation:', error);
    
    // Re-enable button
    const confirmBtn = document.getElementById('confirmDelete');
    confirmBtn.textContent = 'Delete Conversation';
    confirmBtn.disabled = false;
    
    showError('Failed to delete conversation: ' + error.message);
  }
}

// Reset chat UI after deletion
function resetChatUI() {
  // Clear current conversation
  currentConversationId = null;
  currentBrokerId = null;
  currentPropertyId = null;
  
  // Stop message listener
  if (messageListener) {
    messageListener();
    messageListener = null;
  }
  
  // Reset chat header
  document.getElementById('chatUserAvatar').textContent = 'BR';
  document.getElementById('chatUserAvatar').style.background = '';
  document.getElementById('chatUserName').textContent = 'Select a conversation';
  document.getElementById('chatUserStatus').innerHTML = `<i class="fas fa-circle" style="color: #ccc; font-size: 8px;"></i> Choose a conversation to start messaging`;
  
  // Hide property info
  document.getElementById('chatPropertyInfo').style.display = 'none';
  
  // Show empty state
  const messagesContainer = document.getElementById('chatMessagesContainer');
  messagesContainer.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">üí¨</div>
      <h3>No conversation selected</h3>
      <p>Select a conversation from the list to view messages</p>
    </div>
  `;
  
  // Hide input and actions
  document.getElementById('chatInputContainer').style.display = 'none';
  document.getElementById('quickActions').style.display = 'none';
}

// ==================== SCHEDULE MESSAGE FUNCTIONS ====================

// Render schedule message - IMPROVED VERSION
function renderScheduleMessage(message) {
  const scheduleAction = message.scheduleAction || '';
  const text = message.text || '';
  const timestamp = message.timestamp || new Date();
  const scheduleId = message.scheduleId || '';
  const isSent = message.senderId === currentUser.uid;
  
  // Determine status based on action or text content
  let scheduleStatus = 'pending';
  let icon = 'üìÖ';
  let title = 'Viewing Request';
  
  if (scheduleAction.includes('confirmed') || text.includes('‚úÖ')) {
    scheduleStatus = 'confirmed';
    icon = '‚úÖ';
    title = 'Viewing Confirmed';
  } else if (scheduleAction.includes('declined') || text.includes('‚ùå')) {
    scheduleStatus = 'declined';
    icon = '‚ùå';
    title = 'Viewing Declined';
  } else if (scheduleAction.includes('alternative') || text.includes('üîÑ')) {
    scheduleStatus = 'alternative';
    icon = 'üîÑ';
    title = 'Alternative Time Suggested';
  } else if (scheduleAction.includes('cancelled') || text.includes('üö´')) {
    scheduleStatus = 'cancelled';
    icon = 'üö´';
    title = 'Viewing Cancelled';
  }
  
  // Parse schedule details from message text
  const lines = text.split('\n');
  const mainLine = lines[0] || '';
  const notes = lines.slice(1).join('\n').replace(/^(Notes|Reason|Broker Notes):\s*/i, '');
  
  // Extract date and time using regex patterns
  let dateStr = '';
  let timeStr = '';
  
  // Try different patterns
  const datePattern1 = /(\d{4}-\d{2}-\d{2})/;
  const datePattern2 = /(\w+ \d{1,2},? \d{4})/;
  const timePattern = /(\d{1,2}:\d{2}\s*(?:AM|PM))/i;
  
  const dateMatch1 = text.match(datePattern1);
  const dateMatch2 = text.match(datePattern2);
  const timeMatch = text.match(timePattern);
  
  if (dateMatch1) dateStr = dateMatch1[1];
  else if (dateMatch2) dateStr = dateMatch2[1];
  
  if (timeMatch) timeStr = timeMatch[1];
  
  // Format date if it's in YYYY-MM-DD format
  if (dateStr && dateStr.includes('-')) {
    const date = new Date(dateStr);
    if (!isNaN(date.getTime())) {
      dateStr = date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
  }
  
  const element = document.createElement('div');
  element.className = `message-schedule ${scheduleStatus} ${isSent ? 'sent-schedule' : 'received-schedule'}`;
  
  // Add alignment based on sender
  if (isSent) {
    element.style.alignSelf = 'flex-end';
  } else {
    element.style.alignSelf = 'flex-start';
  }
  
  element.innerHTML = `
    <div class="schedule-header">
      <i class="fas fa-${scheduleStatus === 'confirmed' ? 'check-circle' : 
                        scheduleStatus === 'declined' ? 'times-circle' : 
                        scheduleStatus === 'alternative' ? 'exchange-alt' : 
                        scheduleStatus === 'cancelled' ? 'ban' : 
                        'calendar-check'}"></i>
      <span>${title}</span>
      <span class="schedule-status-badge status-${scheduleStatus}">
        ${scheduleStatus}
      </span>
    </div>
    
    ${dateStr ? `
      <div class="schedule-details">
        ${dateStr ? `
          <div class="schedule-info-row">
            <span class="schedule-info-label">Date:</span>
            <span class="schedule-info-value">${dateStr}</span>
          </div>
        ` : ''}
        ${timeStr ? `
          <div class="schedule-info-row">
            <span class="schedule-info-label">Time:</span>
            <span class="schedule-info-value">${timeStr}</span>
          </div>
        ` : ''}
      </div>
    ` : ''}
    
    ${notes ? `
      <div class="schedule-notes">
        <div class="schedule-notes-label">${scheduleStatus === 'confirmed' ? 'Broker Notes' : 
                                          scheduleStatus === 'declined' ? 'Reason' : 
                                          scheduleStatus === 'alternative' ? 'Details' : 
                                          'Notes'}:</div>
        <div class="schedule-notes-content">${notes}</div>
      </div>
    ` : ''}
    
    ${scheduleStatus === 'pending' && !isSent ? `
      <div class="schedule-actions">
        <button class="schedule-action-btn primary" onclick="confirmScheduleFromMessage('${scheduleId}', '${message.conversationId}')">
          <i class="fas fa-check"></i> Confirm
        </button>
        <button class="schedule-action-btn secondary" onclick="declineScheduleFromMessage('${scheduleId}', '${message.conversationId}')">
          <i class="fas fa-times"></i> Decline
        </button>
        <button class="schedule-action-btn secondary" onclick="suggestAlternativeFromMessage('${scheduleId}', '${message.conversationId}')">
          <i class="fas fa-clock"></i> Suggest Alternative
        </button>
      </div>
    ` : scheduleStatus === 'alternative' && isSent ? `
      <div class="schedule-actions">
        <button class="schedule-action-btn primary" onclick="acceptAlternativeFromMessage('${scheduleId}', '${message.conversationId}')">
          <i class="fas fa-check"></i> Accept Alternative
        </button>
        <button class="schedule-action-btn secondary" onclick="suggestNewTimeFromMessage('${message.conversationId}')">
          <i class="fas fa-clock"></i> Suggest Another Time
        </button>
      </div>
    ` : scheduleStatus === 'declined' && isSent ? `
      <div class="schedule-actions">
        <button class="schedule-action-btn primary" onclick="suggestNewTimeFromMessage('${message.conversationId}')">
          <i class="fas fa-clock"></i> Suggest Another Time
        </button>
      </div>
    ` : ''}
    
    <div class="message-time" style="text-align: center; margin-top: 10px;">
      ${formatMessageTime(timestamp)}
    </div>
  `;
  
  return element;
}

// Add these helper functions for schedule actions from messages:
window.confirmScheduleFromMessage = async function(scheduleId, conversationId) {
  if (!scheduleId) return;
  
  const notes = prompt('Add optional notes for the buyer:');
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    const scheduleDoc = await getDoc(scheduleRef);
    
    if (scheduleDoc.exists()) {
      const schedule = scheduleDoc.data();
      
      await updateDoc(scheduleRef, {
        status: 'confirmed',
        brokerNotes: notes || null,
        confirmedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      // Send confirmation message
      const messageText = `‚úÖ Viewing confirmed for ${schedule.proposedDate} at ${schedule.proposedTime}`;
      if (notes) messageText += `\nBroker Notes: ${notes}`;
      
      await addDoc(collection(db, 'messages'), {
        conversationId: conversationId,
        senderId: currentUser.uid,
        receiverId: schedule.buyerId,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false,
        type: 'schedule',
        scheduleAction: 'schedule_confirmed',
        scheduleId: scheduleId,
        propertyId: schedule.propertyId
      });
      
      showToast('Viewing confirmed!');
      
      // Refresh messages
      if (currentConversationId === conversationId) {
        await loadMessages(conversationId, schedule.buyerId);
      }
    }
  } catch (error) {
    console.error('Error confirming schedule:', error);
    showError('Failed to confirm: ' + error.message);
  }
};

window.declineScheduleFromMessage = async function(scheduleId, conversationId) {
  if (!scheduleId) return;
  
  const reason = prompt('Please provide a reason for declining:');
  if (!reason) return;
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    const scheduleDoc = await getDoc(scheduleRef);
    
    if (scheduleDoc.exists()) {
      const schedule = scheduleDoc.data();
      
      await updateDoc(scheduleRef, {
        status: 'declined',
        declineReason: reason,
        declinedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      // Send decline message
      const messageText = `‚ùå Viewing declined\nReason: ${reason}`;
      
      await addDoc(collection(db, 'messages'), {
        conversationId: conversationId,
        senderId: currentUser.uid,
        receiverId: schedule.buyerId,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false,
        type: 'schedule',
        scheduleAction: 'schedule_declined',
        scheduleId: scheduleId,
        propertyId: schedule.propertyId
      });
      
      showToast('Viewing declined');
      
      // Refresh messages
      if (currentConversationId === conversationId) {
        await loadMessages(conversationId, schedule.buyerId);
      }
    }
  } catch (error) {
    console.error('Error declining schedule:', error);
    showError('Failed to decline: ' + error.message);
  }
};

window.suggestAlternativeFromMessage = async function(scheduleId, conversationId) {
  if (!scheduleId) return;
  
  const alternativeDate = prompt('Enter alternative date (YYYY-MM-DD):');
  if (!alternativeDate) return;
  
  const alternativeTime = prompt('Enter alternative time (e.g., 02:00 PM):');
  if (!alternativeTime) return;
  
  const reason = prompt('Optional: Provide reason for suggesting alternative time:');
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    const scheduleDoc = await getDoc(scheduleRef);
    
    if (scheduleDoc.exists()) {
      const schedule = scheduleDoc.data();
      
      await updateDoc(scheduleRef, {
        status: 'alternative',
        alternativeDate: alternativeDate,
        alternativeTime: alternativeTime,
        declineReason: reason || null,
        updatedAt: serverTimestamp()
      });
      
      // Send alternative message
      const messageText = `üîÑ Alternative time suggested: ${alternativeDate} at ${alternativeTime}`;
      if (reason) messageText += `\nReason: ${reason}`;
      
      await addDoc(collection(db, 'messages'), {
        conversationId: conversationId,
        senderId: currentUser.uid,
        receiverId: schedule.buyerId,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false,
        type: 'schedule',
        scheduleAction: 'schedule_alternative',
        scheduleId: scheduleId,
        propertyId: schedule.propertyId
      });
      
      showToast('Alternative time suggested');
      
      // Refresh messages
      if (currentConversationId === conversationId) {
        await loadMessages(conversationId, schedule.buyerId);
      }
    }
  } catch (error) {
    console.error('Error suggesting alternative:', error);
    showError('Failed to suggest alternative: ' + error.message);
  }
};

window.acceptAlternativeFromMessage = async function(scheduleId, conversationId) {
  if (!scheduleId) return;
  
  try {
    // Update schedule status
    const scheduleRef = doc(db, 'schedules', scheduleId);
    const scheduleDoc = await getDoc(scheduleRef);
    
    if (scheduleDoc.exists()) {
      const schedule = scheduleDoc.data();
      
      await updateDoc(scheduleRef, {
        status: 'confirmed',
        proposedDate: schedule.alternativeDate || schedule.proposedDate,
        proposedTime: schedule.alternativeTime || schedule.proposedTime,
        confirmedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      // Send acceptance message
      const messageText = `‚úÖ Alternative time accepted: ${schedule.alternativeDate} at ${schedule.alternativeTime}`;
      
      await addDoc(collection(db, 'messages'), {
        conversationId: conversationId,
        senderId: currentUser.uid,
        receiverId: schedule.brokerId,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false,
        type: 'schedule',
        scheduleAction: 'schedule_confirmed',
        scheduleId: scheduleId,
        propertyId: schedule.propertyId
      });
      
      showToast('Alternative time accepted!');
      
      // Refresh messages
      if (currentConversationId === conversationId) {
        await loadMessages(conversationId, schedule.brokerId);
      }
    }
  } catch (error) {
    console.error('Error accepting alternative:', error);
    showError('Failed to accept alternative: ' + error.message);
  }
};

window.suggestNewTimeFromMessage = function(conversationId) {
  if (!currentPropertyId || !currentBrokerId) {
    showError('Please select a conversation with a property');
    return;
  }
  
  const brokerInfo = userMap.get(currentBrokerId);
  const propertyInfo = propertyMap.get(currentPropertyId);
  
  if (!brokerInfo || !propertyInfo) {
    showError('Unable to schedule viewing');
    return;
  }
  
  const scheduleUrl = `schedule_viewing.html?buyerId=${currentUser.uid}&brokerId=${currentBrokerId}&propertyId=${currentPropertyId}&brokerName=${encodeURIComponent(brokerInfo.displayName)}&propertyName=${encodeURIComponent(propertyInfo.title)}`;
  
  window.open(scheduleUrl, '_blank', 'width=800,height=700,scrollbars=yes');
};

// Accept alternative schedule time
window.acceptAlternative = async function(scheduleId) {
  if (!scheduleId) {
    showError('Schedule information not available');
    return;
  }
  
  try {
    // Update the alternative schedule status to confirmed
    const scheduleRef = doc(db, 'schedules', scheduleId);
    await updateDoc(scheduleRef, {
      status: 'confirmed',
      updatedAt: serverTimestamp(),
      confirmedAt: serverTimestamp()
    });
    
    showToast('Alternative time accepted!');
    
    // Send confirmation message
    const scheduleDoc = await getDoc(scheduleRef);
    if (scheduleDoc.exists()) {
      const schedule = scheduleDoc.data();
      const messageText = `‚úÖ Buyer accepted the alternative viewing time: ${formatDate(schedule.proposedDate)} at ${formatTime(schedule.proposedTime)}`;
      
      await addDoc(collection(db, 'messages'), {
        conversationId: schedule.conversationId,
        senderId: currentUser.uid,
        receiverId: schedule.brokerId,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false,
        type: 'schedule',
        scheduleAction: 'schedule_accepted',
        scheduleId: scheduleId,
        propertyId: schedule.propertyId
      });
    }
    
  } catch (error) {
    console.error('Error accepting alternative:', error);
    showError('Failed to accept alternative: ' + error.message);
  }
};

// Suggest new time
window.suggestNewTime = function(conversationId) {
  if (!currentPropertyId || !currentBrokerId) {
    showError('Please select a conversation with a property');
    return;
  }
  
  const brokerInfo = userMap.get(currentBrokerId);
  const propertyInfo = propertyMap.get(currentPropertyId);
  
  if (!brokerInfo || !propertyInfo) {
    showError('Unable to schedule viewing');
    return;
  }
  
  const scheduleUrl = `schedule_viewing.html?buyerId=${currentUser.uid}&brokerId=${currentBrokerId}&propertyId=${currentPropertyId}&brokerName=${encodeURIComponent(brokerInfo.displayName)}&propertyName=${encodeURIComponent(propertyInfo.title)}`;
  
  window.open(scheduleUrl, '_blank', 'width=800,height=700,scrollbars=yes');
};

// Schedule viewing
function scheduleViewing() {
  if (!currentBrokerId || !currentPropertyId) {
    showError('Please select a conversation with a property');
    return;
  }
  
  const brokerInfo = userMap.get(currentBrokerId);
  const propertyInfo = propertyMap.get(currentPropertyId);
  
  if (!brokerInfo || !propertyInfo) {
    showError('Unable to schedule viewing');
    return;
  }
  
  // Check if there's already a pending schedule
  checkForExistingSchedule(currentPropertyId, currentBrokerId).then(hasExisting => {
    if (hasExisting) {
      if (confirm('You already have a pending viewing request for this property. Would you like to view it or schedule a new one?')) {
        // Show existing schedule details
        viewExistingSchedule(currentPropertyId, currentBrokerId);
      } else {
        // Schedule new viewing
        openSchedulePage();
      }
    } else {
      openSchedulePage();
    }
  });
  
  function openSchedulePage() {
    const scheduleUrl = `schedule_viewing.html?buyerId=${currentUser.uid}&brokerId=${currentBrokerId}&propertyId=${currentPropertyId}&brokerName=${encodeURIComponent(brokerInfo.displayName)}&propertyName=${encodeURIComponent(propertyInfo.title)}`;
    window.open(scheduleUrl, '_blank', 'width=800,height=700,scrollbars=yes');
  }
}

// Check for existing schedules
async function checkForExistingSchedule(propertyId, brokerId) {
  try {
    const schedulesRef = collection(db, 'schedules');
    const q = query(
      schedulesRef,
      where('propertyId', '==', propertyId),
      where('buyerId', '==', currentUser.uid),
      where('brokerId', '==', brokerId),
      where('status', 'in', ['pending', 'confirmed', 'alternative'])
    );
    
    const snapshot = await getDocs(q);
    return !snapshot.empty;
  } catch (error) {
    debugLog('Error checking existing schedule:', error);
    return false;
  }
}

// View existing schedule
async function viewExistingSchedule(propertyId, brokerId) {
  try {
    const schedulesRef = collection(db, 'schedules');
    const q = query(
      schedulesRef,
      where('propertyId', '==', propertyId),
      where('buyerId', '==', currentUser.uid),
      where('brokerId', '==', brokerId),
      orderBy('createdAt', 'desc')
    );
    
    const snapshot = await getDocs(q);
    if (!snapshot.empty) {
      const latestSchedule = snapshot.docs[0].data();
      const scheduleId = snapshot.docs[0].id;
      
      // Show schedule details in a modal
      showScheduleDetailsModal(latestSchedule, scheduleId);
    }
  } catch (error) {
    debugLog('Error viewing existing schedule:', error);
    showError('Unable to load schedule details');
  }
}

// Show schedule details modal
function showScheduleDetailsModal(schedule, scheduleId) {
  const modalContent = `
    <div class="modal-header">
      <h3>Viewing Schedule Details</h3>
    </div>
    <div class="modal-body">
      <div class="schedule-details">
        <div class="schedule-info-row">
          <span class="schedule-info-label">Status:</span>
          <span class="schedule-status-badge status-${schedule.status}">${schedule.status}</span>
        </div>
        <div class="schedule-info-row">
          <span class="schedule-info-label">Date:</span>
          <span class="schedule-info-value">${formatDate(schedule.proposedDate?.toDate?.() || new Date())}</span>
        </div>
        <div class="schedule-info-row">
          <span class="schedule-info-label">Time:</span>
          <span class="schedule-info-value">${formatTime(schedule.proposedTime)}</span>
        </div>
        ${schedule.notes ? `
          <div class="schedule-notes">
            <div class="schedule-notes-label">Your Notes:</div>
            <div class="schedule-notes-content">${schedule.notes}</div>
          </div>
        ` : ''}
        ${schedule.brokerNotes ? `
          <div class="schedule-notes">
            <div class="schedule-notes-label">Broker Notes:</div>
            <div class="schedule-notes-content">${schedule.brokerNotes}</div>
          </div>
        ` : ''}
        ${schedule.declineReason ? `
          <div class="schedule-notes">
            <div class="schedule-notes-label">Decline Reason:</div>
            <div class="schedule-notes-content">${schedule.declineReason}</div>
          </div>
        ` : ''}
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal()">Close</button>
      ${schedule.status === 'pending' ? `
        <button class="modal-btn primary" onclick="cancelSchedule('${scheduleId}')">Cancel Request</button>
      ` : schedule.status === 'alternative' ? `
        <button class="modal-btn primary" onclick="acceptAlternative('${scheduleId}')">Accept Alternative</button>
      ` : ''}
    </div>
  `;
  
  // Create a modal to show schedule details
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal" style="max-width: 500px;">
      ${modalContent}
    </div>
  `;
  
  modal.addEventListener('click', function(e) {
    if (e.target === this || e.target.classList.contains('modal-btn')) {
      modal.remove();
    }
  });
  
  document.body.appendChild(modal);
  
  // Add closeModal function to window
  window.closeModal = function() {
    modal.remove();
  };
}

// Check for pending schedule
async function checkPendingSchedule(conversationId) {
  try {
    // Check if there are any pending schedules for this conversation
    const schedulesRef = collection(db, 'schedules');
    const buyerId = currentUser.uid;
    
    const q = query(
      schedulesRef,
      where('conversationId', '==', conversationId),
      where('buyerId', '==', buyerId),
      where('status', '==', 'pending')
    );
    
    const snapshot = await getDocs(q);
    return !snapshot.empty;
  } catch (error) {
    debugLog('Error checking pending schedules:', error);
    return false;
  }
}

// ==================== DATA FIXING FUNCTIONS ====================

// Create conversations from existing messages
window.createConversationsFromMessages = async function() {
  try {
    debugLog('üîÑ Creating conversations from existing messages...');
    
    // Show loading
    document.getElementById('fixDataBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
    document.getElementById('fixDataBtn').disabled = true;
    
    const messagesRef = collection(db, 'messages');
    const messagesSnapshot = await getDocs(messagesRef);
    
    if (messagesSnapshot.empty) {
      showToast('No messages found to create conversations from');
      return;
    }
    
    debugLog(`üì© Found ${messagesSnapshot.size} messages to process`);
    
    // Group messages by conversation
    const messagesByConversation = new Map();
    
    messagesSnapshot.forEach(doc => {
      const message = doc.data();
      const conversationId = message.conversationId || 
                            [message.senderId, message.receiverId].sort().join('_');
      
      if (!messagesByConversation.has(conversationId)) {
        messagesByConversation.set(conversationId, {
          messages: [],
          participants: [message.senderId, message.receiverId],
          lastMessage: message.text,
          lastMessageTime: message.timestamp
        });
      }
      
      const conv = messagesByConversation.get(conversationId);
      conv.messages.push(message);
      
      // Update last message if this is newer
      const messageTime = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
      const currentLastTime = conv.lastMessageTime?.toDate ? conv.lastMessageTime.toDate() : new Date();
      
      if (messageTime > currentLastTime) {
        conv.lastMessage = message.text;
        conv.lastMessageTime = message.timestamp;
      }
    });
    
    let createdCount = 0;
    let errorCount = 0;
    
    // Create conversation documents
    for (const [conversationId, data] of messagesByConversation) {
      try {
        const conversationRef = doc(db, 'conversations', conversationId);
        const conversationSnap = await getDoc(conversationRef);
        
        if (!conversationSnap.exists()) {
          // Determine buyer (current user) and broker
          const participants = data.participants;
          let buyerId, brokerId;
          
          if (participants.includes(currentUser.uid)) {
            buyerId = currentUser.uid;
            brokerId = participants.find(id => id !== currentUser.uid);
          } else {
            // If current user is not in participants, pick first as buyer
            buyerId = participants[0];
            brokerId = participants[1];
          }
          
          // Count unread messages for buyer
          const unreadForBuyer = data.messages.filter(m => 
            m.receiverId === buyerId && !m.read
          ).length;
          
          await setDoc(conversationRef, {
            participants: participants,
            lastMessage: data.lastMessage,
            lastMessageTime: data.lastMessageTime || serverTimestamp(),
            unreadCount: {
              [buyerId]: unreadForBuyer
            },
            buyerId: buyerId,
            brokerId: brokerId,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            messageCount: data.messages.length,
            _createdFromMessages: true
          });
          
          createdCount++;
          debugLog(`‚úÖ Created conversation: ${conversationId}`);
        }
      } catch (error) {
        errorCount++;
        debugLog(`‚ùå Error creating conversation ${conversationId}:`, error);
      }
    }
    
    // Reset button
    document.getElementById('fixDataBtn').innerHTML = '<i class="fas fa-wrench"></i> Fix Data';
    document.getElementById('fixDataBtn').disabled = false;
    
    showToast(`Created ${createdCount} conversations from ${messagesSnapshot.size} messages`);
    debugLog(`‚úÖ Created ${createdCount} conversations, ${errorCount} errors`);
    
    // Refresh the page to show new conversations
    setTimeout(() => {
      refreshConversations();
    }, 2000);
    
  } catch (error) {
    console.error('‚ùå Error creating conversations from messages:', error);
    
    // Reset button
    document.getElementById('fixDataBtn').innerHTML = '<i class="fas fa-wrench"></i> Fix Data';
    document.getElementById('fixDataBtn').disabled = false;
    
    showError('Failed to create conversations: ' + error.message);
  }
};

// ==================== UTILITY FUNCTIONS ====================

// Set active filter
function setFilter(filterName) {
  activeFilter = filterName;
  
  // Update button states
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(`filter${filterName.charAt(0).toUpperCase() + filterName.slice(1)}`).classList.add('active');
  
  // Apply filter
  filterConversations();
}

// Refresh conversations
function refreshConversations() {
  const refreshBtn = document.getElementById('refreshBtn');
  const originalHTML = refreshBtn.innerHTML;
  
  refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
  refreshBtn.classList.add('refreshing');
  
  // Clear and reload conversations
  loadConversations();
  
  // Reset button after 2 seconds
  setTimeout(() => {
    refreshBtn.innerHTML = originalHTML;
    refreshBtn.classList.remove('refreshing');
  }, 2000);
}

// Send email to broker
function sendEmailToBroker() {
  const brokerInfo = userMap.get(currentBrokerId);
  if (!brokerInfo || !brokerInfo.email || brokerInfo.email === 'No email') {
    showError('No email address available for this contact');
    return;
  }
  
  const propertyInfo = currentPropertyId ? propertyMap.get(currentPropertyId) : null;
  const subject = propertyInfo ? `Follow-up: ${propertyInfo.title}` : 'Follow-up on property inquiry';
  const body = `Dear ${brokerInfo.displayName},\n\nI'm following up on our conversation. ` + 
               (propertyInfo ? `Regarding ${propertyInfo.title} at ${propertyInfo.location}. ` : '') +
               `\n\nBest regards,\n${currentUser.displayName || 'Buyer'}`;
  
  window.open(`mailto:${brokerInfo.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
}

// Make call to broker
function makeCallToBroker() {
  const brokerInfo = userMap.get(currentBrokerId);
  if (!brokerInfo || !brokerInfo.phone || brokerInfo.phone === 'No phone') {
    showError('No phone number available for this contact');
    return;
  }
  
  window.open(`tel:${brokerInfo.phone}`);
}

// View property details
window.viewPropertyDetails = function(propertyId) {
  if (!propertyId) return;
  
  const propertyInfo = propertyMap.get(propertyId);
  if (propertyInfo) {
    // Redirect to dashboard to view property details
    window.open(`buyer_dashboard.html#property-${propertyId}`, '_blank');
  }
};

// Helper function to get initials from name
function getInitials(name) {
  if (!name || name.trim() === '') return '??';
  
  const words = name.trim().split(/\s+/);
  
  if (words.length === 0) return '??';
  
  if (words.length === 1) {
    // Single word - take first 2 characters
    return words[0].substring(0, 2).toUpperCase();
  } else {
    // Multiple words - take first letter of first two words
    return (words[0].charAt(0) + words[1].charAt(0)).toUpperCase();
  }
}

// Format time
function formatTime(date) {
  if (!date) return '';
  
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

// Format date for grouping messages
function formatDate(date) {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  if (date.toDateString() === today.toDateString()) {
    return 'Today';
  } else if (date.toDateString() === yesterday.toDateString()) {
    return 'Yesterday';
  } else {
    return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
  }
}

// Format message time
function formatMessageTime(date) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Get avatar color based on name
function getAvatarColor(name) {
  const colors = [
    '#0b2e52', '#1976d2', '#ff9800', '#10b981', 
    '#8b5cf6', '#ef4444', '#ec4899', '#14b8a6'
  ];
  
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  
  return colors[Math.abs(hash) % colors.length];
}

// Show toast notification
function showToast(message, type = 'success') {
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Show error message
function showError(message) {
  showToast(message, 'error');
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  debugLog('üì± Messages page loaded');
});
</script>

</body>
</html>