<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard - BahAI Real Estate</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="style.css">
<style>
    /* Match broker dashboard design - Navy + Gold */
    :root {
        --primary-gradient: linear-gradient(135deg, #0b2e52 0%, #1e3a5f 100%);
        --primary-light: #1e3a5f;
        --primary-dark: #071e38;
        --secondary-gradient: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
        --accent-gradient: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
        --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        --border-radius: 16px;
        --border-radius-sm: 12px;
        --border-radius-lg: 24px;
        --text-dark: #1a202c;
        --text-light: #718096;
    }

    body {
        background: #f1f5f9;
    }

    /* Hero Section - match broker */
    .hero-section {
        background: var(--primary-gradient);
        color: white;
        border-radius: var(--border-radius-lg);
        padding: 50px 40px;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
    }
    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" fill="white"/></svg>');
        background-size: cover;
        opacity: 0.1;
    }
    .hero-section h1 {
        font-size: 2.8rem;
        font-weight: 700;
        margin-bottom: 15px;
        line-height: 1.2;
        max-width: 800px;
        position: relative;
        z-index: 1;
    }
    .hero-section p {
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 600px;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }
    .hero-stats {
        display: flex;
        gap: 30px;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    .hero-stat-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .hero-stat-icon {
        font-size: 1.5rem;
        background: rgba(255,255,255,0.2);
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .hero-stat-value { font-size: 1.5rem; font-weight: 700; }
    .hero-stat-label { font-size: 0.9rem; opacity: 0.8; }
    .welcome-message, .guest-message { position: relative; z-index: 1; }

    /* Search Section - match broker */
    .search-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 35px;
        margin-bottom: 40px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .search-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .search-title i { color: #d4af37; font-size: 1.2rem; }
    .search-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .search-group { display: flex; flex-direction: column; gap: 8px; }
    .search-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    .search-select, .search-input {
        padding: 14px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: white;
    }
    .search-select:focus, .search-input:focus {
        outline: none;
        border-color: #d4af37;
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
    }
    .search-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    .search-button {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 200px;
        justify-content: center;
    }
    .search-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
    }
    .reset-button {
        background: white;
        color: var(--text-dark);
        border: 2px solid #e5e7eb;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 200px;
        justify-content: center;
    }
    .reset-button:hover {
        background: #f9fafb;
        border-color: #d4af37;
        transform: translateY(-2px);
    }

    /* Section title - match broker */
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .section-title i { color: #d4af37; font-size: 1.3rem; }

    /* Listings grid & cards - match broker */
    .properties-section, .recommendations-section { margin-bottom: 40px; }
    .listings-grid, .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 30px;
        margin-top: 25px;
    }
    .listing-card-wrapper { transition: all 0.3s ease; }
    .listing-card-wrapper:hover { transform: translateY(-5px); }
    .listing-card {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
        height: 100%;
    }
    .listing-card:hover { box-shadow: var(--card-hover-shadow); }
    .listing-card-image-container {
        position: relative;
        height: 220px;
        overflow: hidden;
    }
    .listing-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    .listing-card:hover .listing-image { transform: scale(1.05); }
    .listing-type-badge.type-rent,
    .listing-type-badge.rent { background: #10b981; }
    .listing-type-badge.type-lease,
    .listing-type-badge.lease { background: #10b981; }
    .listing-type-badge.type-sale,
    .listing-type-badge.sale { background: #3b82f6; }
    .listing-content { padding: 25px; }
    .listing-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        gap: 15px;
    }
    .listing-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        max-height: 3.6em;
    }
    .listing-location {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-light);
        font-size: 0.9rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .listing-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-dark);
        white-space: normal !important;
        word-break: break-word;
        text-align: right;
        min-width: fit-content;
        flex-shrink: 0;
        max-width: 45%;
    }
    .listing-header > div:first-child { flex: 1; min-width: 0; overflow: hidden; }
    .listing-details {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
    }
    .detail {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-light);
        font-size: 0.9rem;
    }
    .broker-avatar {
        width: 40px;
        height: 40px;
        min-width: 40px;
        border-radius: 50%;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        overflow: hidden;
    }
    .broker-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .broker-info { flex: 1; }
    .broker-name {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.95rem;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .broker-contact {
        font-size: 0.8rem;
        color: var(--text-light);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .listing-status {
        display: inline-block;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 20px;
    }
    .status-active, .listing-status.status-active,
    .status-available, .listing-status.status-available {
        background: #10b981 !important;
        color: white !important;
    }
    .status-pending, .listing-status.status-pending {
        background: var(--accent-gradient) !important;
        color: white !important;
    }
    .status-sold, .listing-status.status-sold,
    .status-rented, .listing-status.status-rented {
        background: #ef4444 !important;
        color: white !important;
    }
    .loading-state, .error-state, .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
    }
    .empty-state-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
    .empty-state h3 { font-size: 20px; margin-bottom: 10px; color: var(--text-dark); }
    .spinner {
        border: 4px solid rgba(212, 175, 55, 0.2);
        border-top: 4px solid #d4af37;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Categories - match broker card style */
    .categories-section { margin-bottom: 40px; }
    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
    }
    .category-card {
        background: white;
        padding: 25px 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-hover-shadow);
        border-color: #d4af37;
    }
    .category-icon { color: #d4af37; font-size: 40px; }

    /* AI chatbot section */
    .ai-chatbot-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 30px;
        margin-bottom: 40px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 1024px) {
        .container { margin-left: 0; padding: 25px; }
        .mobile-menu-toggle { display: flex; align-items: center; justify-content: center; }
        .listings-grid, .recommendations-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .hero-stats { gap: 20px; }
    }
    @media (max-width: 768px) {
        .container { padding: 20px; }
        .listings-grid, .recommendations-grid { grid-template-columns: 1fr; gap: 15px; }
        .hero-section h1 { font-size: 1.8rem; }
        .hero-section { padding: 30px 24px; }
    }
</style>
</head>

<body>
<script src="../ai_chatbot.js" type="module"></script>

<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- Include Sidebar -->
<div id="sidebar-container"></div>

<!-- Messaging Modal -->
<div class="message-modal" id="messageModal">
    <div class="message-modal-content">
        <div class="message-header">
            <h2 id="messageBrokerName">Chat</h2>
            <div class="message-subtitle" id="messageBrokerRole"></div>
            <button class="message-close" id="closeMessageModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="message-broker-card">
            <div class="message-broker-avatar" id="messageBrokerAvatar">B</div>
            <div class="message-broker-info">
                <div class="message-broker-name" id="messageBrokerFullName">Loading...</div>
                <div class="message-broker-role">
                    <span id="messageBrokerType">Broker</span> ‚Ä¢ 
                    <span id="messageBrokerContact">Contact info loading...</span>
                </div>
            </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="loading-messages">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>
        </div>
        
        <div class="message-input-area">
            <textarea class="message-textarea" 
                    id="messageInput" 
                    placeholder="Type your message here..." 
                    rows="3"></textarea>
            
            <div class="message-actions">
                <div class="contact-info">
                    <span id="brokerEmailInfo">üìß Email: Loading...</span>
                    <span id="brokerPhoneInfo">üìû Phone: Loading...</span>
                </div>
                <button class="send-btn" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i>
                    <span>Send Message</span>
                </button>
            </div>
            
            <div class="quick-contact-buttons">
                <a href="#" class="quick-contact-btn email-btn" id="quickEmailBtn">
                    <i class="fas fa-envelope"></i>
                    Send Email
                </a>
                <a href="#" class="quick-contact-btn call-btn" id="quickCallBtn">
                    <i class="fas fa-phone"></i>
                    Make Call
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Main -->
<div class="container">
<!-- Hero Section -->
<div class="hero-section">
    <h1>Discover House and Lot for sale and rent in Batangas</h1>
    <p>Find your dream property in Batangas - homes, condos, lots, and commercial spaces</p>
    <div id="welcomeText" class="welcome-message"></div>
    <div id="guestMessage" style="display: none;" class="guest-message">
        <strong>üëã Welcome Guest!</strong>
        <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">
            Browse properties without logging in. <a href="../login.html">Sign in</a> to save properties and contact brokers.
        </p>
    </div>
    <div class="hero-stats">
        <div class="hero-stat-item">
            <div class="hero-stat-icon"><i class="fas fa-building"></i></div>
            <div>
                <div class="hero-stat-value" id="totalProperties">0</div>
                <div class="hero-stat-label">Total Properties</div>
            </div>
        </div>
        <div class="hero-stat-item">
            <div class="hero-stat-icon"><i class="fas fa-map-marker-alt"></i></div>
            <div>
                <div class="hero-stat-value">20+</div>
                <div class="hero-stat-label">Cities & Towns</div>
            </div>
        </div>
        <div class="hero-stat-item">
            <div class="hero-stat-icon"><i class="fas fa-robot"></i></div>
            <div>
                <div class="hero-stat-value">AI-Powered</div>
                <div class="hero-stat-label">Smart Recommendations</div>
            </div>
        </div>
    </div>
</div>

<!-- Search Section -->
<div class="search-section">
    <div class="search-title">
        <i class="fas fa-search"></i>
        Find Properties in Batangas
    </div>

    <div class="search-grid">
        <!-- Location Filter -->
        <div class="search-group">
            <label class="search-label">
                <i class="fas fa-map-marker-alt"></i>
                Select City/Municipality
            </label>
            <select class="search-select" id="filterLocation">
                <option value="">All of Batangas</option>
                <option value="Batangas City">Batangas City</option>
                <option value="Lipa City">Lipa City</option>
                <option value="Tanauan City">Tanauan City</option>
                <option value="Bauan">Bauan</option>
                <option value="Balayan">Balayan</option>
                <option value="Calaca">Calaca</option>
                <option value="Lemery">Lemery</option>
                <option value="Nasugbu">Nasugbu</option>
                <option value="San Juan">San Juan</option>
                <option value="Taal">Taal</option>
                <option value="Talisay">Talisay</option>
                <option value="Alitagtag">Alitagtag</option>
                <option value="Cuenca">Cuenca</option>
                <option value="Laurel">Laurel</option>
                <option value="Mataasnakahoy">Mataasnakahoy</option>
                <option value="San Jose">San Jose</option>
                <option value="San Luis">San Luis</option>
                <option value="San Pascual">San Pascual</option>
                <option value="Santo Tomas">Santo Tomas</option>
            </select>
        </div>

        <!-- Transaction Type Filter -->
        <div class="search-group">
            <label class="search-label">
                <i class="fas fa-handshake"></i>
                Transaction Type
            </label>
            <select class="search-select" id="filterListingType">
                <option value="">All Types</option>
                <option value="sale">For Sale</option>
                <option value="rent">For Rent</option>
                <option value="lease">For Lease</option>
            </select>
        </div>

        <!-- Property Category Filter -->
        <div class="search-group">
            <label class="search-label">
                <i class="fas fa-th-large"></i>
                Property Category
            </label>
            <select class="search-select" id="filterPropertyCategory">
                <option value="">All Categories</option>
                <!-- Options will be populated dynamically based on transaction type -->
            </select>
        </div>

        <!-- Property Type Filter -->
        <div class="search-group">
            <label class="search-label">
                <i class="fas fa-home"></i>
                Property Type
            </label>
            <select class="search-select" id="filterPropertyType">
                <option value="">All Types</option>
                <!-- Options will be populated dynamically based on category -->
            </select>
        </div>

        <!-- Search by Name/Keyword -->
        <div class="search-group">
            <label class="search-label">
                <i class="fas fa-search"></i>
                Search Property
            </label>
            <input type="text" class="search-input" id="filterName" placeholder="Enter property name or keyword...">
        </div>
    </div>

    <div class="search-actions">
        <button class="search-button" id="applyFilters">
            <i class="fas fa-search"></i>
            Search Properties
        </button>
        <button class="reset-button" id="resetFilters">
            <i class="fas fa-redo"></i>
            Reset Filters
        </button>
    </div>
</div>

<!-- AI Chatbot Section -->
<div id="ai-chatbot-section" class="ai-chatbot-section">
    <h2 class="section-title">
        <i class="fas fa-robot"></i> AI Property Assistant
    </h2>
    <p style="color: var(--text-light); margin-bottom: 25px; font-size: 15px;">
        Ask me anything about properties in Batangas! Try: "Find apartments in Batangas City" or "Tell me about Lipa City"
    </p>
    
    <div class="chatbot-container">
        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="avatar">ü§ñ</div>
                <div class="content">
                    <p>Hello! I'm your AI property assistant. How can I help you find properties in Batangas today?</p>
                    <p>Try asking me:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>"Find apartments in Batangas City"</li>
                        <li>"Show me houses under 3M with 3 bedrooms"</li>
                        <li>"Tell me about Lipa City"</li>
                        <li>"Properties that accept bank financing"</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Type your property question here..." />
            <button id="sendChatBtn">
                <i class="fas fa-paper-plane"></i> Send
            </button>
            <button id="voiceInputBtn" class="voice-btn">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>
</div>

<!-- AI Recommendations Section -->
<div id="recommendedSection" class="recommendations-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        <div>
            <h2 class="section-title">
                <i class="fas fa-robot"></i>
                AI Recommendations For You
            </h2>
            <p style="color: var(--text-light); font-size: 15px; margin-top: 5px;" id="recommendationsSubtitle">
                Based on your saved properties and search history
            </p>
        </div>
        <button id="refreshRecommendationsBtn" class="search-button" style="padding: 12px 24px; font-size: 14px;">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    <div id="recommendedListingsContainer" class="recommendations-grid">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading AI recommendations...</p>
        </div>
    </div>
</div>

<!-- Categories Section -->
<div class="categories-section">
    <h2 class="section-title">
        <i class="fas fa-th-large"></i>
        Batangas Property Categories
    </h2>
    <p style="color: var(--text-light); margin-bottom: 25px; font-size: 15px;">
        Browse properties by category in Batangas
    </p>

    <div class="categories-grid" id="categoriesContainer">
        <!-- Categories will be loaded dynamically -->
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading categories...</p>
        </div>
    </div>
</div>

<!-- All Properties Section -->
<div class="properties-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
        <div>
            <h2 class="section-title">
                <i class="fas fa-building"></i>
                All Properties in Batangas
            </h2>
            <p style="color: var(--text-light); margin-bottom: 0; font-size: 15px;" id="propertiesCount">
                Loading properties...
            </p>
        </div>
        <button class="search-button" onclick="viewAllProperties()" style="padding: 12px 24px;">
            <i class="fas fa-eye"></i> View All Properties
        </button>
    </div>

    <!-- Properties Grid -->
    <div class="listings-grid" id="listingsContainer">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading properties...</p>
        </div>
    </div>
</div>
</div>

<!-- Sidebar Loader -->
<script src="../sidebar-user.js"></script>
<script src="buyer-sidebar-loader.js"></script>
<script>
function scrollToAiChatbot() {
    const el = document.getElementById('ai-chatbot-section');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
document.addEventListener('DOMContentLoaded', function() {
    loadBuyerSidebar('buyer_dashboard.html');
    // Scroll to AI chatbot section when navigated via sidebar AI Assistant link
    if (window.location.hash === '#ai-chatbot-section') scrollToAiChatbot();
});
window.addEventListener('hashchange', function() {
    if (window.location.hash === '#ai-chatbot-section') scrollToAiChatbot();
});

window.viewAllProperties = function() {
    window.location.href = 'search_results.html';
};

// Update total properties count
function updateTotalPropertiesCount(count) {
    const totalPropertiesEl = document.getElementById('totalProperties');
    if (totalPropertiesEl) {
        totalPropertiesEl.textContent = count;
    }
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import {
    getAuth,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    getDoc,
    doc,
    addDoc,
    deleteDoc,
    onSnapshot,
    orderBy,
    serverTimestamp,
    updateDoc,
    setDoc
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Make signOut available globally for the logout button
window.performLogout = async function() {
    try {
        await signOut(auth);
        window.location.href = "../login.html";
    } catch (error) {
        console.error("Logout error:", error);
        alert("Error logging out. Please try again.");
    }
};

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCIfzneDzWVveG8p_0mywoA9D9F5AyzZX4",
    authDomain: "bahai-1b76d.firebaseapp.com",
    projectId: "bahai-1b76d",
    storageBucket: "bahai-1b76d.firebasestorage.app",
    messagingSenderId: "646878644941",
    appId: "1:646878644941:web:5b4ccc3412250337587784"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Expose for sidebar
window.firebaseApp = app;
window.firebaseAuth = auth;
window.firebaseDB = db;

// Global variables
let allListings = [];
let userMap = new Map();
let selectedCategory = '';
let currentConversationId = null;
let messageListener = null;

// Welcome text element
const welcomeText = document.getElementById("welcomeText");
const guestMessage = document.getElementById("guestMessage");

// --- MESSAGING SYSTEM FUNCTIONS ---

// Initialize messaging event listeners
function initializeMessagingListeners() {
    // Send message button
    const sendBtn = document.getElementById('sendMessageBtn');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // Message input enter key support
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Close message modal button
    const closeMessageBtn = document.getElementById('closeMessageModal');
    if (closeMessageBtn) {
        closeMessageBtn.addEventListener('click', closeMessageModal);
    }
    
    // Close modal when clicking outside
    const messageModal = document.getElementById('messageModal');
    if (messageModal) {
        messageModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });
    }
}

// Contact broker function (for use in onclick attributes)
window.contactBroker = async function(userId, propertyId = null) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert('Please log in to contact brokers. You can browse properties as a guest, but need to sign in to send messages.');
        const redirect = encodeURIComponent(window.location.pathname + (window.location.search || ''));
        window.location.href = "../login.html?redirect=" + (redirect || encodeURIComponent('buyer/buyer_dashboard.html'));
        return;
    }

    const userInfo = userMap.get(userId);
    if (!userInfo) {
        alert('Broker information not available');
        return;
    }

    // Generate conversation ID (sorted combination of both user IDs)
    currentConversationId = [currentUser.uid, userId].sort().join('_');
    
    // Get property info for context
    const property = allListings.find(l => l.userId === userId);
    
    // Update messaging modal UI
    updateMessagingModal(userInfo, property);
    
    // Show messaging modal
    const messageModal = document.getElementById('messageModal');
    messageModal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Load existing messages
    loadMessages(currentConversationId, userId);
    
    // Focus on message input
    setTimeout(() => {
        document.getElementById('messageInput').focus();
    }, 300);
};

// Update messaging modal with broker info
function updateMessagingModal(userInfo, property) {
    const brokerName = userInfo.displayName || 'Broker';
    const brokerRole = userInfo.role === 'landlord' ? 'Property Owner' : 
                     userInfo.role === 'broker' ? 'Licensed Broker' : 
                     'Property Contact';
    
    // Set modal title and info (with ellipsis for long names)
    const modalTitle = document.getElementById('messageBrokerName');
    modalTitle.textContent = `Message ${brokerName}`;
    if (modalTitle.scrollWidth > modalTitle.clientWidth) {
        modalTitle.title = brokerName;
        modalTitle.textContent = `Message ${brokerName.length > 20 ? brokerName.substring(0, 20) + '...' : brokerName}`;
    }
    
    document.getElementById('messageBrokerRole').textContent = brokerRole;
    
    // Set broker name with ellipsis if too long
    const brokerNameElement = document.getElementById('messageBrokerFullName');
    brokerNameElement.textContent = brokerName;
    if (brokerNameElement.scrollWidth > brokerNameElement.clientWidth) {
        brokerNameElement.title = brokerName;
        brokerNameElement.textContent = brokerName.length > 25 ? brokerName.substring(0, 25) + '...' : brokerName;
    }
    
    document.getElementById('messageBrokerType').textContent = brokerRole;
    document.getElementById('messageBrokerContact').textContent = userInfo.email || 'Email not available';

    // Set broker avatar initials
    const initials = brokerName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 'B';
    document.getElementById('messageBrokerAvatar').textContent = initials;
    
    // Update contact info with ellipsis
    const emailInfo = document.getElementById('brokerEmailInfo');
    const phoneInfo = document.getElementById('brokerPhoneInfo');
    
    const emailText = `üìß ${userInfo.email || 'Email not available'}`;
    emailInfo.textContent = emailText;
    emailInfo.title = userInfo.email || 'Email not available';
    
    const phoneText = `üìû ${userInfo.phone || 'Phone not available'}`;
    phoneInfo.textContent = phoneText;
    phoneInfo.title = userInfo.phone || 'Phone not available';
    
    // Setup quick contact buttons
    const quickEmailBtn = document.getElementById('quickEmailBtn');
    const quickCallBtn = document.getElementById('quickCallBtn');
    
    if (userInfo.email) {
        const subject = property ? `Inquiry about: ${property.title}` : 'Property Inquiry';
        const body = property ? `Hello ${brokerName},\n\nI'm interested in your property: ${property.title}\n\nPlease send me more information.` : '';
        quickEmailBtn.href = `mailto:${userInfo.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        quickEmailBtn.style.display = 'flex';
    } else {
        quickEmailBtn.style.display = 'none';
    }
    
    if (userInfo.phone) {
        quickCallBtn.href = `tel:${userInfo.phone}`;
        quickCallBtn.style.display = 'flex';
    } else {
        quickCallBtn.style.display = 'none';
    }
    
    // Set up message input placeholder with property context
    const messageInput = document.getElementById('messageInput');
    if (property) {
        const propertyTitle = property.title || 'property';
        const truncatedTitle = propertyTitle.length > 50 ? propertyTitle.substring(0, 50) + '...' : propertyTitle;
        messageInput.placeholder = `Hi ${brokerName}, I'm interested in ${truncatedTitle}. Could you please provide more details about...`;
    } else {
        messageInput.placeholder = `Type your message here...`;
    }
}

// Load messages for a conversation
function loadMessages(conversationId, brokerId) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Clear any existing listener
    if (messageListener) {
        messageListener();
        messageListener = null;
    }
    
    // Show loading state
    messagesContainer.innerHTML = `
        <div class="loading-messages">
            <div class="spinner"></div>
            <p>Loading messages...</p>
        </div>
    `;
    
    console.log('üîç Attempting to load messages for conversation:', conversationId);
    
    try {
        // Query messages for this conversation
        const messagesRef = collection(db, 'messages');
        const messagesQuery = query(
            messagesRef,
            where('conversationId', '==', conversationId),
            orderBy('timestamp', 'asc')
        );
        
        console.log('üìã Query created, listening for messages...');
        
        // Listen for real-time updates
        messageListener = onSnapshot(messagesQuery, 
            (snapshot) => {
                console.log('üì® Snapshot received, docs:', snapshot.size);
                
                messagesContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    console.log('üì≠ No messages found in conversation');
                    messagesContainer.innerHTML = `
                        <div class="no-messages">
                            <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                            <h3>No messages yet</h3>
                            <p>Start the conversation by sending a message below.</p>
                        </div>
                    `;
                    return;
                }
                
                const currentUser = auth.currentUser;
                
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const isSent = message.senderId === currentUser.uid;
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                    
                    // Format timestamp
                    let timestamp = 'Just now';
                    if (message.timestamp) {
                        const date = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                        timestamp = formatMessageTime(date);
                    }
                    
                    const messageContent = document.createElement('div');
                    messageContent.className = 'message-bubble-content';
                    
                    let statusIndicator = '';
                    if (isSent) {
                        statusIndicator = `<span class="message-status" style="margin-left: 5px; font-size: 10px;">‚úì</span>`;
                    }
                    
                    messageContent.innerHTML = `
                        <div>${message.text}</div>
                        <span class="message-time">${timestamp}${statusIndicator}</span>
                    `;
                    
                    messageElement.appendChild(messageContent);
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
                
            }, 
            (error) => {
                console.error('‚ùå Error in onSnapshot listener:', error);
                
                messagesContainer.innerHTML = `
                    <div class="no-messages">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                        <h3>Start a conversation</h3>
                        <p>Send a message to begin chatting with the broker.</p>
                    </div>
                `;
            }
        );
        
    } catch (error) {
        console.error('üí• Error setting up message listener:', error);
        messagesContainer.innerHTML = `
            <div class="no-messages">
                <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                <h3>Ready to chat</h3>
                <p>Send your first message below to start the conversation.</p>
            </div>
        `;
    }
}

// Send message function
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();
    const sendBtn = document.getElementById('sendMessageBtn');
    
    if (!messageText) {
        messageInput.focus();
        return;
    }
    
    if (!currentConversationId || !auth.currentUser) {
        alert('Unable to send message. Please refresh and try again.');
        return;
    }
    
    // Get broker ID from conversation ID
    const conversationParts = currentConversationId.split('_');
    const brokerId = conversationParts.find(id => id !== auth.currentUser.uid);
    
    if (!brokerId) {
        alert('Unable to identify recipient.');
        return;
    }
    
    // Disable send button and show loading
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<div class="spinner" style="border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; width: 16px; height: 16px;"></div>';
    sendBtn.disabled = true;
    messageInput.disabled = true;
    
    try {
        // Get property ID for context
        const property = allListings.find(l => l.userId === brokerId);
        const propertyId = property?.id;
        
        // Create conversation document if it doesn't exist
        const conversationRef = doc(db, 'conversations', currentConversationId);
        const conversationSnap = await getDoc(conversationRef);
        
        const conversationData = {
            participants: [auth.currentUser.uid, brokerId],
            lastMessage: messageText.substring(0, 100),
            lastMessageTime: serverTimestamp(),
            lastSenderId: auth.currentUser.uid,
            unreadCount: {
                [brokerId]: (conversationSnap.exists() ? 
                    (conversationSnap.data().unreadCount?.[brokerId] || 0) + 1 : 1)
            },
            buyerId: auth.currentUser.uid,
            brokerId: brokerId,
            propertyId: propertyId || null,
            propertyTitle: property?.title || null,
            buyerName: auth.currentUser.displayName || auth.currentUser.email,
            createdAt: conversationSnap.exists() ? 
                conversationSnap.data().createdAt : serverTimestamp(),
            updatedAt: serverTimestamp()
        };
        
        // Update or create conversation
        await setDoc(conversationRef, conversationData, { merge: true });
        
        // Add message to messages collection
        const messageData = {
            conversationId: currentConversationId,
            senderId: auth.currentUser.uid,
            receiverId: brokerId,
            text: messageText,
            timestamp: serverTimestamp(),
            read: false,
            createdAt: serverTimestamp(),
            type: 'text',
            propertyId: propertyId || null,
            senderName: auth.currentUser.displayName || auth.currentUser.email
        };
        
        await addDoc(collection(db, 'messages'), messageData);
        
        console.log('‚úÖ Message sent successfully');
        
        // Clear input and reset UI
        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.disabled = false;
        
        // Show success feedback
        sendBtn.innerHTML = '‚úì Sent';
        sendBtn.style.background = '#10b981';
        
        setTimeout(() => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Send Message</span>';
            sendBtn.style.background = '';
            sendBtn.disabled = false;
        }, 1500);
        
        // Scroll to bottom of messages
        const messagesContainer = document.getElementById('messagesContainer');
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Error sending message:', error);
        
        // Reset UI
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        messageInput.disabled = false;
        
        // Show user-friendly error
        let errorMessage = 'Failed to send message. ';
        if (error.code === 'permission-denied') {
            errorMessage += 'You do not have permission to send messages.';
        } else if (error.code === 'unavailable') {
            errorMessage += 'Network error. Please check your connection.';
        } else {
            errorMessage += 'Please try again.';
        }
        
        alert(errorMessage);
    }
}

// Format message timestamp
function formatMessageTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

// Close messaging modal
function closeMessageModal() {
    const messageModal = document.getElementById('messageModal');
    messageModal.classList.remove('show');
    document.body.style.overflow = 'auto';
    
    // Clean up message listener
    if (messageListener) {
        messageListener();
        messageListener = null;
    }
    
    currentConversationId = null;
    
    // Clear message input
    document.getElementById('messageInput').value = '';
}

// --- MAIN APPLICATION LOGIC ---

// Property category and type mappings based on transaction type
const PROPERTY_CATEGORIES = {
    'rent': [
        { category: 'Residential Property', types: ['Apartment', 'Condominium', 'Room / Bedspace', 'House', 'Dormitory'] },
        { category: 'Commercial Property', types: ['Office Unit', 'Retail Space / Shop', 'Food Stall / Kiosk'] },
        { category: 'Industrial Property', types: ['Warehouse', 'Factory', 'Storage Unit'] }
    ],
    'lease': [
        { category: 'Commercial Property', types: ['Office Floor', 'Commercial Building', 'Warehouse'] },
        { category: 'Land / Lot', types: ['Agricultural Lot', 'Commercial Lot', 'Industrial Lot'] },
        { category: 'Special Purpose Property', types: ['Resort Property', 'Event Venue', 'School Property', 'Sports Facility'] }
    ],
    'sale': [
        { category: 'Residential Property', types: ['House', 'Townhouse', 'Condominium', 'Apartment'] },
        { category: 'Commercial Property', types: ['Office Space', 'Retail Space / Shop', 'Commercial Building'] },
        { category: 'Land / Lot', types: ['Residential Lot', 'Commercial Lot', 'Agricultural Lot'] }
    ]
};

// Define the 6 categories with their property types
const BATANGAS_PROPERTY_CATEGORIES = [
    {
        name: 'Residential Property',
        icon: 'üè†',
        description: 'Properties intended for living or dwelling',
        propertyTypes: ['House', 'Apartment', 'Condominium', 'Townhouse', 'Dormitory', 'Room / Bedspace', 'Bungalow', 'Duplex']
    },
    {
        name: 'Commercial Property',
        icon: 'üè¢',
        description: 'Properties used for business and income generation',
        propertyTypes: ['Office Unit', 'Office Floor', 'Office Space', 'Retail Space / Shop', 'Commercial Building', 'Food Stall / Kiosk', 'Showroom']
    },
    {
        name: 'Industrial Property',
        icon: 'üè≠',
        description: 'Properties for storage, production, and logistics',
        propertyTypes: ['Warehouse', 'Factory', 'Storage Unit', 'Workshop']
    },
    {
        name: 'Land / Lot',
        icon: 'üå≥',
        description: 'Undeveloped or semi-developed land for future use',
        propertyTypes: ['Residential Lot', 'Commercial Lot', 'Agricultural Land', 'Industrial Lot', 'Development Land', 'Vacant Lot', 'Beachfront Property']
    },
    {
        name: 'Special Purpose Property',
        icon: 'üéØ',
        description: 'Properties with specific or institutional functions',
        propertyTypes: ['Resort Property', 'Event Venue', 'School Property', 'Sports Facility', 'Parking Area', 'Hospitality Property']
    },
    {
        name: 'Condominium',
        icon: 'üèôÔ∏è',
        description: 'Condominium units and complexes',
        propertyTypes: ['Condominium Unit', 'Penthouse', 'Studio Unit', 'Loft Unit']
    }
];

// Google Maps API Key
const GOOGLE_MAPS_API_KEY = "AIzaSyBwwAkIEixeUysaGrMb9BtTsMwz_C9Noxk";

// Python Backend URL
const PYTHON_API_URL = "https://us-central1-bahai-1b76d.cloudfunctions.net/personalized_recommendations";

// --- HELPER FUNCTIONS ---

function getRoleDisplayText(role) {
    const roleMap = {
        'landlord': 'Property Owner',
        'seller': 'Property Seller',
        'broker': 'Licensed Broker',
        'agent': 'Property Agent',
        'admin': 'Administrator'
    };
    return roleMap[role] || 'Posted by';
}

function getListingType(listing) {
    if (listing.listingType === 'lease' || listing.type === 'lease') {
        return 'lease';
    }

    if (listing.listingType === 'rent' || listing.type === 'rent') {
        return 'rent';
    }

    if (listing.listingType === 'sale' || listing.type === 'sale') {
        return 'sale';
    }

    if (listing.monthlyRent !== undefined && listing.monthlyRent !== null && listing.monthlyRent > 0) {
        return 'rent';
    }

    if (listing.annualRent !== undefined && listing.annualRent !== null && listing.annualRent > 0) {
        return 'lease';
    }

    if ((listing.pricing !== undefined && listing.pricing !== null && listing.pricing > 0) ||
        (listing.salePrice !== undefined && listing.salePrice !== null && listing.salePrice > 0)) {
        return 'sale';
    }

    return 'sale';
}

function getDisplayPrice(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return `‚Ç±${(listing.monthlyRent || 0).toLocaleString()}/month`;
        case 'lease':
            const annualRent = listing.annualRent || 0;
            return `‚Ç±${annualRent.toLocaleString()}/year`;
        case 'sale':
        default:
            return `‚Ç±${(listing.pricing || listing.salePrice || 0).toLocaleString()}`;
    }
}

function getNumericPrice(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return listing.monthlyRent || 0;
        case 'lease':
            return listing.annualRent || 0;
        case 'sale':
        default:
            return listing.pricing || listing.salePrice || 0;
    }
}

function getPriceClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'price-rent';
        case 'lease':
            return 'price-lease';
        case 'sale':
        default:
            return 'price-sale';
    }
}

function getTypeBadgeClass(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'type-rent';
        case 'lease':
            return 'type-lease';
        case 'sale':
        default:
            return 'type-sale';
    }
}

function getTypeBadgeText(listing) {
    const type = getListingType(listing);

    switch (type) {
        case 'rent':
            return 'FOR RENT';
        case 'lease':
            return 'FOR LEASE';
        case 'sale':
        default:
            return 'FOR SALE';
    }
}

function getCompleteAddress(listing) {
    const primaryAddress = listing.address || listing.location || listing.title || '';
    
    let fullAddress = primaryAddress;
    
    if (listing.city) {
        fullAddress += ', ' + listing.city;
    }
    
    if (listing.province && listing.province !== 'Calabarzon') {
        fullAddress += ', ' + listing.province;
    }
    
    if (!listing.province && listing.city) {
        fullAddress += ', Philippines';
    }
    
    return fullAddress || 'Batangas, Philippines';
}

// --- CATEGORY DROPDOWN FUNCTIONS ---

// Update category dropdown based on selected transaction type
function updateCategoryDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const categorySelect = document.getElementById('filterPropertyCategory');
    const typeSelect = document.getElementById('filterPropertyType');

    // Reset both dropdowns
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && PROPERTY_CATEGORIES[transactionType]) {
        // Populate categories based on transaction type
        PROPERTY_CATEGORIES[transactionType].forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.category;
            option.textContent = cat.category;
            categorySelect.appendChild(option);
        });
    } else {
        // If no transaction type selected, show all possible categories
        const allCategories = new Set();
        Object.values(PROPERTY_CATEGORIES).forEach(cats => {
            cats.forEach(cat => allCategories.add(cat.category));
        });
        allCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }
    
    updateTypeDropdown();
}

// Update type dropdown based on selected category
function updateTypeDropdown() {
    const transactionType = document.getElementById('filterListingType').value;
    const category = document.getElementById('filterPropertyCategory').value;
    const typeSelect = document.getElementById('filterPropertyType');

    typeSelect.innerHTML = '<option value="">All Types</option>';

    if (transactionType && category && PROPERTY_CATEGORIES[transactionType]) {
        const categoryData = PROPERTY_CATEGORIES[transactionType].find(cat => cat.category === category);
        if (categoryData && categoryData.types) {
            categoryData.types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }
    }
}

// --- FILTER FUNCTIONS ---

// Apply filters - redirects to search results page
async function applyFilters() {
    const filters = {};
    const location = document.getElementById('filterLocation').value;
    const transactionType = document.getElementById('filterListingType').value;
    const propertyCategory = document.getElementById('filterPropertyCategory').value;
    const propertyType = document.getElementById('filterPropertyType').value;
    const searchTerm = document.getElementById('filterName').value;

    if (location) filters.location = location;
    if (transactionType) filters.transactionType = transactionType;
    if (propertyCategory) filters.propertyCategory = propertyCategory;
    if (propertyType) filters.propertyType = propertyType;
    if (searchTerm) filters.searchTerm = searchTerm;

    // Log search event for recommendations (only for logged-in users)
    try {
        const currentUser = auth.currentUser;
        if (currentUser && Object.keys(filters).length > 0) {
            await logSearchEvent(currentUser.uid, filters);
        }
    } catch (error) {
        console.log('Could not log search event:', error.message);
    }

    // Redirect to search results page with filters as URL parameters
    const queryString = Object.keys(filters).length > 0
        ? `?filters=${encodeURIComponent(JSON.stringify(filters))}`
        : '';

    window.location.href = `search_results.html${queryString}`;
}

// Simple logSearchEvent function
async function logSearchEvent(userId, filters) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'search',
            metadata: { filters: filters },
            timestamp: new Date()
        });
        return true;
    } catch (error) {
        console.error("Failed to log search event:", error);
        return false;
    }
}

// Simple logSaveEvent function
async function logSaveEvent(userId, propertyId) {
    try {
        const eventsRef = collection(db, 'events');
        await addDoc(eventsRef, {
            userId: userId,
            eventType: 'save',
            metadata: { propertyId: propertyId },
            timestamp: new Date()
        });
        return true;
    } catch (error) {
        console.error("Failed to log save event:", error);
        return false;
    }
}

// Reset filters function
function resetFilters() {
    document.getElementById('filterLocation').value = "";
    document.getElementById('filterListingType').value = "";
    document.getElementById('filterPropertyCategory').value = "";
    document.getElementById('filterPropertyType').value = "";
    document.getElementById('filterName').value = "";
    selectedCategory = "";
    
    // Reset dropdowns to default state
    updateCategoryDropdown();
    
    // Update UI
    updateCategoryUI();
    
    // Show all active listings
    displayFilteredListings();
}

// --- CATEGORIES FUNCTIONS ---

async function loadCategories() {
    const container = document.getElementById('categoriesContainer');

    try {
        // Calculate counts for each category based on actual listings
        const activeListings = allListings.filter(listing => 
            listing.status === 'active' ||
            listing.status === 'available' ||
            listing.status === 'Active' ||
            (listing.status === undefined && listing.isActive !== false)
        );

        // Create categories with calculated counts
        const categories = BATANGAS_PROPERTY_CATEGORIES.map((category, index) => {
            let count = 0;

            // Count properties for this category using better matching logic
            activeListings.forEach(listing => {
                const propertyType = (listing.propertyType || '').toLowerCase();
                const propertyCategory = (listing.propertyCategory || '').toLowerCase();
                const listingTitle = (listing.title || '').toLowerCase();
                const listingDescription = (listing.description || '').toLowerCase();
                const searchText = `${propertyType} ${propertyCategory} ${listingTitle} ${listingDescription}`;

                // Check if property matches this category
                let matchesCategory = false;

                // First, check if property type matches any of this category's property types
                for (const type of category.propertyTypes) {
                    const typeLower = type.toLowerCase();
                    // Direct property type match
                    if (propertyType === typeLower || propertyType.includes(typeLower)) {
                        matchesCategory = true;
                        break;
                    }
                }

                // If no direct match, check using category-specific keywords
                if (!matchesCategory) {
                    switch(category.name) {
                        case 'Residential Property':
                            const residentialKeywords = ['house', 'apartment', 'condo', 'condominium', 'townhouse', 'dormitory', 'room', 'bedspace', 'residential', 'home', 'villa', 'bungalow', 'duplex'];
                            matchesCategory = residentialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Commercial Property':
                            const commercialKeywords = ['commercial', 'office', 'retail', 'shop', 'kiosk', 'stall', 'store', 'mall', 'business', 'establishment', 'showroom'];
                            matchesCategory = commercialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Industrial Property':
                            const industrialKeywords = ['industrial', 'warehouse', 'factory', 'storage', 'manufacturing', 'plant', 'facility', 'workshop'];
                            matchesCategory = industrialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Land / Lot':
                            const landKeywords = ['land', 'lot', 'plot', 'agricultural', 'farm', 'agriculture', 'property', 'vacant', 'empty', 'beachfront'];
                            matchesCategory = landKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Special Purpose Property':
                            const specialKeywords = ['resort', 'event', 'venue', 'school', 'sports', 'facility', 'special', 'purpose', 'institutional', 'hotel', 'motel', 'inn', 'parking', 'hospitality'];
                            matchesCategory = specialKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                        case 'Condominium':
                            const condoKeywords = ['condominium', 'condo', 'penthouse', 'studio unit', 'loft unit'];
                            matchesCategory = condoKeywords.some(keyword => 
                                searchText.includes(keyword) || 
                                propertyType.includes(keyword) || 
                                propertyCategory.includes(keyword)
                            );
                            break;
                    }
                }

                if (matchesCategory) {
                    count++;
                }
            });

            return {
                ...category,
                count: count,
                number: index + 1
            };
        });

        // Render categories
        container.innerHTML = categories.map(category => `
            <div class="category-card ${selectedCategory === category.name ? 'active' : ''}" 
                 data-category="${category.name}">
                <div class="category-icon">${category.icon}</div>
                <div class="category-name">${category.name}</div>
                <div class="category-count">${category.count} Properties</div>
                <div style="margin-top: 15px; text-align: left; font-size: 13px; color: ${selectedCategory === category.name ? 'rgba(255,255,255,0.9)' : 'var(--text-light)'}">
                    <div style="margin-bottom: 8px; font-style: italic;">${category.description}</div>
                </div>
            </div>
        `).join('');

        // Add event listeners to category cards
        document.querySelectorAll('.category-card[data-category]').forEach(card => {
            card.addEventListener('click', function() {
                const categoryName = this.getAttribute('data-category');
                filterByCategory(categoryName);
            });
        });

    } catch (error) {
        console.error("Error loading categories:", error);
        container.innerHTML = `
            <div class="error-state">
                <div class="error-icon">‚ö†Ô∏è</div>
                <p>Error loading categories</p>
            </div>
        `;
    }
}

// Filter by category function
async function filterByCategory(categoryName) {
    const filters = { propertyCategory: categoryName };

    // Log category click as a search event for recommendations (only for logged-in users)
    try {
        const currentUser = auth.currentUser;
        if (currentUser) {
            await logSearchEvent(currentUser.uid, filters);
        }
    } catch (error) {
        console.log('Could not log category search event.', error.message);
    }

    // Store in localStorage for search results page
    localStorage.setItem('categoryFilter', categoryName);

    // Redirect to search results page with category filter
    const queryString = `?filters=${encodeURIComponent(JSON.stringify(filters))}`;
    window.location.href = `search_results.html${queryString}`;
}

// Update category UI
function updateCategoryUI() {
    document.querySelectorAll('.category-card').forEach(card => {
        const categoryName = card.getAttribute('data-category');
        if (categoryName === selectedCategory) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
}

// --- LISTINGS FUNCTIONS ---

async function loadAllListings() {
    try {
        console.log('üîÑ Loading all listings for Batangas...');
        
        // Fetch ALL properties
        const listingsQuery = query(collection(db, "properties"));
        const querySnapshot = await getDocs(listingsQuery);
        
        allListings = [];
        const userIds = new Set();
        
        querySnapshot.forEach((doc) => {
            const listing = {
                id: doc.id,
                ...doc.data()
            };
            allListings.push(listing);
            
            // Collect user IDs
            if (listing.userId) {
                userIds.add(listing.userId);
            } else if (listing.ownerId) {
                userIds.add(listing.ownerId);
            }
        });
        
        console.log(`   Found ${allListings.length} listings total`);
        
        // Update total properties count
        updateTotalPropertiesCount(allListings.length);
        
        await loadAllUserData(userIds);
        
        // Display all active listings initially
        displayFilteredListings();
        
        // Update categories after loading listings
        loadCategories();
        
    } catch (error) {
        console.error("   Error loading listings:", error);
        displayError(error);
    }
}

async function loadAllUserData(userIds) {
    userMap.clear();
    
    if (userIds.size === 0) return;
    
    for (const userId of userIds) {
        await loadUserData(userId);
    }
}

async function loadUserData(userId) {
    try {
        console.log(`üîç Attempting to load user: ${userId}`);
        
        // Only check users collection (both landlords and brokers are in users collection)
        const userDoc = await getDoc(doc(db, "users", userId));
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            console.log(`‚úÖ Found user ${userId} in database. Data:`, {
                fullName: userData.fullName,
                firstName: userData.firstName,
                lastName: userData.lastName,
                email: userData.email,
                role: userData.role
            });
            
            // Extract fullName with proper fallback
            let fullName = userData.fullName || '';
            
            // If no fullName, try to construct from firstName and lastName
            if (!fullName && (userData.firstName || userData.lastName)) {
                fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            }
            
            // If still no name, use email or default
            if (!fullName) {
                fullName = userData.email?.split('@')[0] || `User ${userId.substring(0, 8)}`;
            }
            
            const userInfo = {
                displayName: fullName.trim(),
                email: userData.email || 'Email not available',
                phone: userData.phone || 'Phone not available',
                role: userData.role || 'user',
                photoURL: userData.photoURL || userData.profilePhotoURL || null
            };
            
            userMap.set(userId, userInfo);
            
            console.log(`‚úÖ Loaded user ${userId}: "${userInfo.displayName}" (${userInfo.role})`);
            return;
        }
        
        // Fallback: try brokers collection (some brokers store profile there)
        const brokerDoc = await getDoc(doc(db, "brokers", userId));
        if (brokerDoc.exists()) {
            const brokerData = brokerDoc.data();
            const fullName = brokerData.fullName || brokerData.name || brokerData.email?.split('@')[0] || `User ${userId.substring(0, 8)}`;
            userMap.set(userId, {
                displayName: fullName.trim(),
                email: brokerData.email || 'Email not available',
                phone: brokerData.phone || 'Phone not available',
                role: 'broker',
                photoURL: brokerData.photoURL || brokerData.profilePhoto || brokerData.profileImage || null
            });
            return;
        }
        
        // Default fallback if user not found
        console.warn(`‚ùå User ${userId} not found in users collection`);
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user',
            photoURL: null
        });
        
    } catch (error) {
        console.error(`‚ùå Error loading user ${userId}:`, error);
        userMap.set(userId, {
            displayName: `User ${userId.substring(0, 8)}`,
            email: 'Email not available',
            phone: 'Phone not available',
            role: 'user',
            photoURL: null
        });
    }
}

async function checkSavedStatus(listings) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return new Map();
        
        const savedRef = collection(db, 'savedProperties');
        const q = query(savedRef, where('userId', '==', currentUser.uid));
        const snapshot = await getDocs(q);
        
        const savedMap = new Map();
        snapshot.forEach(doc => {
            savedMap.set(doc.data().propertyId, true);
        });
        
        return savedMap;
    } catch (error) {
        console.error("Error checking saved status:", error);
        return new Map();
    }
}

// Display filtered listings - DASHBOARD ONLY SHOWS ALL ACTIVE PROPERTIES
function displayFilteredListings() {
    // Filter only active listings
    let filtered = allListings.filter(listing => {
        return listing.status === 'active' || 
               listing.status === 'available' || 
               listing.status === 'Active' || 
               (listing.status === undefined && listing.isActive !== false);
    });

    // Apply selected category filter ONLY (no search filters in dashboard)
    if (selectedCategory) {
        const categoryData = BATANGAS_PROPERTY_CATEGORIES.find(cat => cat.name === selectedCategory);
        if (categoryData) {
            filtered = filtered.filter(listing => {
                const propertyType = (listing.propertyType || '').toLowerCase();
                const propertyCategory = (listing.propertyCategory || '').toLowerCase();
                const listingTitle = (listing.title || '').toLowerCase();
                const listingDescription = (listing.description || '').toLowerCase();
                const searchText = `${propertyType} ${propertyCategory} ${listingTitle} ${listingDescription}`;

                // Check if property matches any of the category's property types
                for (const type of categoryData.propertyTypes) {
                    const typeLower = type.toLowerCase();
                    // Direct match
                    if (propertyType === typeLower || propertyCategory === typeLower) {
                        return true;
                    }
                    // Partial match
                    if (propertyType.includes(typeLower) || typeLower.includes(propertyType)) {
                        return true;
                    }
                    // Keyword match in search text
                    if (searchText.includes(typeLower)) {
                        return true;
                    }
                }

                // Special keyword matching for each category
                if (selectedCategory === 'Residential Property') {
                    const residentialKeywords = ['house', 'apartment', 'condo', 'condominium', 'townhouse', 'dormitory', 'room', 'bedspace', 'residential', 'home', 'villa'];
                    return residentialKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Commercial Property') {
                    const commercialKeywords = ['commercial', 'office', 'retail', 'shop', 'kiosk', 'stall', 'store', 'mall', 'business', 'establishment'];
                    return commercialKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Industrial Property') {
                    const industrialKeywords = ['industrial', 'warehouse', 'factory', 'storage', 'manufacturing', 'plant', 'facility'];
                    return industrialKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Land / Lot') {
                    const landKeywords = ['land', 'lot', 'plot', 'agricultural', 'farm', 'agriculture', 'property', 'vacant', 'empty'];
                    return landKeywords.some(keyword => searchText.includes(keyword));
                }

                if (selectedCategory === 'Special Purpose Property') {
                    const specialKeywords = ['resort', 'event', 'venue', 'school', 'sports', 'facility', 'special', 'purpose', 'institutional', 'hotel', 'motel', 'inn'];
                    return specialKeywords.some(keyword => searchText.includes(keyword));
                }

                return false;
            });
        }
    }

    // Update properties count text
    const propertiesCount = document.getElementById('propertiesCount');
    if (propertiesCount) {
        if (selectedCategory) {
            propertiesCount.textContent = `Showing ${filtered.length} ${selectedCategory} properties in Batangas`;
        } else {
            propertiesCount.textContent = `Showing ${filtered.length} properties in Batangas`;
        }
    }

    // Display filtered listings
    if (filtered.length === 0) {
        displayNoListings();
    } else {
        displayListings(filtered);
    }
}

async function displayListings(listings) {
  const container = document.getElementById('listingsContainer');
  
  // Check which properties are already saved (only for logged-in users)
  const savedMap = auth.currentUser ? await checkSavedStatus(listings) : new Map();
  
  container.innerHTML = listings.map(listing => {
    const isSaved = savedMap.has(listing.id);
    const userInfo = userMap.get(listing.userId) || {
      displayName: `User ${listing.userId ? listing.userId.substring(0, 8) : 'Unknown'}`,
      email: 'N/A',
      phone: 'N/A',
      role: 'user',
      photoURL: null
    };
    
    const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
    const brokerAvatarHtml = userInfo.photoURL
      ? `<img src="${userInfo.photoURL}" alt="${(userInfo.displayName || '').replace(/"/g, '&quot;')}" onerror="var p=this.parentElement;p.innerHTML=p.getAttribute('data-fallback')||'U'">`
      : userInitials;
    const brokerAvatarWrapper = userInfo.photoURL
      ? `<div class="broker-avatar" data-fallback="${(userInitials || 'U').replace(/"/g, '&quot;')}" aria-label="Broker avatar">${brokerAvatarHtml}</div>`
      : `<div class="broker-avatar" aria-label="Broker avatar">${userInitials}</div>`;
    const listingType = getListingType(listing);
    const displayPrice = getDisplayPrice(listing);
    const priceClass = getPriceClass(listing);
    const typeBadgeClass = getTypeBadgeClass(listing);
    const typeBadgeText = getTypeBadgeText(listing);
    
    let mainPhoto;
    if (listing.photos && listing.photos.length > 0) {
      mainPhoto = listing.photos[0];
    } else if (listing.imageUrls && listing.imageUrls.length > 0) {
      mainPhoto = listing.imageUrls[0];
    } else if (listing.latitude && listing.longitude) {
      mainPhoto = `https://maps.googleapis.com/maps/api/staticmap?center=${listing.latitude},${listing.longitude}&zoom=15&size=400x200&markers=color:red%7C${listing.latitude},${listing.longitude}&key=${GOOGLE_MAPS_API_KEY}`;
    } else {
      mainPhoto = 'https://via.placeholder.com/400x200/0b2e52/white?text=No+Image';
    }
    
    const bedrooms = listing.bedrooms || (listingType === 'rent' && listing.propertyType === 'studio' ? 'Studio' : 0);
    const bathrooms = listing.bathrooms || 0;
    const area = listing.floorArea || listing.totalArea || 'N/A';
    
    // Truncate long titles with ellipsis
    const title = listing.title || 'Untitled Property';
    const truncatedTitle = title.length > 50 ? title.substring(0, 50) + '...' : title;
    
    // Truncate address with ellipsis
    const address = getCompleteAddress(listing);
    const truncatedAddress = address.length > 40 ? address.substring(0, 40) + '...' : address;
    
    // Truncate broker name with ellipsis
    const brokerName = userInfo.displayName;
    const truncatedBrokerName = brokerName.length > 20 ? brokerName.substring(0, 20) + '...' : brokerName;
    
    // Add type badge to property card
    const typeBadge = `<div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>`;
    
    const locationDisplay = listing.location || listing.address || 'Location not specified';
    const listingTypeLabel = listingType === 'rent' ? 'For Rent' : listingType === 'lease' ? 'For Lease' : 'For Sale';
    let statusText = listing.status || 'available';
    let statusClass = 'status-active';
    let showStatus = true;
    if (statusText.toLowerCase() === 'active' || statusText.toLowerCase() === 'available' || statusText.toLowerCase() === 'published') {
      statusText = '';
      statusClass = '';
      showStatus = false;
    } else if (statusText.toLowerCase() === 'pending') {
      statusClass = 'status-pending';
    }
    
    // Determine contact button text and behavior based on auth state
    const contactButton = auth.currentUser 
      ? `<button class="action-btn contact-btn" data-user-id="${listing.userId}">
            <i class="fas fa-comment"></i> Contact Broker
         </button>`
      : `<button class="action-btn contact-btn" onclick="window.location.href='../login.html'">
            <i class="fas fa-sign-in-alt"></i> Login to Contact
         </button>`;
    
    return `
<div class="listing-card-wrapper">
    <div class="listing-card" data-listing-id="${listing.id}">
        <a href="property_details.html?id=${listing.id}" class="card-link-overlay" aria-label="View ${title}"></a>
        <div class="listing-card-image-container">
            <img src="${mainPhoto}" alt="${listing.title}" class="listing-image">
            ${typeBadge}
        </div>
        <div class="listing-content">
            <div class="listing-header">
                <div style="flex: 1; min-width: 0;">
                    <h3 class="listing-title" title="${title}">${truncatedTitle}</h3>
                </div>
                <div class="listing-price ${priceClass}">${displayPrice}</div>
            </div>
            <div class="listing-location">
                <i class="fas fa-map-marker-alt" style="flex-shrink: 0;"></i>
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${locationDisplay}">${truncatedAddress}</span>
                <span> ¬∑ ${listingTypeLabel}</span>
            </div>
            <div class="listing-details">
                <div class="detail"><i class="fas fa-bed"></i> ${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}</div>
                <div class="detail"><i class="fas fa-bath"></i> ${bathrooms} baths</div>
                <div class="detail"><i class="fas fa-ruler-combined"></i> ${area} sqm</div>
                ${listingType === 'rent' && listing.securityDeposit ? `<div class="detail"><i class="fas fa-coins"></i> Deposit: ‚Ç±${listing.securityDeposit.toLocaleString()}</div>` : ''}
            </div>
            <div class="listing-broker">
                ${brokerAvatarWrapper}
                <div class="broker-info">
                    <div class="broker-name" title="${brokerName}">${truncatedBrokerName}</div>
                    <div class="broker-contact">
                        ${getRoleDisplayText(userInfo.role)} ¬∑ ${listing.propertyType || 'Property'}
                    </div>
                </div>
            </div>
            ${showStatus ? `<div class="listing-status ${statusClass}">${statusText}</div>` : ''}
        </div>
    </div>
</div>
    `;
  }).join('');
  
    setTimeout(() => {
        setupListingEventListeners();
        makePropertyCardsClickable();  // ADD THIS LINE
        forceBadgeVisibility();
    }, 100);
}

// Add this function to make cards clickable
function makePropertyCardsClickable() {
    // Wait a moment for the DOM to update
    setTimeout(() => {
        // Get all property cards
        const cards = document.querySelectorAll('.listing-card');
        
        cards.forEach(card => {
            // Make cursor show pointer
            card.style.cursor = 'pointer';
            
            // Add click event listener
            card.addEventListener('click', function(e) {
                // Don't navigate if clicking on action buttons
                if (e.target.closest('.action-btn') || 
                    e.target.closest('button') || 
                    e.target.tagName === 'BUTTON') {
                    e.stopPropagation();
                    return;
                }
                
                // Get the listing ID from data attribute
                const listingId = this.getAttribute('data-listing-id');
                if (listingId) {
                    // Navigate to property details page
                    window.location.href = `property_details.html?id=${listingId}`;
                }
            });
            
            // Add hover effects
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px)';
                this.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.12)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.08)';
            });
        });
        
        console.log(`Made ${cards.length} property cards clickable`);
    }, 500);
}

function displayNoListings() {
    const container = document.getElementById('listingsContainer');
    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üè†</div>
            <h3>No Properties Found in Batangas</h3>
            <p>There are currently no properties available in Batangas.</p>
            <button class="search-button" id="tryAgainBtn" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>
    `;
    
    // Add event listener to Try Again button
    const tryAgainBtn = document.getElementById('tryAgainBtn');
    if (tryAgainBtn) {
        tryAgainBtn.addEventListener('click', loadAllListings);
    }
}

function displayError(error) {
    const container = document.getElementById('listingsContainer');
    container.innerHTML = `
        <div class="error-state">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3>Error Loading Properties</h3>
            <p>There was an error loading the property listings.</p>
            <button class="search-button" id="tryAgainBtn2" style="margin-top: 20px;">
                <i class="fas fa-redo"></i>
                Try Again
            </button>
        </div>
    `;
    
    // Add event listener to Try Again button
    const tryAgainBtn = document.getElementById('tryAgainBtn2');
    if (tryAgainBtn) {
        tryAgainBtn.addEventListener('click', loadAllListings);
    }
}

// --- EVENT HANDLERS ---

async function toggleSaveProperty(propertyId, buttonElement) {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert('Please login to save properties');
            window.location.href = "../login.html";
            return;
        }
        
        const isSaved = buttonElement.querySelector('.save-icon').textContent.includes('‚ù§Ô∏è');
        
        if (isSaved) {
            // Remove from saved
            const savedRef = collection(db, 'savedProperties');
            const q = query(savedRef,
                where('userId', '==', currentUser.uid),
                where('propertyId', '==', propertyId)
            );
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                await deleteDoc(snapshot.docs[0].ref);
                buttonElement.innerHTML = '<span class="save-icon">ü§ç</span>';
                buttonElement.setAttribute('data-is-saved', 'false');
                buttonElement.setAttribute('aria-label', 'Save property');
                console.log(`Property ${propertyId} removed from saved`);
                showSaveToast('Removed from saved', false);
            }
        } else {
            // Add to saved
            await addDoc(collection(db, 'savedProperties'), {
                userId: currentUser.uid,
                propertyId: propertyId,
                savedAt: new Date(),
                createdAt: new Date()
            });
            
            // Log save event
            await logSaveEvent(currentUser.uid, propertyId);
            
            buttonElement.innerHTML = '<span class="save-icon">‚ù§Ô∏è</span>';
            buttonElement.setAttribute('data-is-saved', 'true');
            buttonElement.setAttribute('aria-label', 'Remove from saved');
            console.log(`Property ${propertyId} saved`);
            showSaveToast('Property saved!', false);
        }
        if (typeof window.updateSidebarStats === 'function') window.updateSidebarStats();
    } catch (error) {
        console.error("Error toggling save:", error);
        showSaveToast("Error saving property", true);
    }
}

function showSaveToast(message, isError = false) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${isError ? '#ef4444' : '#10b981'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 9999;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Force all type badges to be visible
function forceBadgeVisibility() {
    document.querySelectorAll('.listing-type-badge').forEach(badge => {
        badge.style.opacity = '1';
        badge.style.visibility = 'visible';
        badge.style.display = 'block';
    });
    
    document.querySelectorAll('.listing-ai-badge, .listing-match-badge').forEach(badge => {
        badge.style.opacity = '1';
        badge.style.visibility = 'visible';
        badge.style.display = 'block';
    });
}

// --- EVENT LISTENER SETUP ---

function setupEventListeners() {
    // Search and filter buttons
    const applyFiltersBtn = document.getElementById('applyFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', applyFilters);
    }
    
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', resetFilters);
    }
    
    // Refresh recommendations button
    const refreshRecoBtn = document.getElementById('refreshRecommendationsBtn');
    if (refreshRecoBtn) {
        refreshRecoBtn.addEventListener('click', async function() {
            try {
                // Show loading state
                const recoContainer = document.getElementById('recommendedListingsContainer');
                if (recoContainer) {
                    recoContainer.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                            <div class="spinner" style="border: 4px solid var(--bg-light); 
                                border-top: 4px solid var(--primary); border-radius: 50%; 
                                width: 40px; height: 40px; animation: spin 1s linear infinite; 
                                margin: 0 auto 20px;"></div>
                            <p style="color: var(--text-light);">Refreshing AI recommendations...</p>
                        </div>
                    `;
                }
                
                if (auth.currentUser) {
                    await loadRecommendationsFromPython();
                } else {
                    showGuestRecommendations();
                }
            } catch (error) {
                console.log("Could not refresh recommendations:", error);
            }
        });
    }
    
    // Initialize messaging listeners
    initializeMessagingListeners();
}

function setupListingEventListeners() {
    // Contact buttons - prevent card click when clicking contact button
    document.querySelectorAll('#listingsContainer .action-btn.contact-btn').forEach(btn => {
        if (btn.getAttribute('data-user-id')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                const userId = this.getAttribute('data-user-id');
                if (userId) {
                    window.contactBroker(userId);
                }
            });
        }
    });
}

// --- RECOMMENDATIONS FUNCTIONS (USING PYTHON BACKEND) ---

async function loadRecommendationsFromPython() {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.log('User not authenticated, showing guest recommendations');
            showGuestRecommendations();
            return;
        }

        const userId = currentUser.uid;
        console.log('Loading recommendations from Python API for user:', userId);

        // Show loading state
        const recoContainer = document.getElementById('recommendedListingsContainer');
        if (recoContainer) {
            recoContainer.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                    <div class="spinner" style="border: 4px solid var(--bg-light); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p style="color: var(--text-light);">Finding properties you'll love...</p>
                </div>
            `;
        }

        // Call Python backend API
        let data;
        
        try {
            const response = await fetch(`${PYTHON_API_URL}?user_id=${userId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                mode: 'cors'
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const apiResponseText = await response.text();
            console.log('üì¶ Raw API response (first 500 chars):', apiResponseText.substring(0, 500));

            // Clean the response by removing undefined
            let cleanedResponse = apiResponseText.replace(/undefined/g, 'null');

            // Try to parse JSON
            try {
                data = JSON.parse(cleanedResponse);
            } catch (parseError) {
                console.error('‚ùå JSON parse error:', parseError);
                // Create fallback data
                data = {
                    success: true,
                    has_history: false,
                    saved_count: 0,
                    recommendation_type: 'recent',
                    message: 'Showing recent properties',
                    recommendations: []
                };
            }
        } catch (fetchError) {
            console.error('üåê Fetch error:', fetchError);
            data = {
                success: false,
                has_history: false,
                saved_count: 0,
                recommendation_type: 'recent',
                message: 'Showing recent properties',
                recommendations: []
            };
        }

        // Update the subtitle based on response
        const subtitle = document.getElementById('recommendationsSubtitle');
        if (subtitle) {
            if (data.message) {
                subtitle.textContent = data.message;
            } else {
                subtitle.textContent = 'Based on your saved properties and search history';
            }
        }

        // Check if we have AI recommendations
        if (data.recommendation_type === 'ai' && data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
            console.log(`üéØ Received ${data.recommendations.length} AI recommendations`);
            
            // Map recommendations to actual listings
            const recommendedListings = data.recommendations
                .map(rec => {
                    // Find the matching listing - check both id and property_id
                    const listing = allListings.find(l => l.id === rec.id || l.id === rec.property_id);
                    if (listing) {
                        return {
                            ...listing,
                            recoScore: rec.match_score || rec.similarity_score || 0,
                            similarity_score: rec.similarity_score || rec.match_score || 0,
                            similar_to: rec.match_reason || "Similar to your preferences"
                        };
                    }
                    console.warn('Could not find listing for recommendation:', rec.id || rec.property_id);
                    return null;
                })
                .filter(l => l !== null)
                .slice(0, 5);

            if (recommendedListings.length > 0) {
                console.log(`‚úÖ Mapped ${recommendedListings.length} recommendations to listings`);
                displayRecommendedListingsPython(recommendedListings, 'personalized');
                return;
            }
        }
        
        // Fallback to recent properties
        console.log('üì¶ No AI recommendations, showing recent properties');
        showGuestRecommendations();

    } catch (error) {
        console.error('üí• Error in recommendation system:', error);
        showGuestRecommendations('Error loading recommendations');
    }
}

// Show properties to guest users
async function showGuestRecommendations() {
    try {
        console.log('Showing properties to guest user');
        
        // Update section title for guests
        const sectionTitle = document.querySelector('#recommendedSection .section-title');
        const sectionSubtitle = document.querySelector('#recommendationsSubtitle');
        
        if (sectionTitle) {
            sectionTitle.innerHTML = '<i class="fas fa-eye"></i> Featured Properties';
        }
        if (sectionSubtitle) {
            sectionSubtitle.textContent = 'Browse these featured properties. Sign in to get personalized AI recommendations!';
        }
        
        // Get recent active properties
        const activeListings = allListings.filter(listing => 
            listing.status === 'active' ||
            listing.status === 'available' ||
            listing.status === 'Active' ||
            (listing.status === undefined && listing.isActive !== false)
        );
        
        // Sort by date if available, otherwise take first 5
        const recentListings = activeListings
            .sort((a, b) => {
                const dateA = a.createdAt || a.uploadedAt || 0;
                const dateB = b.createdAt || b.uploadedAt || 0;
                return dateB - dateA; // Newest first
            })
            .slice(0, 5);
        
        if (recentListings.length > 0) {
            displayRecommendedListingsPython(recentListings, 'guest');
            
            // Add a prompt message below the section
            setTimeout(() => {
                const section = document.getElementById('recommendedSection');
                if (section) {
                    let promptDiv = section.querySelector('.guest-prompt');
                    if (!promptDiv) {
                        promptDiv = document.createElement('div');
                        promptDiv.className = 'guest-prompt';
                        promptDiv.style.cssText = `
                            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
                            color: white;
                            padding: 15px 20px;
                            border-radius: 8px;
                            margin-top: 20px;
                            text-align: center;
                            animation: fadeIn 0.5s ease;
                        `;
                        promptDiv.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; max-width: 600px;">
                                    <strong>üîì Unlock AI Recommendations!</strong>
                                    <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
                                        <a href="../login.html" style="color: white; text-decoration: underline; font-weight: 600;">Sign in</a> to save properties and get personalized AI recommendations based on your preferences.
                                    </p>
                                </div>
                            </div>
                        `;
                        section.appendChild(promptDiv);
                    }
                }
            }, 100);
        } else {
            // If no recent listings, show a message
            const recoContainer = document.getElementById('recommendedListingsContainer');
            if (recoContainer) {
                recoContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üè†</div>
                        <h3 style="color: var(--text-dark); margin-bottom: 10px;">Featured Properties Coming Soon</h3>
                        <p style="color: var(--text-light); max-width: 500px; margin: 0 auto 20px;">
                            New properties are being added regularly. Check back soon for featured listings!
                        </p>
                        <a href="../login.html" class="search-button" style="margin-top: 15px; display: inline-block;">
                            <i class="fas fa-sign-in-alt"></i> Sign In for Better Experience
                        </a>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error in guest recommendations:', error);
        const recoContainer = document.getElementById('recommendedListingsContainer');
        if (recoContainer) {
            recoContainer.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3 style="color: var(--text-dark); margin-bottom: 10px;">Explore Properties</h3>
                    <p style="color: var(--text-light); max-width: 500px; margin: 0 auto 20px;">
                        Browse through our listings below.
                    </p>
                </div>
            `;
        }
    }
}

// Function to display recommendations from Python
function displayRecommendedListingsPython(recommendations, type = 'personalized') {
    const recoContainer = document.getElementById('recommendedListingsContainer');
    const sectionTitle = document.querySelector('#recommendedSection .section-title');
    const sectionSubtitle = document.querySelector('#recommendationsSubtitle');
    
    if (!recoContainer) return;
    
    // Update section title based on recommendation type
    if (sectionTitle) {
        if (type === 'personalized') {
            sectionTitle.innerHTML = '<i class="fas fa-robot"></i> AI Recommendations For You';
            if (sectionSubtitle) {
                sectionSubtitle.textContent = 'Based on your saved properties and search history';
            }
        } else if (type === 'guest') {
            sectionTitle.innerHTML = '<i class="fas fa-eye"></i> Featured Properties';
            if (sectionSubtitle) {
                sectionSubtitle.textContent = 'Browse these featured properties. Sign in to get personalized AI recommendations!';
            }
        } else {
            sectionTitle.innerHTML = '<i class="fas fa-clock"></i> Recent Properties';
            if (sectionSubtitle) {
                sectionSubtitle.textContent = 'Browse these recently listed properties';
            }
        }
    }
    
    if (!recommendations || recommendations.length === 0) {
        recoContainer.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">üè†</div>
                <h3 style="color: var(--text-dark); margin-bottom: 10px;">Featured Properties Coming Soon</h3>
                <p style="color: var(--text-light); max-width: 500px; margin: 0 auto 20px;">
                    New properties are being added regularly. Check back soon!
                </p>
            </div>`;
        return;
    }

    // Check which properties are already saved (only for logged-in users)
    checkSavedStatus(recommendations).then(savedMap => {
        recoContainer.innerHTML = recommendations.map(property => {
            const isSaved = savedMap.has(property.id);
            const userInfo = userMap.get(property.userId) || {
                displayName: `User ${property.userId ? property.userId.substring(0, 8) : 'Unknown'}`,
                email: 'N/A',
                phone: 'N/A',
                role: 'user',
                photoURL: null
            };
            
            const userInitials = userInfo.displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'UU';
            const brokerAvatarHtml = userInfo.photoURL
              ? `<img src="${userInfo.photoURL}" alt="${(userInfo.displayName || '').replace(/"/g, '&quot;')}" onerror="var p=this.parentElement;p.innerHTML=p.getAttribute('data-fallback')||'U'">`
              : userInitials;
            const brokerAvatarWrapper = userInfo.photoURL
              ? `<div class="broker-avatar" data-fallback="${(userInitials || 'U').replace(/"/g, '&quot;')}" aria-label="Broker avatar">${brokerAvatarHtml}</div>`
              : `<div class="broker-avatar" aria-label="Broker avatar">${userInitials}</div>`;
            const listingType = getListingType(property);
            const displayPrice = getDisplayPrice(property);
            const priceClass = getPriceClass(property);
            const typeBadgeClass = getTypeBadgeClass(property);
            const typeBadgeText = getTypeBadgeText(property);
            
            const photo = property.photos?.[0] || property.imageUrls?.[0] || `https://via.placeholder.com/400x200/0b2e52/white?text=${encodeURIComponent(property.title || 'Property')}`;
            const matchScore = property.recoScore ? Math.round(property.recoScore) : null;
            
            const bedrooms = property.bedrooms || (listingType === 'rent' && property.propertyType === 'studio' ? 'Studio' : 0);
            const bathrooms = property.bathrooms || 0;
            const area = property.floorArea || property.totalArea || 'N/A';
            
            // Truncate long titles with ellipsis
            const title = property.title || 'Untitled Property';
            const truncatedTitle = title.length > 50 ? title.substring(0, 50) + '...' : title;
            
            // Truncate address with ellipsis
            const address = getCompleteAddress(property);
            const truncatedAddress = address.length > 40 ? address.substring(0, 40) + '...' : address;
            
            // Truncate broker name with ellipsis
            const brokerName = userInfo.displayName;
            const truncatedBrokerName = brokerName.length > 20 ? brokerName.substring(0, 20) + '...' : brokerName;
            
            // Add type badge to property card
            const typeBadge = `<div class="listing-type-badge ${typeBadgeClass}">${typeBadgeText}</div>`;
            
            // Optional recommendation label
            let recommendationBadge = "";
            if (type === 'personalized') {
                recommendationBadge = '<div class="listing-ai-badge">‚ú® AI Pick</div>';
            } else if (type === 'guest') {
                recommendationBadge = '<div class="listing-match-badge">FEATURED</div>';
            }
            
            // Determine contact button based on auth state
            const contactButton = auth.currentUser 
                ? `<button class="action-btn contact-btn" style="width: 100%;" data-user-id="${property.userId}">
                      <i class="fas fa-comment"></i> Contact Broker
                   </button>`
                : `<button class="action-btn contact-btn" style="width: 100%;" onclick="window.location.href='../login.html'">
                      <i class="fas fa-sign-in-alt"></i> Login to Contact
                   </button>`;
            
            const listingTypeLabel = listingType === 'rent' ? 'For Rent' : listingType === 'lease' ? 'For Lease' : 'For Sale';
            let recStatusText = property.status || 'available';
            let recStatusClass = 'status-active';
            let showRecStatus = true;
            if (recStatusText.toLowerCase() === 'active' || recStatusText.toLowerCase() === 'available' || recStatusText.toLowerCase() === 'published') {
                recStatusText = '';
                recStatusClass = '';
                showRecStatus = false;
            } else if (recStatusText.toLowerCase() === 'pending') {
                recStatusClass = 'status-pending';
            }
            
            return `
                <div class="listing-card-wrapper">
                    <div class="listing-card" data-listing-id="${property.id}">
                        <a href="property_details.html?id=${property.id}" class="card-link-overlay" aria-label="View ${title}"></a>
                        <div class="listing-card-image-container" style="position: relative;">
                            <img src="${photo}" alt="${property.title || 'Property'}" class="listing-image">
                            ${typeBadge}
                            ${matchScore && matchScore > 50 ? `<div class="listing-match-badge">${matchScore}% Match</div>` : ''}
                            ${recommendationBadge}
                        </div>
                        <div class="listing-content">
                            <div class="listing-header">
                                <div style="flex: 1; min-width: 0;">
                                    <h3 class="listing-title" title="${title}">${truncatedTitle}</h3>
                                </div>
                                <div class="listing-price ${priceClass}">${displayPrice}</div>
                            </div>
                            <div class="listing-location">
                                <i class="fas fa-map-marker-alt" style="flex-shrink: 0;"></i>
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${address}">${truncatedAddress}</span>
                                <span> ¬∑ ${listingTypeLabel}</span>
                            </div>
                            <div class="listing-details">
                                ${bedrooms ? `<div class="detail"><i class="fas fa-bed"></i> ${bedrooms} ${bedrooms === 'Studio' ? '' : 'beds'}</div>` : ''}
                                ${bathrooms ? `<div class="detail"><i class="fas fa-bath"></i> ${bathrooms} baths</div>` : ''}
                                ${area && area !== 'N/A' ? `<div class="detail"><i class="fas fa-ruler-combined"></i> ${area} sqm</div>` : ''}
                            </div>
                            
                            <!-- AI Insight Section - Only for personalized recommendations -->
                            ${property.similar_to && type === 'personalized' ? `
                                <div class="ai-reason" style="margin: 12px 0; padding: 10px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border-radius: 8px; border-left: 3px solid #667eea;">
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <span style="font-size: 14px; color: #667eea;">üí°</span>
                                        <div style="flex: 1;">
                                            <div style="font-size: 12px; font-weight: 600; color: #667eea; margin-bottom: 2px;">AI Insight</div>
                                            <div style="font-size: 13px; color: var(--text-light);">${property.similar_to}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="listing-broker">
                                ${brokerAvatarWrapper}
                                <div class="broker-info">
                                    <div class="broker-name" title="${brokerName}">${truncatedBrokerName}</div>
                                    <div class="broker-contact">
                                        ${getRoleDisplayText(userInfo.role)} ¬∑ ${property.propertyType || 'Property'}
                                    </div>
                                </div>
                            </div>
                            ${showRecStatus ? `<div class="listing-status ${recStatusClass}">${recStatusText}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Setup event listeners for contact buttons in recommendations
        setTimeout(() => {
            setupRecommendationsEventListeners();
        }, 100);
        
        // Force badges to be visible
        setTimeout(forceBadgeVisibility, 100);
    });
}

function setupRecommendationsEventListeners() {
    // Contact buttons in recommendations
    const recoContainer = document.getElementById('recommendedListingsContainer');
    if (recoContainer) {
        recoContainer.querySelectorAll('.action-btn.contact-btn[data-user-id]').forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                const userId = this.getAttribute('data-user-id');
                if (userId) {
                    window.contactBroker(userId);
                }
            });
        });
    }
}

// --- INITIALIZATION ---

// Initialize dropdowns
function initializeDropdowns() {
    const transactionTypeSelect = document.getElementById('filterListingType');
    const categorySelect = document.getElementById('filterPropertyCategory');

    if (transactionTypeSelect) {
        transactionTypeSelect.addEventListener('change', updateCategoryDropdown);
    }
    
    if (categorySelect) {
        categorySelect.addEventListener('change', updateTypeDropdown);
    }

    // Initialize with current values
    if (transactionTypeSelect && categorySelect) {
        updateCategoryDropdown();
    }
}

// Add demo prompts to the chat interface
function addDemoPrompts() {
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    
    if (!chatInput || !chatMessages) return;
    
    // Add demo prompts section if it doesn't exist
    if (!document.querySelector('.demo-prompts')) {
        const demoSection = document.createElement('div');
        demoSection.className = 'demo-prompts';
        demoSection.style.cssText = `
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            animation: fadeIn 0.5s ease;
        `;
        
        demoSection.innerHTML = `
            <div style="font-size: 14px; color: var(--text-dark); font-weight: 600; margin-bottom: 10px;">
                <i class="fas fa-lightbulb"></i> Try these quick prompts:
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <button class="demo-prompt-btn" data-prompt="Find apartments in Batangas City">
                    üè¢ Find apartments
                </button>
                <button class="demo-prompt-btn" data-prompt="Find houses in Lipa City">
                    üè† Find houses
                </button>
                <button class="demo-prompt-btn" data-prompt="Tell me about Batangas City">
                    ‚ÑπÔ∏è About Batangas
                </button>
                <button class="demo-prompt-btn" data-prompt="Properties that accept bank financing">
                    üí∞ Bank financing
                </button>
                <button class="demo-prompt-btn" data-prompt="Find condos in Tanauan City">
                    üèôÔ∏è Find condos
                </button>
            </div>
        `;
        
        chatMessages.parentNode.insertBefore(demoSection, chatMessages.nextSibling);
        
        // Add event listeners to demo prompt buttons
        setTimeout(() => {
            document.querySelectorAll('.demo-prompt-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const prompt = this.getAttribute('data-prompt');
                    chatInput.value = prompt;
                    chatInput.focus();
                    
                    // Highlight the button briefly
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });
        }, 100);
    }
}

// Function to show chatbot error state
function showChatbotError() {
    const chatbotSection = document.querySelector('.ai-chatbot-section');
    if (chatbotSection) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chatbot-error';
        errorDiv.style.cssText = `
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #c00;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>AI Assistant Temporarily Unavailable</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">
                    The AI chatbot is still being trained. Please use the search filters above to find properties.
                </p>
            </div>
        `;
        
        chatbotSection.appendChild(errorDiv);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    initializeDropdowns();
    
    // MODIFIED: Check authentication - ALLOW GUESTS
    onAuthStateChanged(auth, async (user) => {
        // Update UI based on auth state
        if (user) {
            // Logged-in user
            console.log('üë§ Logged in user UID:', user.uid);
            guestMessage.style.display = 'none';
            
            try {
                // Load user data for welcome message
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    const fullName = userData.fullName || userData.displayName || userData.name ||
                        ((userData.firstName || '') + ' ' + (userData.lastName || '')).trim() || userData.email?.split('@')[0] || 'User';
                    welcomeText.textContent = `Welcome back, ${fullName}!`;
                    // Store and update sidebar so it shows logged-in user
                    const profileData = {
                        fullName,
                        email: userData.email,
                        role: userData.role || userData.userType || 'user',
                        firstName: userData.firstName,
                        lastName: userData.lastName,
                        photoURL: userData.photoURL || userData.profilePhotoURL
                    };
                    try { localStorage.setItem('userData', JSON.stringify(profileData)); } catch (e) {}
                    if (typeof window.updateSidebarUserProfile === 'function') {
                        window.updateSidebarUserProfile(profileData);
                    }
                } else {
                    welcomeText.textContent = "Welcome to BahAI Real Estate!";
                }
            } catch (error) {
                console.error("Error loading user:", error);
                welcomeText.textContent = "Welcome to BahAI Real Estate!";
            }
            
            // Load AI recommendations for logged-in users
            setTimeout(() => {
                loadRecommendationsFromPython().catch(error => {
                    console.log("Python recommendations failed to load:", error);
                    showGuestRecommendations();
                });
            }, 1000);
        } else {
            // Guest user
            console.log('üë§ Guest user (not logged in)');
            welcomeText.textContent = "Welcome to BahAI Real Estate!";
            guestMessage.style.display = 'block';
            
            // Show guest recommendations
            setTimeout(() => {
                showGuestRecommendations();
            }, 1000);
        }

        // Load listings and categories (available to everyone)
        loadAllListings();
        
        // Setup event listeners
        setupEventListeners();
        
        // Initialize AI chatbot with delay to ensure DOM is fully loaded
        setTimeout(() => {
            if (typeof initChatbot === 'function') {
                console.log('ü§ñ Initializing AI chatbot...');
                initChatbot();
                
                // Add sample demo prompts for easy testing
                addDemoPrompts();
            } else {
                console.warn('‚ö†Ô∏è initChatbot function not found. Make sure ai_chatbot.js is loaded.');
                
                // Try to load it dynamically
                const script = document.createElement('script');
                script.src = 'ai_chatbot.js';
                script.type = 'module';
                script.onload = () => {
                    console.log('‚úÖ AI chatbot script loaded dynamically');
                    if (typeof initChatbot === 'function') {
                        initChatbot();
                        addDemoPrompts();
                    }
                };
                script.onerror = () => {
                    console.error('‚ùå Failed to load AI chatbot script');
                    showChatbotError();
                };
                document.body.appendChild(script);
            }
        }, 1500);
    });
});

// ================================ WINDOW FUNCTIONS (for backward compatibility) =============================

window.applyFilters = applyFilters;
window.resetFilters = resetFilters;
window.toggleSaveProperty = toggleSaveProperty;
window.contactBroker = contactBroker;
window.loadAllListings = loadAllListings;
window.filterByCategory = filterByCategory;
window.loadRecommendationsFromPython = loadRecommendationsFromPython;
window.showGuestRecommendations = showGuestRecommendations;

</script>

</body>
</html>